<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='80'%3E%F0%9F%92%B2%3C/text%3E%3C/svg%3E" />
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style> * { margin: 0; padding: 0; box-sizing: border-box; }body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Arial, sans-serif; background: #f2f2f7; padding: 16px; color: #1c1c1e; }.container { max-width: 100%; margin: 0 –∞–≤—Ç–æ; background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); }h1 { font-size: 28px; font-weight: 600; margin-bottom: 20px; color: #1c1c1e; letter-spacing: -0.5px; }.upload-section { display: grid; grid-template-columns: 1.5fr 1.5fr 1fr; gap: 12px; margin-bottom: 12px; }.upload-card { background: #f9f9fb; border-radius: 12px; padding: 12px; border: 2px dashed #c7c7cc; transition: all 0.2s; }.upload-card:hover { border-color: #007aff; }.upload-card.my-price { border-color: #34c759; background: #f0fdf4; }.upload-card.my-price:hover { border-color: #28a745; }.upload-label { display: block; font-size: 12px; font-weight: 600; color: #8e8e93; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }.upload-card.my-price .upload-label { color: #34c759; }.file-input-wrapper { position: relative; }.file-input-wrapper input[type="file"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }.file-input-display { display: flex; align-items: center; gap: 6px; padding: 8px 10px; background: white; border-radius: 8px; font-size: 13px; color: #007aff; font-weight: 500; cursor: pointer; transition: all 0.2s; }.file-input-display:hover { background: #e8f4ff; }.upload-card.my-price .file-input-display { color: #34c759; }.upload-card.my-price .file-input-display:hover { background: #e6f9ec; }.upload-card.synonyms { border-color: #ffcc00; background: #fff9e6; }.upload-card.synonyms .upload-label { color: #ff9500; }.search-box { margin-bottom: 12px; }.search-input { width: 100%; padding: 10px 12px; border: 2px solid #e5e5ea; border-radius: 10px; font-size: 14px; font-family: inherit; transition: all 0.2s; }.search-input:focus { outline: none; border-color: #007aff; background: #f0f7ff; }.controls { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }.btn { padding: 6px 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.2s; display: flex; align-items: center; gap: 4px; line-height: 1; white-space: nowrap; }.btn span.icon { font-size: 14px; }.btn-primary { background: #007aff; color: white; }.btn-primary:hover { background: #0051d5; transform: translateY(-1px); box-shadow: 0 3px 8px rgba(0, 122, 255, 0.25); }.btn-success { background: #34c759; color: white; }.btn-success:hover { background: #28a745; transform: translateY(-1px); box-shadow: 0 3px 8px rgba(52, 199, 89, 0.25); }.btn-warning { background: #ff9500; color: white; }.btn-warning:hover { background: #e08600; transform: translateY(-1px); box-shadow: 0 3px 8px rgba(255, 149, 0, 0.25); }.btn-danger { background: #ff3b30; color: white; }.btn-danger:hover { background: #d70015; }.btn-secondary { background: #f9f9fb; color: #007aff; border: 1px solid #e5e5ea; }.btn-secondary:hover { background: #e8f4ff; }.btn-secondary.active { background: #007aff; color: white; }.btn:disabled { background: #e5e5ea; color: #aeaeb2; cursor: not-allowed; transform: none; }.cart-badge { background: #ff3b30; color: white; border-radius: 10px; padding: 1px 6px; font-size: 11px; font-weight: 700; min-width: 18px; text-align: center; }.info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-bottom: 12px; }.info-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 10px; color: white; }.info-card:nth-child(2) { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }.info-card:nth-child(3) { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }.info-card:nth-child(4) { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }.info-value { font-size: 22px; font-weight: 700; margin-bottom: 2px; letter-spacing: -0.5px; }.info-label { font-size: 11px; opacity: 0.9; font-weight: 500; }.hidden-columns { background: #fff3cd; border: 1px solid #ffc107; border-radius: 12px; padding: 8px 10px; margin-bottom: 10px; display: none; align-items: center; gap: 8px; flex-wrap: wrap; }.hidden-columns-label { font-size: 12px; font-weight: 600; color: #856404; }.restore-column-btn { padding: 4px 8px; background: white; border: 1px solid #ffc107; border-radius: 6px; font-size: 11px; font-weight: 600; color: #856404; cursor: pointer; transition: all 0.2s; }.restore-column-btn:hover { background: #ffc107; color: white; }.table-wrapper { overflow-x: auto; border-radius: 12px; border: 1px solid #e5e5ea; max-height: 70vh; }table { width: 100%; border-collapse: collapse; min-width: 700px; }th { background: #f9f9fb; padding: 6px 8px; text-align: left; font-weight: 600; font-size: 11px; color: #8e8e93; border-bottom: 1px solid #e5e5ea; position: sticky; top: 0; z-index: 10; text-transform: uppercase; letter-spacing: 0.5px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }th.col-barcode { min-width: 140px; max-width: 140px; cursor: pointer; user-select: none; }th.col-barcode:hover { background: #e8f4ff; }th.col-name { min-width: 320px; max-width: 320px; }th.col-actions { min-width: 70px; max-width: 70px; }.column-header { display: flex; flex-direction: column; gap: 3px; }.column-header-checkbox { display: flex; align-items: center; gap: 3px; font-size: 9px; }.column-header-checkbox input[type="checkbox"] { width: 13px; height: 13px; cursor: pointer; }.column-header-title { display: flex; align-items: center; justify-content: space-between; gap: 4px; white-space: nowrap; overflow: hidden; }.column-name-text { overflow: hidden; text-overflow: ellipsis; }.edit-col-btn { background: none; border: none; cursor: pointer; color: #007aff; font-size: 14px; padding: 0 4px; opacity: 0.5; transition: all 0.2s; flex-shrink: 0; line-height: 1; }.edit-col-btn:hover { opacity: 1; background: #e8f4ff; border-radius: 4px; transform: scale(1.1); }td { padding: 4px 8px; border-bottom: 1px solid #f2f2f7; font-size: 13px; color: #1c1c1e; max-width: 150px; vertical-align: top; }td.col-barcode { min-width: 140px; max-width: 140px; }td.col-name { min-width: 320px; max-width: 320px; line-height: 1.3; padding: 0; }.name-cell { width: 100%; }.name-item { padding: 4px 8px; border-bottom: 1px solid #e5e5ea; }.name-item:last-child { border-bottom: none; }.name-compact { padding: 4px 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }td.col-actions { min-width: 70px; max-width: 70px; }tr { border-top: 1px solid #e5e5ea; }tr.group-border-top { border-top: 2px solid #c7c7cc; }tr.group-border-bottom { border-bottom: 2px solid #c7c7cc; }tr:hover { background: #f9f9fb; }tr.my-price-row { background: #f0fdf4; }tr.my-price-row:hover { background: #e6f9ec; }tr.in-cart { background: #d4f4dd; }tr.in-cart:hover { background: #c0eeca; }tr.duplicate-row { background: #ffe6f0 !important; }tr.duplicate-row:hover { background: #ffd6e7 !important; }tr.duplicate-row.in-cart { background: #ffc6d8 !important; }tr.duplicate-row.in-cart:hover { background: #ffb6c8 !important; }/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ —Å–∏–Ω–æ–Ω–∏–º–∞–º */ tr.synonym-row { background: #e6f7ff !important; }tr.synonym-row:hover { background: #d1efff !important; }tr.synonym-row.in-cart { background: #b8e6ff !important; }tr.synonym-row.in-cart:hover { background: #a3dcff !important; }.multi-value-container { display: flex; flex-direction: column; gap: 4px; }.value-variant { display: flex; flex-direction: column; border-bottom: 1px dashed #e5e5ea; padding-bottom: 2px; position: relative; padding-right: 15px; }.div-wrapper { position: absolute; top: 0; right: 0; width: 14px; height: 14px; overflow: hidden; }.div-icon { color: #ff3b30; font-size: 14px; line-height: 1; font-weight: bold; text-align: center; pointer-events: none; }.div-select { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; font-size: 16px; }.value-variant:last-child { border-bottom: none; padding-bottom: 0; }.price-val.is-min { color: #28a745; font-weight: 700; }/* –¶–µ–Ω–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ */ .price-clickable { cursor: pointer; transition: all 0.15s; }.price-clickable:hover { background: #fff3cd; padding: 2px 4px; margin: -2px -4px; border-radius: 4px; }.cart-btn { background: transparent; color: #34c759; border: none; padding: 2px; border-radius: 6px; cursor: pointer; font-size: 18px; transition: all 0.2s; }.cart-btn:hover { background: #e6f9ec; transform: scale(1.05); }.cart-btn.in-cart { color: #34c759; }.barcode-cell { display: flex; align-items: center; gap: 4px; }.barcode-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }.copy-btn { border: none; background: #f2f2f7; border-radius: 4px; padding: 2px 4px; font-size: 11px; cursor: pointer; color: #555; flex-shrink: 0; }.copy-btn:hover { background: #e0e0e4; }/* –°–∫—Ä—ã—Ç—ã–µ –∫–æ–ª–æ–Ω–∫–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ –≤ UI */ .hidden-barcode-col { display: none; }.empty-state { text-align: center; padding: 40px 20px; color: #8e8e93; }.empty-state-icon { font-size: 48px; margin-bottom: 12px; }.empty-state h3 { font-size: 18px; font-weight: 600; margin-bottom: 6px; color: #1c1c1e; }.empty-state p { font-size: 13px; }@media (max-width: 900px) { .upload-section { grid-template-columns: 1fr; } }@media (max-width: 768px) { .info-grid { grid-template-columns: repeat(2, 1fr); } } 
.auto-div-badge {
  display: inline-block;
  margin-left: 4px;
  color: #ffcc00;
  font-weight: 900;
  font-size: 13px;
  line-height: 1;
  text-shadow: 0 1px 0 rgba(0,0,0,0.15);
}
</style>
</head>
<body>
<!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
<style>
.app-navigation {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
}

.nav-container {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    gap: 0;
}

.nav-tab {
    flex: 1;
    padding: 15px 20px;
    text-align: center;
    text-decoration: none;
    color: rgba(255,255,255,0.8);
    font-weight: 500;
    font-size: 16px;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
    background: transparent;
}

.nav-tab:hover {
    background: rgba(255,255,255,0.1);
    color: white;
}

.nav-tab.active {
    color: white;
    border-bottom-color: white;
    background: rgba(255,255,255,0.15);
}

@media (max-width: 768px) {
    .nav-tab {
        padding: 12px 10px;
        font-size: 14px;
    }
}
</style>

<nav class="app-navigation">
    <div class="nav-container">
        <a href="https://erofly83-arch.github.io/pricematcher/" class="nav-tab" id="nav-matcher">üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω</a>
        <a href="https://erofly83-arch.github.io/obrezatel/" class="nav-tab" id="nav-cutter">üìã –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü</a>
        <a href="https://erofly83-arch.github.io/synonyms/" class="nav-tab" id="nav-sinonims">üîó –°–∏–Ω–æ–Ω–∏–º—ã</a>
    </div>
</nav>

<script>
// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
(function() {
    const currentPage = 'matcher';
    const activeTab = document.getElementById('nav-' + currentPage);
    if (activeTab) {
        activeTab.classList.add('active');
    }
})();
</script>

<div class="container">
    <h1>üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω</h1>

    <div class="upload-section">
        <div class="upload-card my-price">
            <label class="upload-label">üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å</label>
            <div class="file-input-wrapper">
                <input type="file" id="myPriceInput" accept=".csv,.xlsx,.xls"/>
                <div class="file-input-display" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∞—à –ø—Ä–∞–π—Å-—Ñ–∞–π–ª">
                    <span>üìÑ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</span>
                </div>
            </div>
        </div>

        <div class="upload-card">
            <label class="upload-label">üì¶ –ü—Ä–∞–π—Å—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</label>
            <div class="file-input-wrapper">
                <input type="file" id="competitorInput" multiple accept=".csv,.xlsx,.xls"/>
                <div class="file-input-display" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤">
                    <span>üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</span>
                </div>
            </div>
        </div>

        <div class="upload-card synonyms">
            <label class="upload-label">üîó –°–∏–Ω–æ–Ω–∏–º—ã —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ (JSON)</label>
            <div class="file-input-wrapper">
                <input type="file" id="synonymsInput" accept=".json"/>
                <div class="file-input-display" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª synonyms.json —Å –≥—Ä—É–ø–ø–∞–º–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤">
                    <span>üß© –í—ã–±—Ä–∞—Ç—å synonyms.json</span>
                </div>
            </div>
            <div id="synonymsStatus" style="margin-top:6px;font-size:11px;color:#8e8e93;">
                –§–∞–π–ª —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
            </div>
        </div>
    </div>

    <div class="search-box">
        <input type="text" id="searchInput" class="search-input"
               placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–æ–≤–∞—Ä–∞..."
               title="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ —á–∞—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤">
    </div>

    <div class="controls">
        <button id="sortMatchesBtn" class="btn btn-secondary" disabled
                title="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞ —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–∞—Ö">
            <span class="icon">üîÑ</span> –°–æ–≤–ø–∞–¥–µ–Ω–∏—è
        </button>
        <button id="bigDiffBtn" class="btn btn-secondary" disabled
                title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã —Å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è–º–∏, –≥–¥–µ —Ä–∞–∑–Ω–∏—Ü–∞ —Ü–µ–Ω –±–æ–ª—å—à–µ 10%">
            <span class="icon">üìä</span> –ë–æ–ª—å—à–∞—è —Ä–∞–∑–Ω–∏—Ü–∞
        </button>
        <button id="showMyPriceBtn" class="btn btn-secondary" disabled
                title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–∞–π—Å–∞">
            <span class="icon">‚≠ê</span> –ú–æ–π –ø—Ä–∞–π—Å
        </button>
        <button id="showCartBtn" class="btn btn-secondary" disabled
                title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –≤ –∫–æ—Ä–∑–∏–Ω—É">
            <span class="icon">üõíüëÅÔ∏è</span> –ö–æ—Ä–∑–∏–Ω–∞
        </button>
        <button id="compactMatchesBtn" class="btn btn-secondary" disabled
                title="–£–º–µ–Ω—å—à–∏—Ç—å –≤—ã—Å–æ—Ç—É —Å—Ç—Ä–æ–∫ —Å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è–º–∏, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É">
            <span class="icon">üìè</span> –ö–æ–º–ø–∞–∫—Ç–Ω–æ
        </button>
        <button id="maxCoverageBtn" class="btn btn-secondary" disabled
                title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Ü–µ–Ω–∞ –Ω–∞ —Ç–æ–≤–∞—Ä">
            <span class="icon">üìä</span> –ú–∞–∫—Å.—Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
        </button>
        <button id="toggleFileBarcodesBtn" class="btn btn-secondary" disabled
                title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–æ–ª–æ–Ω–∫–∏ —Å–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞–º–∏ –ø–æ —Ñ–∞–π–ª–∞–º">
            <span class="icon">üîé</span> –®–ö –ø–æ —Ñ–∞–π–ª–∞–º
        </button>
        <button id="exportMyPriceBtn" class="btn btn-success" disabled
                title="–°–∫–∞—á–∞—Ç—å Excel —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–∞–π—Å–∞ –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏">
            <span class="icon">‚≠êüíæ</span> –ú–æ–π –ø—Ä–∞–π—Å
        </button>
        <button id="exportAllBtn" class="btn btn-success" disabled
                title="–°–∫–∞—á–∞—Ç—å Excel —Å–æ –≤—Å–µ–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏ –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏">
            <span class="icon">üíæ</span> –í—Å—ë
        </button>
        <button id="exportCartBtn" class="btn btn-warning" disabled
                title="–°–∫–∞—á–∞—Ç—å Excel —Ç–æ–ª—å–∫–æ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã">
            <span class="icon">üõíüíæ</span> –ö–æ—Ä–∑–∏–Ω–∞
            <span id="cartBadge" class="cart-badge" style="display:none;">0</span>
        </button>
        <button id="clearCartBtn" class="btn btn-danger" disabled
                title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã">
            <span class="icon">üõíüóëÔ∏è</span> –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
        </button>
        <button id="clearBtn" class="btn btn-danger" disabled
                title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ">
            <span class="icon">üóëÔ∏è</span> –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë
        </button>
    </div>

    <div id="infoPanel" class="info-grid" style="display:none;">
        <div class="info-card">
            <div class="info-value" id="productCount">0</div>
            <div class="info-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</div>
        </div>
        <div class="info-card">
            <div class="info-value" id="fileCount">0</div>
            <div class="info-label">–§–∞–π–ª–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</div>
        </div>
        <div class="info-card">
            <div class="info-value" id="columnCount">0</div>
            <div class="info-label">–ö–æ–ª–æ–Ω–æ–∫ –¥–∞–Ω–Ω—ã—Ö</div>
        </div>
        <div class="info-card">
            <div class="info-value" id="matchCount">0</div>
            <div class="info-label">–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</div>
        </div>
    </div>

    <div id="hiddenColumnsPanel" class="hidden-columns">
        <span class="hidden-columns-label">üîç –°–∫—Ä—ã—Ç—ã–µ –∫–æ–ª–æ–Ω–∫–∏:</span>
        <div id="hiddenColumnsList"></div>
    </div>

    <div id="tableContainer">
        <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç—ã</h3>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à –ø—Ä–∞–π—Å –∏ —Ñ–∞–π–ª—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</p>
        </div>
    </div>
</div>

<script>
    // ======== –°–õ–û–í–ê–†–¨ –°–ò–ù–û–ù–ò–ú–û–í –®–¢–†–ò–•–ö–û–î–û–í (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ JSON) ========

    let barcodeAliasMap = new Map();
    let synonymsLoaded = false;

    function resetBarcodeAliases() {
        barcodeAliasMap = new Map();
        synonymsLoaded = false;
        const status = document.getElementById('synonymsStatus');
        if (status) {
            status.style.color = '#8e8e93';
            status.textContent = '–§–∞–π–ª —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω';
        }
    }

    function loadBarcodeAliasesFromFile(file) {
        const status = document.getElementById('synonymsStatus');
        if (!file) {
            resetBarcodeAliases();
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const json = JSON.parse(text);
                const map = new Map();
                Object.keys(json).forEach(main => {
                    const mainNorm = String(main).trim();
                    if (!mainNorm) return;
                    map.set(mainNorm, mainNorm);
                    const list = json[main];
                    if (Array.isArray(list)) {
                        list.forEach(b => {
                            const v = String(b).trim();
                            if (v) map.set(v, mainNorm);
                        });
                    }
                });
                barcodeAliasMap = map;
                synonymsLoaded = true;
                if (status) {
                    status.style.color = '#34c759';
                    status.textContent = '–§–∞–π–ª —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω, –≥—Ä—É–ø–ø: ' + Object.keys(json).length;
                }
                if (allFilesData.length > 0) {
                    processData();
                    renderTable();
                    updateUI();
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è synonyms.json:', err);
                resetBarcodeAliases();
                if (status) {
                    status.style.color = '#ff3b30';
                    status.textContent = '–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON';
                }
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ —Å–∏–Ω–æ–Ω–∏–º–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç JSON.');
            }
        };
        reader.onerror = () => {
            resetBarcodeAliases();
            if (status) {
                status.style.color = '#ff3b30';
                status.textContent = '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞';
            }
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª —Å–∏–Ω–æ–Ω–∏–º–æ–≤.');
        };
        reader.readAsText(file, 'utf-8');
    }

    function canonicalizeBarcode(rawBarcode) {
        if (rawBarcode === undefined || rawBarcode === null) return { canonical: rawBarcode, wasSynonym: false };
        const b = String(rawBarcode).trim();
        if (!synonymsLoaded) return { canonical: b, wasSynonym: false };
        const canon = barcodeAliasMap.get(b);
        if (canon && canon !== b) {
            return { canonical: canon, wasSynonym: true };
        }
        return { canonical: b, wasSynonym: false };
    }

    // ======== –û–°–ù–û–í–ù–û–ô –ö–û–î –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ========

    let myPriceData = null;
    let competitorFilesData = [];
    let allFilesData = [];
    let groupedData = [];
    let allColumns = [];
    let visibleColumns = new Set();
    let cart = new Set();
    let barcodeColumn = null;
    let nameColumn = null;
    let stockColumn = null; // –∫–æ–ª–æ–Ω–∫–∞ –æ—Å—Ç–∞—Ç–∫–∞ –≤ –ú–û–Å–ú –ø—Ä–∞–π—Å–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    let sortMode = 'default';
    let compactMatches = false;
    let searchQuery = '';
    let barcodeSortOrder = 0;
    let showFileBarcodes = false; // UI: –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –ª–∏ –∫–æ–ª–æ–Ω–∫–∏ –®–ö –ø–æ —Ñ–∞–π–ª–∞–º

    const myPriceInput = document.getElementById('myPriceInput');
    const competitorInput = document.getElementById('competitorInput');
    const synonymsInput = document.getElementById('synonymsInput');
    const searchInput = document.getElementById('searchInput');
    const sortMatchesBtn = document.getElementById('sortMatchesBtn');
    const bigDiffBtn = document.getElementById('bigDiffBtn');
    const showMyPriceBtn = document.getElementById('showMyPriceBtn');
    const showCartBtn = document.getElementById('showCartBtn');
    const compactMatchesBtn = document.getElementById('compactMatchesBtn');
    const maxCoverageBtn = document.getElementById('maxCoverageBtn');
    const toggleFileBarcodesBtn = document.getElementById('toggleFileBarcodesBtn');
    const exportMyPriceBtn = document.getElementById('exportMyPriceBtn');
    const exportAllBtn = document.getElementById('exportAllBtn');
    const exportCartBtn = document.getElementById('exportCartBtn');
    const clearCartBtn = document.getElementById('clearCartBtn');
    const clearBtn = document.getElementById('clearBtn');
    const infoPanel = document.getElementById('infoPanel');
    const hiddenColumnsPanel = document.getElementById('hiddenColumnsPanel');
    const hiddenColumnsList = document.getElementById('hiddenColumnsList');
    const tableContainer = document.getElementById('tableContainer');
    const cartBadge = document.getElementById('cartBadge');

    const BARCODE_SYNONYMS = [
        '—à—Ç—Ä–∏—Ö-–∫–æ–¥', '—à—Ç—Ä–∏—Ö–∫–æ–¥', 'barcode', '–®—Ç—Ä–∏—Ö-–∫–æ–¥', '–®—Ç—Ä–∏—Ö–∫–æ–¥', 'Barcode',
        '–∫–æ–¥', '–ö–æ–¥', 'ean', 'EAN', 'ean13', 'EAN13', '—à—Ç—Ä–∏—Ö –∫–æ–¥', '–®—Ç—Ä–∏—Ö –∫–æ–¥',
        'bar_code', 'bar-code', 'product_code', 'sku', 'SKU', '–∞—Ä—Ç–∏–∫—É–ª', '–ê—Ä—Ç–∏–∫—É–ª'
    ];

    const NAME_SYNONYMS = [
        '–Ω–∞–∑–≤–∞–Ω–∏–µ', 'name', '–ù–∞–∑–≤–∞–Ω–∏–µ', 'Name', '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ',
        '—Ç–æ–≤–∞—Ä', '–¢–æ–≤–∞—Ä', 'product', 'Product', '–æ–ø–∏—Å–∞–Ω–∏–µ', '–û–ø–∏—Å–∞–Ω–∏–µ',
        'product_name', 'title', 'Title', '–∏–º—è', '–ò–º—è'
    ];

    myPriceInput.addEventListener('change', handleMyPriceUpload);
    competitorInput.addEventListener('change', handleCompetitorUpload);
    synonymsInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        loadBarcodeAliasesFromFile(file);
    });
    searchInput.addEventListener('input', handleSearch);
    sortMatchesBtn.addEventListener('click', toggleSortMatches);
    bigDiffBtn.addEventListener('click', toggleBigDiff);
    showMyPriceBtn.addEventListener('click', toggleMyPriceView);
    showCartBtn.addEventListener('click', toggleCartView);
    compactMatchesBtn.addEventListener('click', toggleCompactMatches);
    maxCoverageBtn.addEventListener('click', toggleMaxCoverage);
    toggleFileBarcodesBtn.addEventListener('click', toggleFileBarcodesVisibility);
exportMyPriceBtn.addEventListener('click', async () => await generateExcel('myprice'));
exportAllBtn.addEventListener('click', async () => await generateExcel('all'));
exportCartBtn.addEventListener('click', async () => await generateExcel('cart'));

    clearCartBtn.addEventListener('click', clearCart);
    clearBtn.addEventListener('click', clearAll);

    function normalizeString(str) {
        return str?.toString().trim().toLowerCase() || '';
    }



// --- Deduplicate same-price duplicates inside one supplier file ---
const PRICE_COL_SYNONYMS = [
  '—Ü–µ–Ω–∞', 'price', 'cost', '—Å—Ç–æ–∏–º–æ—Å—Ç—å', '–ø—Ä–∞–π—Å', '–æ–ø—Ç', '–æ–ø—Ç–æ–≤', '—Ä–æ–∑–Ω', '—Ä—Ä—Ü', '—Ä—Ü',
  'retail', 'wholesale'
];

const MY_PRICE_FILE_NAME = 'üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å';
const META_STOCK_KEY = '__meta_stock';
const META_TRANSIT_KEY = '__meta_transit';
const STOCK_COL_SYNONYMS = ['–æ—Å—Ç–∞—Ç–æ–∫', '–æ—Å—Ç–∞—Ç–∫–∏', '–Ω–∞–ª–∏—á–∏–µ', '—Å–∫–ª–∞–¥'];


const PRICE_DECIMALS = 1;

function roundPrice(n) {
  const m = 10 ** PRICE_DECIMALS;
  return Math.round(n * m) / m;
}


function isPriceLikeColumn(colName) {
  const s = String(colName || '').toLowerCase();
  return PRICE_COL_SYNONYMS.some(k => s.includes(k));
}

function parsePriceNumber(val) {
  const s = String(val ?? '').trim();
  if (!s) return null;
  const n = parseFloat(s.replace(/[^0-9.,-]/g, '').replace(',', '.'));
  return Number.isFinite(n) ? n : null;
}

function extractPackQtyFromName(name) {
  const s = String(name ?? '');
  // –õ—é–±–æ–µ —á–∏—Å–ª–æ –ø–µ—Ä–µ–¥ "—à—Ç"/"—à—Ç—É–∫": 30—à—Ç/24–±–ª, 30 —à—Ç, 30 —à—Ç.
  const m = s.match(/(\d{1,6})\s*(?:—à—Ç|—à—Ç—É–∫)(?=[^0-9A-Za-z–ê-–Ø–∞-—è]|$)/i);
  if (!m) return null;
  const q = parseInt(m[1], 10);
  if (!Number.isFinite(q) || q <= 1) return null;
  return q;
}


function round2(n) {
  return Math.round(n * 100) / 100;
}

function samePrice(a, b) {
  const na = parsePriceNumber(a);
  const nb = parsePriceNumber(b);
  if (na !== null && nb !== null) return roundPrice(na) === roundPrice(nb);
  return String(a ?? '').trim() === String(b ?? '').trim();
}
    function removeFileExtension(fileName) {
        return fileName.replace(/\.(csv|xlsx|xls)$/i, '');
    }

    function handleSearch(e) {
        searchQuery = e.target.value.toLowerCase().trim();
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    async function handleMyPriceUpload(e) {
        try {
            const file = e.target.files[0];
            if (!file) return;
            myPriceData = await parseFile(file, 'üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å');
            processAllData();
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:", error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: " + error.message);
        }
    }

    async function handleCompetitorUpload(e) {
        try {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            competitorFilesData = [];
            for (const file of files) {
                const fileData = await parseFile(file, removeFileExtension(file.name));
                competitorFilesData.push(fileData);
            }
            processAllData();
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:", error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤: " + error.message);
        }
    }

    async function parseFile(file, fileName) {
        try {
            if (file.name.endsWith('.csv')) {
                return await parseCSV(file, fileName);
            } else {
                return await parseExcel(file, fileName);
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:", error);
            throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª");
        }
    }

    function parseCSV(file, fileName) {
        return new Promise(resolve => {
            Papa.parse(file, {
                header: true,
                encoding: 'UTF-8',
                skipEmptyLines: true,
                complete: (results) => {
                    resolve({
                        fileName,
                        data: results.data,
                        isMyPrice: fileName === 'üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å'
                    });
                }
            });
        });
    }

    function parseExcel(file, fileName) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                resolve({fileName, data: jsonData, isMyPrice: fileName === 'üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å'});
            };
            reader.readAsArrayBuffer(file);
        });
    }

    function processAllData() {
        if (!myPriceData && competitorFilesData.length === 0) return;
        allFilesData = [];
        if (myPriceData) allFilesData.push(myPriceData);
        allFilesData = allFilesData.concat(competitorFilesData);

        autoDetectColumns();
        processData();
        updateHiddenColumnsPanel();
        renderTable();
        updateUI();
    }

    function autoDetectColumns() {
        allColumns = [];
        visibleColumns.clear();
        stockColumn = null;
        barcodeColumn = null;
        nameColumn = null;

        if (allFilesData.length > 0 && allFilesData[0].data.length > 0) {
            const firstFileColumns = Object.keys(allFilesData[0].data[0]);
            barcodeColumn = firstFileColumns.find(col =>
                BARCODE_SYNONYMS.some(syn => col.toLowerCase().includes(syn.toLowerCase()))
            ) || firstFileColumns[0];

            nameColumn = firstFileColumns.find(col =>
                col !== barcodeColumn &&
                NAME_SYNONYMS.some(syn => col.toLowerCase().includes(syn.toLowerCase()))
            ) || (firstFileColumns.length > 1 ? firstFileColumns[1] : firstFileColumns[0]);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–ª—å–∫–æ –≤ –º–æ–µ–º –ø—Ä–∞–π—Å–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if (myPriceData && myPriceData.data && myPriceData.data.length > 0) {
            const myCols = Object.keys(myPriceData.data[0]);
            stockColumn = myCols.find(c => STOCK_COL_SYNONYMS.some(s => String(c).toLowerCase().includes(s))) || null;
        }

        }

        allFilesData.forEach(({fileName, data}) => {
            if (data.length > 0) {
                const fileColumns = Object.keys(data[0]);
                fileColumns.forEach(colName => {
            if (colName === barcodeColumn || colName === nameColumn) return;
            if (fileName === MY_PRICE_FILE_NAME && stockColumn && colName === stockColumn) return;
                    const colKey = `${fileName}|${colName}`;
                    allColumns.push({
                        fileName,
                        columnName: colName,
                        displayName: `${fileName} - ${colName}`,
                        key: colKey
                    });
                    visibleColumns.add(colKey);
                });
            }
        });
    

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –û—Å—Ç–∞—Ç–æ–∫ –∏ –í –ø—É—Ç–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –º–æ–µ–º –ø—Ä–∞–π—Å–µ –µ—Å—Ç—å –æ—Å—Ç–∞—Ç–æ–∫)
        if (stockColumn) {
            const stockCol = { fileName: MY_PRICE_FILE_NAME, columnName: '–û—Å—Ç–∞—Ç–æ–∫', displayName: '–û—Å—Ç–∞—Ç–æ–∫', key: META_STOCK_KEY, metaType: 'stock' };
            const transitCol = { fileName: MY_PRICE_FILE_NAME, columnName: '–í –ø—É—Ç–∏', displayName: '–í –ø—É—Ç–∏', key: META_TRANSIT_KEY, metaType: 'transit' };
            allColumns.unshift(transitCol);
            allColumns.unshift(stockCol);
            visibleColumns.add(META_STOCK_KEY);
            visibleColumns.add(META_TRANSIT_KEY);
        }
}

    function toggleColumn(colKey) {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (visibleColumns.has(colKey)) visibleColumns.delete(colKey);
        else visibleColumns.add(colKey);
        updateHiddenColumnsPanel();
        processData();
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function updateHiddenColumnsPanel() {
        const hiddenCols = allColumns.filter(col => !visibleColumns.has(col.key));
        if (hiddenCols.length > 0) {
            let html = '';
            hiddenCols.forEach(col => {
                html += `<button class="restore-column-btn" onclick="toggleColumn('${col.key}')" title="–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É ${col.displayName}">
                        ‚Ü©Ô∏è ${col.displayName}
                    </button>`;
            });
            hiddenColumnsList.innerHTML = html;
            hiddenColumnsPanel.style.display = 'flex';
        } else {
            hiddenColumnsPanel.style.display = 'none';
        }
    }

    function processData() {
        const barcodeMap = new Map();

        allFilesData.forEach(({fileName, data, isMyPrice}) => {
            data.forEach((row, index) => {
                let rawBarcode = row[barcodeColumn];
                if (!rawBarcode) return;

                const { canonical, wasSynonym } = canonicalizeBarcode(rawBarcode);
                const barcode = canonical;

                if (!barcodeMap.has(barcode)) {
                    barcodeMap.set(barcode, {
                        barcode,
                        names: [],
                        values: new Map(),
                        isInMyPrice: false,
                        myPriceOrder: -1,
                        filesWithBarcode: new Set(),
                        namesByFile: new Map(),
                        originalBarcodesByFile: new Map(),
                        isSynonym: false
                    });
                }

                const item = barcodeMap.get(barcode);
                item.filesWithBarcode.add(fileName);
                item.originalBarcodesByFile.set(fileName, rawBarcode);

                if (wasSynonym) {
                    item.isSynonym = true;
                }

                if (isMyPrice) {
                    item.isInMyPrice = true;
                    item.myPriceOrder = index;
                }

                const currentRowName = row[nameColumn];

                    // –û—Å—Ç–∞—Ç–æ–∫ —Ç–æ–ª—å–∫–æ –∏–∑ –º–æ–µ–≥–æ –ø—Ä–∞–π—Å–∞ (–µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –Ω–∞–π–¥–µ–Ω–∞)
                    if (isMyPrice && stockColumn) {
                        const stockVal = row[stockColumn];
                        if (!item.values.has(META_STOCK_KEY)) item.values.set(META_STOCK_KEY, []);
                        const arrStock = item.values.get(META_STOCK_KEY);
                        arrStock.length = 0;
                        arrStock.push({ val: (stockVal === undefined || stockVal === null) ? '' : stockVal, rowName: currentRowName, originalBarcode: rawBarcode, meta: true });
                    }
                if (currentRowName) {
                    const nameObj = {fileName, name: currentRowName};
                    if (!item.names.some(n => n.fileName === fileName && n.name === currentRowName)) {
                        item.names.push(nameObj);
                    }
                    if (!item.namesByFile.has(fileName)) {
                        item.namesByFile.set(fileName, currentRowName);
                    }

                    if (isMyPrice) {
                        // –ë–µ—Ä—ë–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ª—å–∫–æ –∏–∑ –º–æ–µ–≥–æ –ø—Ä–∞–π—Å–∞, –Ω–æ –∏—â–µ–º –Ω–µ —Ç–æ–ª—å–∫–æ –≤ nameColumn
                        const vals = Object.values(row).map(v => (v === undefined || v === null) ? '' : String(v));
                        for (const t of vals) {
                            const q = extractPackQtyFromName(t);
                            if (q) { item.packQty = q; break; }
                        }
                    }
                }

                Object.keys(row).forEach(colName => {
                    if (colName !== barcodeColumn && colName !== nameColumn) {
                        const key = `${fileName}|${colName}`;
                        const value = row[colName];
                        if (value !== undefined && value !== null && value !== '') {
                            if (!item.values.has(key)) {
                                item.values.set(key, []);
                            }
                            const arr = item.values.get(key);

                            // –î–ª—è –∫–æ–ª–æ–Ω–æ–∫ —Å —Ü–µ–Ω–æ–π: –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ü–µ–Ω—ã –Ω–µ —Å–æ–∑–¥–∞—é—Ç –Ω–æ–≤—É—é –≤–∞—Ä–∏–∞—Ü–∏—é
                            if (isPriceLikeColumn(colName)) {
                                const exists = arr.some(v => samePrice(v.val, value));
                                if (!exists) {
                                    arr.push({val: value, rowName: currentRowName, originalBarcode: rawBarcode});
                                }
                            } else {
                                arr.push({val: value, rowName: currentRowName, originalBarcode: rawBarcode});
                            }
                        }
                    }
                });
            });
        });

        groupedData = Array.from(barcodeMap.values()).map(item => {
            const visibleCols = allColumns.filter(col => visibleColumns.has(col.key));
            const numericValues = [];
            visibleCols.forEach(col => {
                const valuesArr = item.values.get(col.key);
                if (valuesArr && valuesArr.length > 0) {
                    valuesArr.forEach(vObj => {
                        const numValue = parseFloat(String(vObj.val).replace(/[^0-9.,]/g, '').replace(',', '.'));
                        if (!isNaN(numValue) && numValue > 0) {
                            numericValues.push(numValue);
                        }
                    });
                }
            });



            // –ê–≤—Ç–æ-–¥–µ–ª–µ–Ω–∏–µ: –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω "–ú–æ–π –ø—Ä–∞–π—Å" –∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä 30—à—Ç/24–±–ª),
            // —Ç–æ –¥–µ–ª–∏–º –≤—Å–µ —Ü–µ–Ω—ã –≤ —Å—Ç—Ä–æ–∫–µ, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –≤ 3 —Ä–∞–∑–∞, –Ω–∞ —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.
            const hasMyPriceLoaded = !!myPriceData;
            const packQty = (hasMyPriceLoaded && item.packQty) ? item.packQty : null;
            let autoDivFactor = null;

            if (packQty) {
                // –ê–≤—Ç–æ–ª–æ–≥–∏–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç —Å–∫—Ä—ã—Ç–∏—è –∫–æ–ª–æ–Ω–æ–∫ –≤ UI
                const cols2 = allColumns;

                // –ö–æ–ª–æ–Ω–∫–∏ —Ü–µ–Ω –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ (–º–æ–π –ø—Ä–∞–π—Å –∏—Å–∫–ª—é—á—ë–Ω, meta-–∫–æ–ª–æ–Ω–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã)
                const supplierPriceCols2 = cols2.filter(col => !col.metaType && col.fileName !== MY_PRICE_FILE_NAME && isPriceLikeColumn(col.columnName));

                // –ö–æ–ª–æ–Ω–∫–∏ —Ü–µ–Ω –≤ –º–æ—ë–º –ø—Ä–∞–π—Å–µ (–¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è)
                const myPriceCols2 = cols2.filter(col => !col.metaType && col.fileName === MY_PRICE_FILE_NAME && isPriceLikeColumn(col.columnName));

                const myNums2 = [];
                myPriceCols2.forEach(col => {
                    const arr = item.values.get(col.key);
                    if (!arr || arr.length === 0) return;
                    arr.forEach(v => {
                        const n = parsePriceNumber(v.val);
                        if (n !== null && n > 0) myNums2.push(n);
                    });
                });
                const myMin2 = myNums2.length ? Math.min(...myNums2) : null;

                const supplierNums2 = [];
                supplierPriceCols2.forEach(col => {
                    const arr = item.values.get(col.key);
                    if (!arr || arr.length === 0) return;
                    arr.forEach(v => {
                        const n = parsePriceNumber(v.val);
                        if (n !== null && n > 0) supplierNums2.push(n);
                    });
                });

                if (supplierNums2.length > 0) {
                    const minSupplier = Math.min(...supplierNums2);
                    const thresholdSupplier = minSupplier * 3;

                    // –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: –µ—Å–ª–∏ –∞–±—Å–æ–ª—é—Ç–Ω–æ –≤—Å–µ —Ü–µ–Ω—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ >= (–º–æ—è —Ü–µ–Ω–∞ * 3),
                    // —Ç–æ –¥–µ–ª–∏–º –í–°–ï —Ü–µ–Ω—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –Ω–∞ packQty.
                    const allSuppliers3xAboveMy = (myMin2 !== null) && supplierNums2.every(n => n >= myMin2 * 3);

                    let changed2 = false;
                    supplierPriceCols2.forEach(col => {
                        const arr = item.values.get(col.key);
                        if (!arr || arr.length === 0) return;
                        arr.forEach(vObj => {
                            const n = parsePriceNumber(vObj.val);
                            if (n === null || n <= 0) return;

                            if (allSuppliers3xAboveMy || n >= thresholdSupplier) {
                                if (vObj._autoDiv) return;
                                vObj._origVal = vObj.val;
                                vObj.val = roundPrice(n / packQty);
                                vObj._autoDiv = true;
                                vObj._autoDivFactor = packQty;
                                changed2 = true;
                            }
                        });
                    });

                    if (changed2) autoDivFactor = packQty;
                }
            }
            let priceDiffPercent = 0;
            if (numericValues.length > 1) {
                const minPrice = Math.min(...numericValues);
                const maxPrice = Math.max(...numericValues);
                if (minPrice > 0) {
                    priceDiffPercent = ((maxPrice - minPrice) / minPrice) * 100;
                }
            }

            const priceKeys = new Set(
                allColumns
                    .filter(c => isPriceLikeColumn(c.columnName))
                    .map(c => c.key)
            );

            let isDuplicate = false;
            for (const [key, valuesArr] of item.values.entries()) {
                if (!priceKeys.has(key)) continue;
                if (valuesArr && valuesArr.length > 1) {
                    isDuplicate = true;
                    break;
                }
            }
            const filesWithPrices = new Set();
            for (const [key, valuesArr] of item.values.entries()) {
                if (valuesArr && valuesArr.length > 0) {
                    const fileName = key.split('|')[0];
                    filesWithPrices.add(fileName);
                }
            }
            const coverageCount = filesWithPrices.size;

                        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ (–ø—É—Å—Ç—ã–µ, –µ—Å–ª–∏ –Ω–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è)
            if (stockColumn) {
                if (!item.values.has(META_STOCK_KEY)) {
                    item.values.set(META_STOCK_KEY, [{ val: '', rowName: '', originalBarcode: item.barcode, meta: true }]);
                }
                if (!item.values.has(META_TRANSIT_KEY)) {
                    item.values.set(META_TRANSIT_KEY, [{ val: '', rowName: '', originalBarcode: item.barcode, meta: true }]);
                }
            }

return { barcode: item.barcode, packQty, autoDivFactor,
                names: item.names,
                namesByFile: item.namesByFile,
                values: item.values,
                isInMyPrice: item.isInMyPrice,
                myPriceOrder: item.myPriceOrder,
                originalFileCount: item.filesWithBarcode.size,
                priceDiffPercent,
                isDuplicate,
                coverageCount,
                isSynonym: item.isSynonym,
                originalBarcodesByFile: item.originalBarcodesByFile
            };
        });
    }

    function toggleCart(barcode) {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (cart.has(barcode)) cart.delete(barcode);
        else cart.add(barcode);
        updateCartUI();
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function clearCart() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        cart.clear();
        updateCartUI();
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function updateCartUI() {
        const cartSize = cart.size;
        if (cartSize > 0) {
            cartBadge.textContent = cartSize;
            cartBadge.style.display = 'block';
            exportCartBtn.disabled = false;
            clearCartBtn.disabled = false;
            showCartBtn.disabled = false;
        } else {
            cartBadge.style.display = 'none';
            exportCartBtn.disabled = true;
            clearCartBtn.disabled = true;
            showCartBtn.disabled = true;
            if (sortMode === 'cart') {
                sortMode = 'default';
                showCartBtn.classList.remove('active');
                renderTable();
            }
        }
    }

    function toggleSortMatches() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (sortMode === 'matches') {
            sortMode = 'default';
            sortMatchesBtn.classList.remove('active');
        } else {
            sortMode = 'matches';
            sortMatchesBtn.classList.add('active');
            bigDiffBtn.classList.remove('active');
            showMyPriceBtn.classList.remove('active');
            showCartBtn.classList.remove('active');
            maxCoverageBtn.classList.remove('active');
        }
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleBigDiff() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (sortMode === 'bigdiff') {
            sortMode = 'default';
            bigDiffBtn.classList.remove('active');
        } else {
            sortMode = 'bigdiff';
            bigDiffBtn.classList.add('active');
            sortMatchesBtn.classList.remove('active');
            showMyPriceBtn.classList.remove('active');
            showCartBtn.classList.remove('active');
            maxCoverageBtn.classList.remove('active');
        }
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleMyPriceView() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (sortMode === 'myprice') {
            sortMode = 'default';
            showMyPriceBtn.classList.remove('active');
        } else {
            sortMode = 'myprice';
            showMyPriceBtn.classList.add('active');
            sortMatchesBtn.classList.remove('active');
            bigDiffBtn.classList.remove('active');
            showCartBtn.classList.remove('active');
            maxCoverageBtn.classList.remove('active');
        }
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleCartView() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (sortMode === 'cart') {
            sortMode = 'default';
            showCartBtn.classList.remove('active');
        } else {
            sortMode = 'cart';
            showCartBtn.classList.add('active');
            sortMatchesBtn.classList.remove('active');
            bigDiffBtn.classList.remove('active');
            showMyPriceBtn.classList.remove('active');
            maxCoverageBtn.classList.remove('active');
        }
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleMaxCoverage() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (sortMode === 'maxcoverage') {
            sortMode = 'default';
            maxCoverageBtn.classList.remove('active');
        } else {
            sortMode = 'maxcoverage';
            maxCoverageBtn.classList.add('active');
            sortMatchesBtn.classList.remove('active');
            bigDiffBtn.classList.remove('active');
            showMyPriceBtn.classList.remove('active');
            showCartBtn.classList.remove('active');
        }
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleCompactMatches() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        compactMatches = !compactMatches;
        if (compactMatches) compactMatchesBtn.classList.add('active');
        else compactMatchesBtn.classList.remove('active');
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleBarcodeSort() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (barcodeSortOrder === 0) barcodeSortOrder = 1;
        else if (barcodeSortOrder === 1) barcodeSortOrder = -1;
        else barcodeSortOrder = 0;
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleFileBarcodesVisibility() {
        showFileBarcodes = !showFileBarcodes;
        if (showFileBarcodes) {
            toggleFileBarcodesBtn.classList.add('active');
        } else {
            toggleFileBarcodesBtn.classList.remove('active');
        }
        renderTable();
    }

    function getSortedData() {
        let data = [...groupedData];

        if (searchQuery) {
            data = data.filter(item =>
                item.names.some(n => n.name.toLowerCase().includes(searchQuery))
            );
        }

        if (sortMode === 'matches') {
            data.sort((a, b) => {
                if (a.originalFileCount > 1 && b.originalFileCount === 1) return -1;
                if (a.originalFileCount === 1 && b.originalFileCount > 1) return 1;
                return 0;
            });
        } else if (sortMode === 'bigdiff') {
            data = data.filter(item => item.originalFileCount > 1 && item.priceDiffPercent > 10);
            data.sort((a, b) => b.priceDiffPercent - a.priceDiffPercent);
        } else if (sortMode === 'myprice') {
            data = data.filter(item => item.isInMyPrice);
            data.sort((a, b) => a.myPriceOrder - b.myPriceOrder);
        } else if (sortMode === 'cart') {
            data = data.filter(item => cart.has(item.barcode));
        } else if (sortMode === 'maxcoverage') {
            data.sort((a, b) => b.coverageCount - a.coverageCount);
        }

        if (barcodeSortOrder !== 0) {
            data.sort((a, b) => {
                const bcA = String(a.barcode);
                const bcB = String(b.barcode);
                return barcodeSortOrder === 1 ? bcA.localeCompare(bcB) : bcB.localeCompare(bcA);
            });
        }

        return data;
    }

    function copyBarcode(barcode, btn) {
        if (!navigator.clipboard) return;
        navigator.clipboard.writeText(String(barcode)).then(() => {
            const orig = btn.textContent;
            btn.textContent = '‚úì';
            setTimeout(() => {
                btn.textContent = orig;
            }, 600);
        }).catch(() => {
        });
    }

    function copyBarcodeFromPrice(barcode) {
        if (!navigator.clipboard) return;
        navigator.clipboard.writeText(String(barcode)).then(() => {
            console.log('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω —à—Ç—Ä–∏—Ö–∫–æ–¥:', barcode);
        }).catch(() => {});
    }

    function editColumnName(colKey) {
        const col = allColumns.find(c => c.key === colKey);
        if (!col) return;
        const newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏:', col.displayName);
        if (newName && newName.trim() !== '' && newName.trim() !== col.displayName) {
            col.displayName = newName.trim();
            const wrapper = document.querySelector('.table-wrapper');
            const scrollTop = wrapper ? wrapper.scrollTop : 0;
            updateHiddenColumnsPanel();
            renderTable();
            const newWrapper = document.querySelector('.table-wrapper');
            if (newWrapper) newWrapper.scrollTop = scrollTop;
        }
    }

    function renderTable() {
        const dataToShow = getSortedData();

        if (dataToShow.length === 0) {
            tableContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
                    <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã</p>
                </div>`;
            return;
        }

        const visibleCols = allColumns.filter(col => visibleColumns.has(col.key));

        let html = '<div class="table-wrapper"><table><thead><tr>';
        html += `<th class="col-actions">–ö–æ—Ä–∑–∏–Ω–∞</th>`;

        let sortIcon = '';
        if (barcodeSortOrder === 1) sortIcon = ' ‚ñ≤';
        else if (barcodeSortOrder === -1) sortIcon = ' ‚ñº';
        html += `<th class="col-barcode" onclick="toggleBarcodeSort()" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É">–®—Ç—Ä–∏—Ö–∫–æ–¥ (–∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π)${sortIcon}</th>`;

        // –ö–æ–ª–æ–Ω–∫–∏ —Å–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞–º–∏ –ø–æ —Ñ–∞–π–ª–∞–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç—ã)
        allFilesData.forEach(({fileName}, idx) => {
            const extraClass = showFileBarcodes ? '' : 'hidden-barcode-col';
            html += `<th class="col-barcode file-barcode-col ${extraClass}" data-file-index="${idx}" title="–®—Ç—Ä–∏—Ö–∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞ ${fileName}">–®—Ç—Ä–∏—Ö–∫–æ–¥ (${fileName})</th>`;
        });

        html += `<th class="col-name">${nameColumn}</th>`;

        visibleCols.forEach(col => {
            const checked = visibleColumns.has(col.key) ? 'checked' : '';
            html += `<th title="${col.displayName}">
                    <div class="column-header">
                        <div class="column-header-checkbox">
                            <input type="checkbox" ${checked} onchange="toggleColumn('${col.key}')" />
                            <span>–í–∫–ª</span>
                        </div>
                        <div class="column-header-title">
                            <span class="column-name-text">${col.displayName}</span>
                            <button class="edit-col-btn" onclick="editColumnName('${col.key}')" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É">‚úèÔ∏è</button>
                        </div>
                    </div>
                </th>`;
        });

        html += '</tr></thead><tbody>';

        dataToShow.forEach((item, index) => {
            const inCart = cart.has(item.barcode);
            let rowClass = '';
            
            if (item.isSynonym) rowClass = 'synonym-row';
            else if (item.isDuplicate) rowClass = 'duplicate-row';
            
            if (inCart) {
                if (item.isSynonym) rowClass = 'in-cart synonym-row';
                else if (item.isDuplicate) rowClass = 'in-cart duplicate-row';
                else rowClass = 'in-cart';
            } else if (item.isInMyPrice && !item.isDuplicate && !item.isSynonym) {
                rowClass = 'my-price-row';
            }

            const prev = dataToShow[index - 1];
            const next = dataToShow[index + 1];
            const isGroupStart = !prev || prev.barcode !== item.barcode;
            const isGroupEnd = !next || next.barcode !== item.barcode;
            if (isGroupStart) rowClass += (rowClass ? ' ' : '') + 'group-border-top';
            if (isGroupEnd) rowClass += (rowClass ? ' ' : '') + 'group-border-bottom';

            html += `<tr class="${rowClass}">`;
            html += `<td class="col-actions">
                    <button class="cart-btn ${inCart ? 'in-cart' : ''}"
                            title="${inCart ? '–£–±—Ä–∞—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É'}"
                            onclick="toggleCart('${item.barcode}')">
                        ${inCart ? '‚úì' : 'üõí'}
                    </button>
                </td>`;

            html += `<td class="col-barcode">
                    <div class="barcode-cell">
                        <span class="barcode-text" title="${item.barcode}">${item.barcode}</span>
                        <button class="copy-btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥"
                                onclick="copyBarcode('${item.barcode}', this)">üìã</button>
                    </div>
                </td>`;

            // –Ø—á–µ–π–∫–∏ —Å –®–ö –ø–æ —Ñ–∞–π–ª–∞–º
            allFilesData.forEach(({fileName}, idx) => {
                const extraClass = showFileBarcodes ? '' : 'hidden-barcode-col';
                const origBarcode = item.originalBarcodesByFile.get(fileName) || '‚Äî';
                html += `<td class="col-barcode file-barcode-col ${extraClass}" data-file-index="${idx}">
                        <div class="barcode-cell">
                            <span class="barcode-text" title="${origBarcode}">${origBarcode}</span>
                            ${origBarcode !== '‚Äî' ? `<button class="copy-btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥" onclick="copyBarcode('${origBarcode}', this)">üìã</button>` : ''}
                        </div>
                    </td>`;
            });

            if (compactMatches && item.names.length > 1) {
                const text = item.names.map(n => n.name).join(' | ');
                html += `<td class="col-name">
                        <div class="name-compact" title="${text}">
                            ${text}
                        </div>
                    </td>`;
            } else {
                if (item.names.length > 0) {
                    html += `<td class="col-name"><div class="name-cell">`;
                    const uniqueNames = new Set(item.names.map(n => n.name));
                    uniqueNames.forEach(name => {
                        html += `<div class="name-item">${name}</div>`;
                    });
                    html += `</div></td>`;
                } else {
                    html += `<td class="col-name">–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è</td>`;
                }
            }

            const numericValues = [];

            // –î–ª—è –ø—Ä–∞–≤–∏–ª–∞ "–≤ 3 —Ä–∞–∑–∞ –≤—ã—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π" –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Ü–µ–Ω—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ (–º–æ–π –ø—Ä–∞–π—Å –∏ meta-–∫–æ–ª–æ–Ω–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã)
            const supplierVisiblePriceCols = visibleCols.filter(col => !col.metaType && col.fileName !== MY_PRICE_FILE_NAME && isPriceLikeColumn(col.columnName));
            supplierVisiblePriceCols.forEach(col => {
                const valuesArr = item.values.get(col.key);
                if (valuesArr) {
                    valuesArr.forEach(vObj => {
                        const n = parsePriceNumber(vObj.val);
                        if (n !== null && n > 0) numericValues.push(n);
                    });
                }
            });

            const globalMin = numericValues.length > 0 ? Math.min(...numericValues) : null;
            const globalMax = numericValues.length > 0 ? Math.max(...numericValues) : null;
            const hasMultipleGlobals = numericValues.length > 1;

            visibleCols.forEach(col => {
                const valuesArr = item.values.get(col.key);
                let cellContent = '‚Äî';

                if (col.metaType) {
                    const v = (valuesArr && valuesArr.length > 0) ? valuesArr[0].val : '';
                    cellContent = (v === undefined || v === null || String(v).trim() === '') ? '‚Äî' : String(v);
                    html += `<td>${cellContent}</td>`;
                    return;
                }

                if (valuesArr && valuesArr.length > 0) {
                    cellContent = '<div class="multi-value-container">';
                    valuesArr.forEach((vObj, vIndex) => {
                        let displayValue;
                        let isMin = false;
                        let isMax = false;
                        let numValue = null;

                        const parsed = parseFloat(String(vObj.val).replace(/[^0-9.,]/g, '').replace(',', '.'));
                        if (!isNaN(parsed) && parsed > 0) {
                            numValue = parsed;
                            displayValue = parsed.toFixed(PRICE_DECIMALS) + ' ‚ÇΩ';

                            if (hasMultipleGlobals && parsed === globalMin) {
                                isMin = true;
                            }

                            if (hasMultipleGlobals && parsed === globalMax && globalMax >= 3 * globalMin) {
                                isMax = true;
                            }
                        } else {
                            displayValue = vObj.val;
                        }

                        const barcodeForCopy = vObj.originalBarcode || item.barcode;
                        const autoBadge = vObj._autoDiv ? `<span class="auto-div-badge" title="–ê–≤—Ç–æ–¥–µ–ª–µ–Ω–∏–µ /${vObj._autoDivFactor || item.packQty}">√∑</span>` : '';
                        let innerHtml = `<span class="price-clickable" onclick="copyBarcodeFromPrice('${barcodeForCopy}')" title="–ö–ª–∏–∫ ‚Üí –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥ ${barcodeForCopy}">${displayValue}</span>${autoBadge}`;
                        
                        if (isMin) {
                            innerHtml = `<span class="price-val is-min price-clickable" onclick="copyBarcodeFromPrice('${barcodeForCopy}')" title="–ö–ª–∏–∫ ‚Üí –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥ ${barcodeForCopy}">${displayValue}</span>${autoBadge}`;
                        }

                        if (isMax && numValue) {
                            innerHtml = `<span class="price-clickable" onclick="copyBarcodeFromPrice('${barcodeForCopy}')" title="–ö–ª–∏–∫ ‚Üí –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥ ${barcodeForCopy}">${displayValue}</span>${autoBadge}
                                <div class="div-wrapper" title="–¶–µ–Ω–∞ —É–∫–∞–∑–∞–Ω–∞ –∑–∞ –±–ª–æ–∫? –†–∞–∑–¥–µ–ª–∏—Ç–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç—É–∫">
                                    <div class="div-icon">√∑</div>
                                    <select class="div-select" onchange="dividePrice('${item.barcode}','${col.key}', ${vIndex}, this.value); this.value='';">
                                        <option value="" disabled selected>√∑</option>
                                        ${Array.from({length: 99}, (_, i) => i + 2).map(n => `<option value="${n}">${n}</option>`).join('')}
                                    </select>
                                </div>`;
                        }

                        cellContent += `<div class="value-variant">${innerHtml}</div>`;
                    });
                    cellContent += '</div>';
                }

                html += `<td>${cellContent}</td>`;
            });

            html += '</tr>';
        });

        html += '</tbody></table></div>';
        tableContainer.innerHTML = html;
    }

    function dividePrice(barcode, colKey, valueIndex, factorStr) {
        const factor = parseFloat(factorStr);
        if (!factor || factor <= 0) return;

        const item = groupedData.find(x => String(x.barcode) === String(barcode));
        if (!item) return;

        const visibleCols = allColumns.filter(col => visibleColumns.has(col.key));
    const priceCols = visibleCols.filter(col => !col.metaType && isPriceLikeColumn(col.columnName));
    const nums = [];
        priceCols.forEach(col => {
            const arr = item.values.get(col.key);
            if (!arr || arr.length === 0) return;
            arr.forEach(v => {
                const n = parsePriceNumber(v.val);
                if (n !== null && n > 0) nums.push(n);
            });
        });
        if (nums.length === 0) return;

        const minValue = Math.min(...nums);
        const threshold = minValue * 3;

        let changed = false;
        priceCols.forEach(col => {
            const arr = item.values.get(col.key);
            if (!arr || arr.length === 0) return;
            arr.forEach(vObj => {
                const n = parsePriceNumber(vObj.val);
                if (n === null || n <= 0) return;
                if (n > threshold) {
                    vObj.val = roundPrice(n / factor);
                    changed = true;
                }
            });
        });

        if (!changed) return;

        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–∏–∞–ª–æ–≥ (Chrome/Edge –∏ –¥—Ä. Chromium), –∏–Ω–∞—á–µ fallback –Ω–∞ FileSaver.js saveAs()
    async function saveBlobWithDialogOrDownload(blob, fileName) {
        // File System Access API (–¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ –º–µ—Å—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
        if (window.showSaveFilePicker) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'Excel (.xlsx)',
                        accept: {
                            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']
                        }
                    }]
                });

                const writable = await handle.createWritable();
                await writable.write(blob);
                await writable.close();
                return; // —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥
            } catch (err) {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –¥–∏–∞–ª–æ–≥ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º –º–æ–ª—á–∞
                if (err && (err.name === 'AbortError' || err.name === 'NotAllowedError')) return;
                // –ò–Ω–∞—á–µ ‚Äî —É–ø–∞–¥—ë–º –≤ –æ–±—ã—á–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
                console.warn('Save picker failed, fallback to download:', err);
            }
        }

        // Fallback: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        await saveBlobWithDialogOrDownload(blob, fileName);
    }


    async function generateExcel(mode) {
    const visibleCols = allColumns.filter(col => visibleColumns.has(col.key));
    const fileNames = allFilesData.map(f => f.fileName);
    const hasMyPrice = !!myPriceData;
    const myPriceFileName = hasMyPrice ? 'üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å' : null;

    let dataToExport = [];
    if (mode === 'cart') {
        dataToExport = groupedData.filter(item => cart.has(item.barcode));
    } else if (mode === 'myprice') {
        dataToExport = groupedData
            .filter(item => item.isInMyPrice)
            .sort((a, b) => a.myPriceOrder - b.myPriceOrder);
    } else {
        dataToExport = groupedData;
    }

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('–°—Ä–∞–≤–Ω–µ–Ω–∏–µ');

    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    const headers = ['–®—Ç—Ä–∏—Ö–∫–æ–¥ (–∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π)'];

    // –®–ö –ø–æ —Ñ–∞–π–ª–∞–º
    fileNames.forEach(fileName => headers.push(`–®—Ç—Ä–∏—Ö–∫–æ–¥ (${fileName})`));

    // –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è: —Å–Ω–∞—á–∞–ª–∞ –ú–æ–π –ø—Ä–∞–π—Å (–µ—Å–ª–∏ –µ—Å—Ç—å), –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
    const nameFileOrder = [];
    if (hasMyPrice) {
        nameFileOrder.push(myPriceFileName);
    }
    fileNames.forEach(fn => {
        if (!hasMyPrice || fn !== myPriceFileName) nameFileOrder.push(fn);
    });

    nameFileOrder.forEach(fileName => {
        headers.push(`–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (${fileName})`);
    });

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ (—Ü–µ–Ω—ã –∏ —Ç.–ø.)
    visibleCols.forEach(col => headers.push(col.displayName));
    
    worksheet.addRow(headers);

    dataToExport.forEach(item => {
        let maxDepth = 0;
        visibleCols.forEach(col => {
            const valuesArr = item.values.get(col.key);
            if (valuesArr && valuesArr.length > maxDepth) {
                maxDepth = valuesArr.length;
            }
        });
        if (maxDepth === 0) maxDepth = 1;

        for (let d = 0; d < maxDepth; d++) {
            const row = [item.barcode];

            // –®–ö –ø–æ —Ñ–∞–π–ª–∞–º
            fileNames.forEach(fileName => {
                const origBarcode = item.originalBarcodesByFile.get(fileName) || '';
                row.push(origBarcode);
            });

            // –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –ø–æ —Ñ–∞–π–ª–∞–º (–≤ –ø–æ—Ä—è–¥–∫–µ nameFileOrder)
            nameFileOrder.forEach(fileName => {
                const name = item.namesByFile && item.namesByFile.has(fileName)
                    ? item.namesByFile.get(fileName)
                    : '';
                row.push(name || '');
            });

            const priceStartCol = row.length;
            const numericValuesInRow = [];
            const numericColsInRow = [];

            visibleCols.forEach((col, idx) => {
                const valuesArr = item.values.get(col.key);
                let cellValue = '';

                if (valuesArr && valuesArr.length > d) {
                    const vObj = valuesArr[d];
                    const numValue = parseFloat(String(vObj.val).replace(/[^0-9.,]/g, '').replace(',', '.'));
                    if (!isNaN(numValue) && numValue > 0) {
                        cellValue = roundPrice(numValue);
                        numericValuesInRow.push(roundPrice(numValue));
                        numericColsInRow.push(priceStartCol + idx);
                    } else {
                        cellValue = vObj.val;
                    }
                }

                row.push(cellValue);
            });

            const excelRow = worksheet.addRow(row);

            // –§–æ—Ä–º–∞—Ç —á–∏—Å–µ–ª: –æ–¥–Ω–∞ —Ü–∏—Ñ—Ä–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
            numericColsInRow.forEach(colIdx => {
                const c = excelRow.getCell(colIdx + 1);
                if (typeof c.value === 'number') c.numFmt = '0.0';
            });


            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫
            if (item.isSynonym) {
                excelRow.eachCell((cell) => {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: {argb: 'FFE6F7FF'}
                    };
                });
            } else if (item.isDuplicate) {
                excelRow.eachCell((cell) => {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: {argb: 'FFFFE6F0'}
                    };
                });
            }

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã
            if (numericValuesInRow.length > 1) {
                const minValue = Math.min(...numericValuesInRow);
                numericColsInRow.forEach((colIdx, i) => {
                    if (numericValuesInRow[i] === minValue) {
                        const cell = excelRow.getCell(colIdx + 1);
                        cell.font = {
                            color: {argb: 'FF28A745'},
                            bold: true
                        };
                    }
                });
            }
        }
    });

    // === –®–∏—Ä–∏–Ω—ã –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å—Ç–æ–ª–±—Ü–æ–≤ ===
    const fileBarcodesStart = 2;
    const fileBarcodesEnd = 1 + fileNames.length;
    const namesStart = fileBarcodesEnd + 1;
    const namesEnd = namesStart + nameFileOrder.length - 1;

    worksheet.columns.forEach((column, idx) => {
        const colIndex1 = idx + 1;
        if (colIndex1 === 1) {
            column.width = 15; // –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π –®–ö
        } else if (colIndex1 >= fileBarcodesStart && colIndex1 <= fileBarcodesEnd) {
            column.width = 13;  // —É–∑–∫–∏–µ –®–ö –ø–æ —Ñ–∞–π–ª–∞–º
        } else if (colIndex1 >= namesStart && colIndex1 <= namesEnd) {
            if (hasMyPrice && nameFileOrder[0] === myPriceFileName && colIndex1 === namesStart) {
                column.width = 50; // –ú–æ–π –ø—Ä–∞–π—Å –æ—Ç–∫—Ä—ã—Ç—ã–π
            } else {
                column.width = 20;  // —Å–≤–µ—Ä–Ω—É—Ç—ã–µ –∏–º–µ–Ω–∞
            }
        } else {
            column.width = 10;
        }
    });

    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –®–ö –ø–æ —Ñ–∞–π–ª–∞–º
    if (fileNames.length > 0) {
        worksheet.properties.outlineProperties = { summaryBelow: true };
        for (let c = fileBarcodesStart; c <= fileBarcodesEnd; c++) {
            const col = worksheet.getColumn(c);
            col.outlineLevel = 1;
            col.hidden = true;
        }
    }

    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–π (–∫—Ä–æ–º–µ –º–æ–µ–≥–æ –ø—Ä–∞–π—Å–∞)
    if (nameFileOrder.length > 1) {
        worksheet.properties.outlineProperties = { summaryBelow: true };
        const start = hasMyPrice ? namesStart + 1 : namesStart;
        const end = namesEnd;
        for (let c = start; c <= end; c++) {
            const col = worksheet.getColumn(c);
            col.outlineLevel = 1;
            col.hidden = true;
        }
    }

    worksheet.views = [
        {state: 'frozen', xSplit: 0, ySplit: 1}
    ];

    worksheet.eachRow((row) => {
        row.eachCell((cell) => {
            cell.border = {
                top: {style: 'thin'},
                left: {style: 'thin'},
                bottom: {style: 'thin'},
                right: {style: 'thin'}
            };
        });
    });

    // –ü–æ–¥–ø–∏—Å—å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –æ –≥—Ä—É–ø–ø–∞—Ö
    const headerRow = worksheet.getRow(1);
    headerRow.font = {bold: true};
    headerRow.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: {argb: 'FFE0E0E0'}
    };
    headerRow.alignment = {vertical: 'middle', horizontal: 'center'};

    // –î–æ–±–∞–≤–∏–º –ø–æ—è—Å–Ω–µ–Ω–∏–µ –≤ –ø–µ—Ä–≤—ã–µ —è—á–µ–π–∫–∏:
    headerRow.getCell(fileBarcodesStart).note = '–ì—Ä—É–ø–ø–∞: –®—Ç—Ä–∏—Ö–∫–æ–¥—ã –ø–æ —Ñ–∞–π–ª–∞–º. –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ + –≤ –ø–∞–Ω–µ–ª–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏.';
    headerRow.getCell(namesStart).note = '–ì—Ä—É–ø–ø–∞: –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –ø–æ —Ñ–∞–π–ª–∞–º. –ú–æ–π –ø—Ä–∞–π—Å –æ—Ç–∫—Ä—ã—Ç, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–≤–µ—Ä–Ω—É—Ç—ã.';

    const buffer = await workbook.xlsx.writeBuffer();

    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');

    let fileName = `monitoring-${yyyy}-${mm}-${dd}.xlsx`;
    if (mode === 'cart') fileName = `monitoring-cart-${yyyy}-${mm}-${dd}.xlsx`;
    if (mode === 'myprice') fileName = `monitoring-myprice-${yyyy}-${mm}-${dd}.xlsx`;

    const blob = new Blob([buffer], {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    });
    await saveBlobWithDialogOrDownload(blob, fileName);
}


    function updateUI() {
        const hasData = groupedData.length > 0;
        const hasMyPrice = myPriceData !== null;

        exportAllBtn.disabled = !hasData;
        exportMyPriceBtn.disabled = !hasMyPrice || !hasData;
        clearBtn.disabled = !hasData;
        sortMatchesBtn.disabled = !hasData;
        bigDiffBtn.disabled = !hasData;
        showMyPriceBtn.disabled = !hasMyPrice || !hasData;
        compactMatchesBtn.disabled = !hasData;
        maxCoverageBtn.disabled = !hasData;
        toggleFileBarcodesBtn.disabled = !hasData;
        searchInput.disabled = !hasData;

        if (hasData) {
            infoPanel.style.display = 'grid';
            const matchCount = groupedData.filter(item => item.originalFileCount > 1).length;
            document.getElementById('productCount').textContent = groupedData.length;
            document.getElementById('fileCount').textContent = allFilesData.length;
            document.getElementById('columnCount').textContent = allColumns.length;
            document.getElementById('matchCount').textContent = matchCount;
        } else {
            infoPanel.style.display = 'none';
        }
    }

    function clearAll() {
        myPriceData = null;
        competitorFilesData = [];
        allFilesData = [];
        groupedData = [];
        allColumns = [];
        visibleColumns.clear();
        cart.clear();
        barcodeColumn = null;
        nameColumn = null;
        sortMode = 'default';
        compactMatches = false;
        searchQuery = '';
        barcodeSortOrder = 0;
        showFileBarcodes = false;

        myPriceInput.value = '';
        competitorInput.value = '';
        synonymsInput.value = '';
        resetBarcodeAliases();
        searchInput.value = '';
        sortMatchesBtn.classList.remove('active');
        bigDiffBtn.classList.remove('active');
        showMyPriceBtn.classList.remove('active');
        showCartBtn.classList.remove('active');
        compactMatchesBtn.classList.remove('active');
        maxCoverageBtn.classList.remove('active');
        toggleFileBarcodesBtn.classList.remove('active');
        hiddenColumnsPanel.style.display = 'none';
        updateCartUI();

        tableContainer.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç—ã</h3>
                <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à –ø—Ä–∞–π—Å –∏ —Ñ–∞–π–ª—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</p>
            </div>`;
        updateUI();
    }

    window.toggleColumn = toggleColumn;
    window.toggleCart = toggleCart;
    window.copyBarcode = copyBarcode;
    window.copyBarcodeFromPrice = copyBarcodeFromPrice;
    window.toggleBarcodeSort = toggleBarcodeSort;
    window.dividePrice = dividePrice;
    window.editColumnName = editColumnName;
</script>
</body>
</html>
