<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='80'%3E%F0%9F%92%B2%3C/text%3E%3C/svg%3E" />
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* ===== RESET ===== */
* { margin: 0; padding: 0; box-sizing: border-box; }

/* ===== BODY & BACKGROUND ===== */
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #f0f0f0;
  min-height: 100vh;
  padding: 0 0 32px 0;
  color: #1f1f1f;
}

/* ===== APP NAV ===== */
.app-nav {
  position: sticky; top: 0; z-index: 5000;
  background: #14512e;
  display: flex; align-items: stretch;
  padding: 0 10px; gap: 2px;
  border-bottom: 1px solid rgba(0,0,0,0.3);
}
.app-nav a {
  color: rgba(255,255,255,0.55);
  text-decoration: none; font-size: 13px; font-weight: 500;
  font-family: 'Segoe UI', Arial, sans-serif;
  padding: 8px 18px; border-bottom: 3px solid transparent;
  white-space: nowrap; letter-spacing: 0.01em;
  transition: color .15s, background .15s;
  display: flex; align-items: center;
}
.app-nav a:hover { color: rgba(255,255,255,0.9); background: rgba(255,255,255,0.07); }
.app-nav a.nav-active { color: #fff; border-bottom-color: #5dce8a; font-weight: 700; }

/* ===== MAIN CONTAINER ===== */
.container {
  max-width: 100%;
  margin: 12px 12px 0;
  background: #ffffff;
  border-radius: 4px;
  padding: 16px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  border: 1px solid #d0d0d0;
}

h1 {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 14px;
  color: #1f1f1f;
}

/* ===== UPLOAD SECTION ===== */
.upload-section {
  display: grid;
  grid-template-columns: 0.7fr 1.15fr 1.15fr;
  gap: 7px;
  margin-bottom: 10px;
  align-items: stretch;
}
.upload-card {
  background: #f8f8f8;
  border-radius: 5px;
  padding: 7px 9px;
  border: 1px solid #d0d0d0;
  transition: border-color 0.15s;
  display: flex;
  flex-direction: column;
}
.upload-card:hover { border-color: #217346; }
.upload-card.my-price { border-color: #2d9a5f; background: #f0faf2; }
.upload-card.my-price:hover { border-color: #155724; }
.upload-card.suppliers { border-color: #4a90d9; background: #f0f6ff; }
.upload-card.suppliers:hover { border-color: #2255a4; }
.upload-label {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  font-weight: 700;
  color: #555;
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.upload-label-hint {
  font-weight: 400;
  font-size: 9px;
  color: #a07800;
  text-transform: none;
  letter-spacing: 0;
  opacity: .8;
}
.upload-card.my-price .upload-label { color: #155724; }
.upload-card.suppliers .upload-label { color: #1a4a8a; }
.upload-status {
  font-size: 10px;
  margin-top: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.upload-status--idle  { color: #999; }
.upload-status--ok    { color: #217346; font-weight: 600; }
.upload-status--error { color: #c0392b; }

.btn-xs { font-size: 10px !important; padding: 2px 6px !important; }
.file-input-wrapper { position: relative; }
.file-input-wrapper input[type="file"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
.file-input-display {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 5px 9px;
  background: white;
  border-radius: 3px;
  font-size: 11px;
  color: #217346;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid #c0c0c0;
  transition: background 0.15s, border-color 0.15s;
  white-space: nowrap;
  overflow: hidden;
}
.file-input-display:hover { background: #eaf4ee; border-color: #217346; }
.upload-card.my-price .file-input-display { color: #155724; border-color: #b8d8c8; }
.upload-card.my-price .file-input-display:hover { background: #e0f0e8; }
.upload-card.suppliers .file-input-display { color: #1a4a8a; border-color: #aac4e8; }
.upload-card.suppliers .file-input-display:hover { background: #e0ecff; border-color: #4a90d9; }
.upload-card.synonyms { border-color: #d4a017; background: #fffdf0; }
.upload-card.synonyms .upload-label { color: #7d5a00; }

/* ===== SEARCH ===== */
.search-box { margin-bottom: 10px; }
.search-box--above-table { margin-top: 8px; margin-bottom: 6px; }
.search-input {
  width: 100%;
  padding: 6px 10px;
  border: 1px solid #c0c0c0;
  border-radius: 3px;
  font-size: 13px;
  font-family: inherit;
  background: #fff;
  transition: border-color 0.15s;
}
.search-input:focus { outline: none; border-color: #217346; box-shadow: 0 0 0 2px rgba(33,115,70,0.12); }

/* ===== CONTROLS (grouped) ===== */
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 10px;
  align-items: center;
}
.controls-group {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  align-items: center;
  background: #f8f8f8;
  border: 1px solid #d0d0d0;
  border-radius: 3px;
  padding: 5px 8px;
}
.controls-group-label {
  font-size: 10px;
  font-weight: 700;
  color: #666;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  margin-right: 2px;
  white-space: nowrap;
}
.controls-group.export-group { background: #f0faf2; border-color: #b8d8c8; }
.controls-group.export-group .controls-group-label { color: #155724; }
.controls-group.danger-group { background: #fff8f8; border-color: #f5c6c6; }
.controls-group.danger-group .controls-group-label { color: #c0392b; }

/* ===== BUTTONS ===== */
.btn {
  padding: 4px 10px;
  border: 1px solid #c0c0c0;
  border-radius: 3px;
  cursor: pointer;
  font-weight: 500;
  font-size: 12px;
  font-family: inherit;
  transition: background 0.12s, border-color 0.12s;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  line-height: 1.4;
  white-space: nowrap;
  background: #fff;
  color: #1f1f1f;
}
.btn span.icon { font-size: 13px; }
.btn:hover:not(:disabled) { background: #eaf4ee; border-color: #217346; color: #155724; }
.btn-primary { background: #217346; color: white; border-color: #185c38; }
.btn-primary:hover:not(:disabled) { background: #185c38; color: white; }
.btn-success { background: #217346; color: white; border-color: #185c38; }
.btn-success:hover:not(:disabled) { background: #185c38; color: white; }
.btn-warning { background: #d4a017; color: white; border-color: #b8860b; }
.btn-warning:hover:not(:disabled) { background: #b8860b; color: white; }
.btn-danger { background: #fff; color: #c0392b; border-color: #e0a0a0; }
.btn-danger:hover:not(:disabled) { background: #fce8e6; border-color: #c0392b; color: #c0392b; }
.btn-secondary { background: #fff; color: #1f1f1f; border: 1px solid #c0c0c0; }
.btn-secondary:hover:not(:disabled) { background: #eaf4ee; border-color: #217346; color: #155724; }
.btn-secondary.active { background: #217346; color: white; border-color: #185c38; }
.btn:disabled { background: #f5f5f5; color: #aaa; cursor: not-allowed; border-color: #e0e0e0; }
.cart-badge {
  background: #c0392b;
  color: white;
  border-radius: 8px;
  padding: 1px 5px;
  font-size: 11px;
  font-weight: 700;
  min-width: 16px;
  text-align: center;
}

/* ===== INFO CARDS ===== */
.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 8px;
  margin-bottom: 12px;
}
.info-card {
  background: #f8f8f8;
  border: 1px solid #d0d0d0;
  border-radius: 3px;
  padding: 10px 14px;
  color: #1f1f1f;
  border-left: 3px solid #217346;
}
.info-card:nth-child(2) { border-left-color: #2d9a5f; }
.info-card:nth-child(3) { border-left-color: #5a9e7a; }
.info-card:nth-child(4) { border-left-color: #155724; }
.info-value { font-size: 20px; font-weight: 700; margin-bottom: 2px; color: #217346; }
.info-label { font-size: 11px; color: #666; font-weight: 500; }

/* ===== HIDDEN COLUMNS PANEL ===== */
.hidden-columns {
  background: #fffdf0;
  border: 1px solid #d4a017;
  border-radius: 3px;
  padding: 6px 10px;
  margin-bottom: 8px;
  display: none;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}
.hidden-columns-label { font-size: 11px; font-weight: 600; color: #7d5a00; }
.restore-column-btn {
  padding: 3px 7px;
  background: white;
  border: 1px solid #d4a017;
  border-radius: 3px;
  font-size: 11px;
  font-weight: 500;
  color: #7d5a00;
  cursor: pointer;
  transition: background 0.12s;
}
.restore-column-btn:hover { background: #fff3cd; border-color: #b8860b; }

/* ===== LEGEND ===== */
.legend-panel {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: flex-start;
  background: #f8f8f8;
  border: 1px solid #d0d0d0;
  border-radius: 3px;
  padding: 6px 12px;
  margin-bottom: 10px;
  font-size: 12px;
}
.legend-item { display: flex; align-items: center; gap: 5px; white-space: normal; max-width: 500px; line-height: 1.3; }
.legend-swatch { width: 16px; height: 16px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; }

/* ===== TABLE ===== */
.table-wrapper {
  overflow-x: auto;
  border-radius: 0;
  border: 1px solid #d0d0d0;
  max-height: 200vh;
}
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 700px;
  font-size: 13px;
}
th {
  background: #217346;
  padding: 5px 8px;
  text-align: left;
  font-weight: 600;
  font-size: 11px;
  color: #fff;
  border-bottom: 2px solid #185c38;
  border-right: 1px solid #185c38;
  position: sticky;
  top: 0;
  z-index: 10;
  letter-spacing: 0.2px;
  max-width: 160px;
  overflow: visible;
  vertical-align: top;
}
th:last-child { border-right: none; }
th.col-barcode { min-width: 140px; max-width: 140px; cursor: pointer; user-select: none; }
th.col-barcode:hover { background: #185c38; }
th.col-name { min-width: 320px; max-width: 320px; }
th.col-actions { min-width: 55px; max-width: 55px; }
.column-header { display: flex; flex-direction: column; gap: 2px; min-width: 80px; }
th.col-meta, th.col-my-price { min-width: 55px; max-width: 55px; }
th.col-meta .column-header, th.col-my-price .column-header { min-width: 40px; }
.column-header-title { display: flex; align-items: center; gap: 3px; }
.column-name-text { overflow: hidden; text-overflow: ellipsis; white-space: normal; word-break: break-word; font-size: 10px; line-height: 1.3; color: rgba(255,255,255,0.9); }
.column-file-name { font-size: 10px; color: rgba(255,255,255,0.75); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-transform: none; letter-spacing: 0; border-bottom: 1px solid rgba(255,255,255,0.25); padding-bottom: 2px; margin-bottom: 2px; }
.column-file-name--my-price { color: rgba(255,255,255,0.95); font-style: italic; }

td {
  padding: 5px 8px;
  border-bottom: 1px solid #e0e0e0;
  border-right: 1px solid #e8e8e8;
  font-size: 13px;
  color: #1f1f1f;
  max-width: 150px;
  vertical-align: top;
}
td:last-child { border-right: none; }
td.col-barcode { min-width: 140px; max-width: 140px; }
td.col-name { min-width: 320px; max-width: 320px; line-height: 1.3; padding: 0; }
.name-cell { width: 100%; }
.name-item { padding: 4px 8px; border-bottom: 1px solid #e8e8e8; }
.name-item:last-child { border-bottom: none; }
.name-compact { padding: 4px 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
td.col-actions { min-width: 44px; max-width: 44px; }

tr { border-top: 1px solid #e8e8e8; }
tr.group-border-top { border-top: 2px solid #b0b8c1; }
tr.group-border-bottom { border-bottom: 2px solid #b0b8c1; }
tr:hover { background: #f0f7f2; }
tr.my-price-row { background: #f0faf2; }
tr.my-price-row:hover { background: #e4f4ea; }
tr.in-cart { background: #d8f0de; }
tr.in-cart:hover { background: #c8e8d0; }
tr.duplicate-row { background: #fce8e6 !important; }
tr.duplicate-row:hover { background: #f8d8d5 !important; }
tr.duplicate-row.in-cart { background: #f5c6c2 !important; }
tr.duplicate-row.in-cart:hover { background: #f0b8b4 !important; }
tr.synonym-row { background: #e8f4ff !important; }
tr.synonym-row:hover { background: #d8ecff !important; }
tr.synonym-row.in-cart { background: #c5e2ff !important; }
tr.synonym-row.in-cart:hover { background: #b5d8ff !important; }

/* ===== MULTI-VALUE ===== */
.multi-value-container { display: flex; flex-direction: column; gap: 4px; }
.value-variant { display: flex; flex-direction: column; border-bottom: 1px dashed #e8e0fa; padding-bottom: 2px; position: relative; padding-right: 15px; }
.div-wrapper { position: absolute; top: 0; right: 0; width: 14px; height: 14px; overflow: hidden; }
.div-icon { color: #e11d48; font-size: 14px; line-height: 1; font-weight: bold; text-align: center; pointer-events: none; }
.div-select { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; font-size: 16px; }
.value-variant:last-child { border-bottom: none; padding-bottom: 0; }
.price-val.is-min { color: #16a34a; font-weight: 700; }
.price-clickable { cursor: pointer; transition: all 0.15s; }
.price-clickable:hover { background: #eaf4ee; padding: 2px 4px; margin: -2px -4px; border-radius: 3px; }

/* ===== CART BUTTON ===== */
.cart-btn { background: transparent; color: #217346; border: none; padding: 1px; border-radius: 3px; cursor: pointer; font-size: 13px; line-height: 1; transition: background 0.15s; }
.cart-btn:hover { background: #eaf4ee; }
.cart-btn.in-cart { color: #155724; }

/* ===== BARCODE CELL ===== */
.barcode-cell { display: flex; align-items: center; gap: 4px; }
.barcode-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.copy-btn { border: 1px solid #c0c0c0; background: #f8f8f8; border-radius: 3px; padding: 2px 5px; font-size: 11px; cursor: pointer; color: #555; flex-shrink: 0; }
.copy-btn:hover { background: #eaf4ee; border-color: #217346; color: #155724; }

/* ===== HIDDEN BARCODE COLS ===== */
.hidden-barcode-col { display: none; }

/* ===== EMPTY STATE ===== */
.empty-state { text-align: center; padding: 40px 20px; color: #888; }
.empty-state-icon { font-size: 42px; margin-bottom: 10px; }
.empty-state h3 { font-size: 16px; font-weight: 600; margin-bottom: 6px; color: #1f1f1f; }
.empty-state p { font-size: 13px; }

/* ===== AUTO DIV BADGE ===== */
.auto-div-badge { display: inline-block; margin-left: 4px; color: #ffcc00; font-weight: 900; font-size: 13px; line-height: 1; text-shadow: 0 1px 0 rgba(0,0,0,0.15); }

/* ===== RESPONSIVE ===== */
@media (max-width: 900px) { .upload-section { grid-template-columns: 1fr; } .container { margin: 8px 6px 0; padding: 12px; } }
@media (max-width: 768px) { .info-grid { grid-template-columns: repeat(2, 1fr); } }



/* ‚îÄ‚îÄ Tutorial tooltip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#tutorialTooltip {
    position: fixed;
    z-index: 999999;
    background: #0f172a;
    color: #e2e8f0;
    border: 1px solid #334155;
    border-radius: 10px;
    padding: 10px 14px;
    max-width: 320px;
    font-size: 13px;
    line-height: 1.5;
    box-shadow: 0 8px 32px rgba(0,0,0,.45);
    pointer-events: none;
    opacity: 0;
    transition: opacity .15s;
}
#tutorialTooltip.visible { opacity: 1; }
#tutorialTooltip .tt-title {
    font-weight: 700;
    font-size: 13px;
    color: #7dd3fc;
    margin-bottom: 4px;
}
#tutorialTooltip .tt-body { color: #cbd5e1; font-size: 12px; }
body.tutorial-active * { cursor: help !important; }
body.tutorial-active button, body.tutorial-active input,
body.tutorial-active .file-input-wrapper { cursor: help !important; }
#tutorialBtn.active { background: #f59e0b; color: #fff; border-color: #d97706; }
#tutorialBtn.active:hover { background: #d97706; }

</style>
</head>
<body>
<nav class="app-nav">
  <a href="https://erofly83-arch.github.io/obrezatel/">Excel –≤ CSV</a>
  <a href="https://erofly83-arch.github.io/pricematcher/" class="nav-active">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</a>
  <a href="https://erofly83-arch.github.io/poiskovikexcel/">–°–∏–Ω–æ–Ω–∏–º—ã</a>
</nav>
<div class="container">
    <h1>üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω</h1>

    <div class="upload-section">

        <div class="upload-card synonyms">
            <label class="upload-label">üîó –°–∏–Ω–æ–Ω–∏–º—ã <span class="upload-label-hint">–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</span></label>
            <div class="file-input-wrapper">
                <input type="file" id="synonymsInput" accept=".json"/>
                <div class="file-input-display" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª synonyms.json —Å –≥—Ä—É–ø–ø–∞–º–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤">
                    <span>üß© synonyms.json</span>
                </div>
            </div>
            <div id="synonymsStatus" class="upload-status upload-status--idle">–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>
        </div>

        <div class="upload-card my-price">
            <label class="upload-label">üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å</label>
            <div class="file-input-wrapper">
                <input type="file" id="myPriceInput" accept=".csv,.xlsx,.xls"/>
                <div class="file-input-display" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∞—à –ø—Ä–∞–π—Å-—Ñ–∞–π–ª">
                    <span>üìÑ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</span>
                </div>
            </div>
            <div id="myPriceStatus" class="upload-status upload-status--idle">–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω</div>
        </div>

        <div class="upload-card suppliers">
            <label class="upload-label">üì¶ –ü—Ä–∞–π—Å—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</label>
            <div class="file-input-wrapper">
                <input type="file" id="competitorInput" multiple accept=".csv,.xlsx,.xls"/>
                <div class="file-input-display" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤">
                    <span>üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</span>
                </div>
            </div>
            <div id="competitorStatus" class="upload-status upload-status--idle">–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>
        </div>

    </div>

    <div id="infoPanel" class="info-grid" style="display:none;">
        <div class="info-card">
            <div class="info-value" id="productCount">0</div>
            <div class="info-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</div>
        </div>
        <div class="info-card">
            <div class="info-value" id="fileCount">0</div>
            <div class="info-label">–§–∞–π–ª–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</div>
        </div>
        <div class="info-card">
            <div class="info-value" id="columnCount">0</div>
            <div class="info-label">–ö–æ–ª–æ–Ω–æ–∫ –¥–∞–Ω–Ω—ã—Ö</div>
        </div>
        <div class="info-card">
            <div class="info-value" id="matchCount">0</div>
            <div class="info-label">–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</div>
        </div>
    </div>

    <div class="controls">
        <!-- –ì–†–£–ü–ü–ê: –§–∏–ª—å—Ç—Ä—ã –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
        <div class="controls-group">
            <span class="controls-group-label">üîç –§–∏–ª—å—Ç—Ä—ã</span>
            <button id="sortMatchesBtn" class="btn btn-secondary" disabled
                    title="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞ —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–∞—Ö">
                <span class="icon">üîÑ</span> –°–æ–≤–ø–∞–¥–µ–Ω–∏—è
            </button>
            <button id="bigDiffBtn" class="btn btn-secondary" disabled
                    title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã —Å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è–º–∏, –≥–¥–µ —Ä–∞–∑–Ω–∏—Ü–∞ —Ü–µ–Ω –±–æ–ª—å—à–µ 10%">
                <span class="icon">üìä</span> –ë–æ–ª—å—à–∞—è —Ä–∞–∑–Ω–∏—Ü–∞
            </button>
            <button id="showMyPriceBtn" class="btn btn-secondary" disabled
                    title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–∞–π—Å–∞">
                <span class="icon">‚≠ê</span> –ú–æ–π –ø—Ä–∞–π—Å
            </button>
            <button id="showCartBtn" class="btn btn-secondary" disabled
                    title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –≤ –∫–æ—Ä–∑–∏–Ω—É">
                <span class="icon">üõíüëÅÔ∏è</span> –ö–æ—Ä–∑–∏–Ω–∞
            </button>
            <button id="maxCoverageBtn" class="btn btn-secondary" disabled
                    title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Ü–µ–Ω–∞ –Ω–∞ —Ç–æ–≤–∞—Ä">
                <span class="icon">üìä</span> –ü–æ–∏—Å–∫ –Ω–æ–≤–∏–Ω–æ–∫
            </button>
        </div>

        <!-- –ì–†–£–ü–ü–ê: –í–∏–¥ —Ç–∞–±–ª–∏—Ü—ã -->
        <div class="controls-group">
            <span class="controls-group-label">üñ•Ô∏è –í–∏–¥</span>
            <button id="compactMatchesBtn" class="btn btn-secondary" disabled
                    title="–£–º–µ–Ω—å—à–∏—Ç—å –≤—ã—Å–æ—Ç—É —Å—Ç—Ä–æ–∫ —Å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è–º–∏, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É">
                <span class="icon">üìè</span> –ö–æ–º–ø–∞–∫—Ç–Ω–æ
            </button>
            <button id="toggleFileBarcodesBtn" class="btn btn-secondary" disabled
                    title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–æ–ª–æ–Ω–∫–∏ —Å–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞–º–∏ –ø–æ —Ñ–∞–π–ª–∞–º">
                <span class="icon">üîé</span> –®–ö –ø–æ —Ñ–∞–π–ª–∞–º
            </button>
            <button id="sortPayBtn" class="btn btn-secondary" disabled title="–ù–∞–ª ‚Üí –ë–Ω"><span class="icon">üí≥</span> –ù–∞–ª/–ë–Ω</button>
        </div>

        <!-- –ì–†–£–ü–ü–ê: –≠–∫—Å–ø–æ—Ä—Ç -->
        <div class="controls-group export-group">
            <span class="controls-group-label">üíæ –≠–∫—Å–ø–æ—Ä—Ç</span>
            <button id="exportMyPriceBtn" class="btn btn-success" disabled
                    title="–°–∫–∞—á–∞—Ç—å Excel —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–∞–π—Å–∞ –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏">
                <span class="icon">‚≠êüíæ</span> –ú–æ–π –ø—Ä–∞–π—Å
            </button>
            <button id="exportAllBtn" class="btn btn-success" disabled
                    title="–°–∫–∞—á–∞—Ç—å Excel —Å–æ –≤—Å–µ–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏ –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏">
                <span class="icon">üíæ</span> –í—Å—ë
            </button>
            <button id="exportCurrentBtn" class="btn btn-success" disabled
                    title="–°–∫–∞—á–∞—Ç—å Excel —Å —É—á—ë—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∏—Å–∫–∞, —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏">
                <span class="icon">üîçüíæ</span> –¢–µ–∫—É—â–∏–π –≤–∏–¥
            </button>
            <button id="exportCartBtn" class="btn btn-warning" disabled
                    title="–°–∫–∞—á–∞—Ç—å Excel —Ç–æ–ª—å–∫–æ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã">
                <span class="icon">üõíüíæ</span> –ö–æ—Ä–∑–∏–Ω–∞
                <span id="cartBadge" class="cart-badge" style="display:none;">0</span>
            </button>
        </div>

        <!-- –ì–†–£–ü–ü–ê: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω–æ–π –∏ —Å–±—Ä–æ—Å -->
        <div class="controls-group" id="tutorialGroup">
            <span class="controls-group-label">‚ùì –ü–æ–º–æ—â—å</span>
            <button id="tutorialBtn" class="btn btn-secondary" title="–í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –æ–±—É—á–µ–Ω–∏—è: –Ω–∞–≤–µ–¥–∏—Ç–µ –º—ã—à—å –Ω–∞ –ª—é–±–æ–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–¥—Å–∫–∞–∑–∫–∞">
                üéì –û–±—É—á–µ–Ω–∏–µ
            </button>
        </div>

        <div class="controls-group danger-group">
            <span class="controls-group-label">‚ö†Ô∏è –û—á–∏—Å—Ç–∫–∞</span>
            <button id="clearCartBtn" class="btn btn-danger" disabled
                    title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã">
                <span class="icon">üõíüóëÔ∏è</span> –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
            </button>
            <button id="clearBtn" class="btn btn-danger" disabled
                    title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ">
                <span class="icon">üóëÔ∏è</span> –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë
            </button>
        </div>
    </div>

    <div id="hiddenColumnsPanel" class="hidden-columns">
        <span class="hidden-columns-label">üîç –°–∫—Ä—ã—Ç—ã–µ –∫–æ–ª–æ–Ω–∫–∏:</span>
        <div id="hiddenColumnsList"></div>
    </div>

    <div class="legend-panel" id="legendPanel" style="display:none;">
        <strong style="font-size:12px;color:#555;margin-right:4px;">–ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫:</strong>
        <div class="legend-item"><div class="legend-swatch" style="background:#e6f7ff;"></div><span><b>–°–∏–Ω–æ–Ω–∏–º—ã</b> ‚Äî –°–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ —Å–∏–Ω–æ–Ω–∏–º–∞–º</span></div>
        <div class="legend-item"><div class="legend-swatch" style="background:#ffe6f0;"></div><span><b>–î—É–±–ª—å —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</b> ‚Äî –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ –æ–¥–Ω–æ–º –ø—Ä–∞–π—Å–µ</span></div>
        <div class="legend-item"><div class="legend-swatch" style="background:#fff;border:2px solid #28a745;"></div><span style="color:#28a745;font-weight:600;">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞</span></div>
    </div>
    <div class="search-box search-box--above-table">
        <input type="text" id="searchInput" class="search-input"
               placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–æ–≤–∞—Ä–∞..."
               title="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ —á–∞—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤">
    </div>

    <div id="tableContainer">
        <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç—ã</h3>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à –ø—Ä–∞–π—Å –∏ —Ñ–∞–π–ª—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</p>
        </div>
    </div>
</div>

<script>
    let barcodeAliasMap=new Map(),synonymsLoaded=false,_usingBuiltin=false;
    function _buildAliasMap(j){const m=new Map();Object.keys(j).forEach(k=>{const mk=String(k).trim();if(!mk)return;m.set(mk,mk);const l=j[k];if(Array.isArray(l))l.forEach(b=>{const v=String(b).trim();if(v)m.set(v,mk);});});return m;}
    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∏–Ω–æ–Ω–∏–º—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã

    function resetBarcodeAliases(){
        barcodeAliasMap=new Map();synonymsLoaded=false;_usingBuiltin=false;
        const s=document.getElementById('synonymsStatus');
        if(s){s.className='upload-status upload-status--idle';s.textContent='–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã';}
    }

    function loadBarcodeAliasesFromFile(file) {
        const status = document.getElementById('synonymsStatus');
        if (!file) {
            resetBarcodeAliases();
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const json = JSON.parse(text);
                barcodeAliasMap=_buildAliasMap(json);synonymsLoaded=true;_usingBuiltin=false;
                if(status){status.className='upload-status upload-status--ok';status.textContent='‚úÖ –ì—Ä—É–ø–ø: '+Object.keys(json).length;}
                if (allFilesData.length > 0) {
                    processData();
                    renderTable();
                    updateUI();
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è synonyms.json:', err);
                resetBarcodeAliases();
                if (status) {
                    status.className = 'upload-status upload-status--error';
                    status.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON';
                }
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ —Å–∏–Ω–æ–Ω–∏–º–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç JSON.');
            }
        };
        reader.onerror = () => {
            resetBarcodeAliases();
            if (status) {
                status.className = 'upload-status upload-status--error';
                status.textContent = '‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞';
            }
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª —Å–∏–Ω–æ–Ω–∏–º–æ–≤.');
        };
        reader.readAsText(file, 'utf-8');
    }

    function canonicalizeBarcode(rawBarcode) {
        if (rawBarcode === undefined || rawBarcode === null) return { canonical: rawBarcode, wasSynonym: false };
        const b = String(rawBarcode).trim();
        if (!synonymsLoaded) return { canonical: b, wasSynonym: false };
        const canon = barcodeAliasMap.get(b);
        if (canon && canon !== b) {
            return { canonical: canon, wasSynonym: true };
        }
        return { canonical: b, wasSynonym: false };
    }

    // ======== –û–°–ù–û–í–ù–û–ô –ö–û–î –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ========

    let myPriceData = null;
    let competitorFilesData = [];
    let allFilesData = [];
    let groupedData = [];
    let allColumns = [];
    let visibleColumns = new Set();
    let cart = new Set();
    let barcodeColumn = null;
    let nameColumn = null;
    let stockColumn = null; // –∫–æ–ª–æ–Ω–∫–∞ –æ—Å—Ç–∞—Ç–∫–∞ –≤ –ú–û–Å–ú –ø—Ä–∞–π—Å–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    let sortMode = 'default';
    let compactMatches = false;
    let searchQuery = '';
    let barcodeSortOrder = 0;
    let showFileBarcodes = false; // UI: –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –ª–∏ –∫–æ–ª–æ–Ω–∫–∏ –®–ö –ø–æ —Ñ–∞–π–ª–∞–º
    let filterNewItems = false;   // –§–∏–ª—å—Ç—Ä –Ω–æ–≤–∏–Ω–æ–∫: –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ, —á–µ–≥–æ –Ω–µ—Ç –≤ –º–æ—ë–º –ø—Ä–∞–π—Å–µ

    const myPriceInput = document.getElementById('myPriceInput');
    const competitorInput = document.getElementById('competitorInput');
    const synonymsInput = document.getElementById('synonymsInput');
    const searchInput = document.getElementById('searchInput');
    const sortMatchesBtn = document.getElementById('sortMatchesBtn');
    const bigDiffBtn = document.getElementById('bigDiffBtn');
    const showMyPriceBtn = document.getElementById('showMyPriceBtn');
    const showCartBtn = document.getElementById('showCartBtn');
    const compactMatchesBtn = document.getElementById('compactMatchesBtn');
    const maxCoverageBtn = document.getElementById('maxCoverageBtn');
    const toggleFileBarcodesBtn = document.getElementById('toggleFileBarcodesBtn');
    const exportMyPriceBtn = document.getElementById('exportMyPriceBtn');
    const exportAllBtn = document.getElementById('exportAllBtn');
    const exportCurrentBtn = document.getElementById('exportCurrentBtn');
    const exportCartBtn = document.getElementById('exportCartBtn');
    const clearCartBtn = document.getElementById('clearCartBtn');
    const sortPayBtn=document.getElementById('sortPayBtn');
    const downloadSynBtn=document.getElementById('downloadSynBtn');
    const resetSynBtn=document.getElementById('resetSynBtn');
    const clearBtn=document.getElementById('clearBtn');
    const infoPanel = document.getElementById('infoPanel');
    const hiddenColumnsPanel = document.getElementById('hiddenColumnsPanel');
    const hiddenColumnsList = document.getElementById('hiddenColumnsList');
    const tableContainer = document.getElementById('tableContainer');
    const cartBadge = document.getElementById('cartBadge');

    const BARCODE_SYNONYMS = [
        '—à—Ç—Ä–∏—Ö-–∫–æ–¥', '—à—Ç—Ä–∏—Ö–∫–æ–¥', 'barcode', '–®—Ç—Ä–∏—Ö-–∫–æ–¥', '–®—Ç—Ä–∏—Ö–∫–æ–¥', 'Barcode',
        '–∫–æ–¥', '–ö–æ–¥', 'ean', 'EAN', 'ean13', 'EAN13', '—à—Ç—Ä–∏—Ö –∫–æ–¥', '–®—Ç—Ä–∏—Ö –∫–æ–¥',
        'bar_code', 'bar-code', 'product_code', 'sku', 'SKU', '–∞—Ä—Ç–∏–∫—É–ª', '–ê—Ä—Ç–∏–∫—É–ª'
    ];

    const NAME_SYNONYMS = [
        '–Ω–∞–∑–≤–∞–Ω–∏–µ', 'name', '–ù–∞–∑–≤–∞–Ω–∏–µ', 'Name', '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ',
        '—Ç–æ–≤–∞—Ä', '–¢–æ–≤–∞—Ä', 'product', 'Product', '–æ–ø–∏—Å–∞–Ω–∏–µ', '–û–ø–∏—Å–∞–Ω–∏–µ',
        'product_name', 'title', 'Title', '–∏–º—è', '–ò–º—è'
    ];

    myPriceInput.addEventListener('change', handleMyPriceUpload);
    competitorInput.addEventListener('change', handleCompetitorUpload);
    synonymsInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        loadBarcodeAliasesFromFile(file);
    });
    searchInput.addEventListener('input', handleSearch);
    sortMatchesBtn.addEventListener('click', toggleSortMatches);
    bigDiffBtn.addEventListener('click', toggleBigDiff);
    showMyPriceBtn.addEventListener('click', toggleMyPriceView);
    showCartBtn.addEventListener('click', toggleCartView);
    compactMatchesBtn.addEventListener('click', toggleCompactMatches);
    maxCoverageBtn.addEventListener('click', toggleMaxCoverage);
    toggleFileBarcodesBtn.addEventListener('click', toggleFileBarcodesVisibility);
exportMyPriceBtn.addEventListener('click', async () => await generateExcel('myprice'));
exportAllBtn.addEventListener('click', async () => await generateExcel('all'));
    exportCurrentBtn.addEventListener('click', async () => await generateExcel('current'));
exportCartBtn.addEventListener('click', async () => await generateExcel('cart'));

    clearCartBtn.addEventListener('click', clearCart);
    sortPayBtn.addEventListener('click',applySortByPayment);
    downloadSynBtn && downloadSynBtn.addEventListener('click',downloadCurrentSynonyms);
    resetSynBtn && resetSynBtn.addEventListener('click',()=>{resetBarcodeAliases();document.getElementById('synonymsInput').value='';if(allFilesData.length>0){processData();renderTable();updateUI();}});
    clearBtn.addEventListener('click', clearAll);

    function normalizeString(str) {
        return str?.toString().trim().toLowerCase() || '';
    }



// --- Deduplicate same-price duplicates inside one supplier file ---
const PRICE_COL_SYNONYMS = [
  '—Ü–µ–Ω–∞', 'price', 'cost', '—Å—Ç–æ–∏–º–æ—Å—Ç—å', '–ø—Ä–∞–π—Å', '–æ–ø—Ç', '–æ–ø—Ç–æ–≤', '—Ä–æ–∑–Ω', '—Ä—Ä—Ü', '—Ä—Ü',
  'retail', 'wholesale'
];

const MY_PRICE_FILE_NAME = 'üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å';
const META_STOCK_KEY = '__meta_stock';
const META_TRANSIT_KEY = '__meta_transit';
const STOCK_COL_SYNONYMS = ['–æ—Å—Ç–∞—Ç–æ–∫', '–æ—Å—Ç–∞—Ç–∫–∏', '–Ω–∞–ª–∏—á–∏–µ', '—Å–∫–ª–∞–¥'];


const PRICE_DECIMALS = 1;

function roundPrice(n) {
  const m = 10 ** PRICE_DECIMALS;
  return Math.round(n * m) / m;
}


function isPriceLikeColumn(colName) {
  const s = String(colName || '').toLowerCase();
  // –ò—Å–∫–ª—é—á–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏
  const isStock = STOCK_COL_SYNONYMS.some(k => s.includes(k));
  if (isStock) return false;
  return PRICE_COL_SYNONYMS.some(k => s.includes(k));
}


function parsePriceNumber(val) {
  const s = String(val ?? '').trim();
  if (!s) return null;
  const n = parseFloat(s.replace(/[^0-9.,-]/g, '').replace(',', '.'));
  return Number.isFinite(n) ? n : null;
}

function getColPayGroup(col){const n=(col.displayName||col.columnName||"").toLowerCase();if(n.includes("–Ω–∞–ª"))return"–Ω–∞–ª";if(n.includes("–±–Ω"))return"–±–Ω";return"other";}
function extractPackQtyFromName(name) {
  const s = String(name ?? '');
  // –õ—é–±–æ–µ —á–∏—Å–ª–æ –ø–µ—Ä–µ–¥ "—à—Ç"/"—à—Ç—É–∫": 30—à—Ç/24–±–ª, 30 —à—Ç, 30 —à—Ç.
  const m = s.match(/(\d{1,6})\s*(?:—à—Ç|—à—Ç—É–∫)(?=[^0-9A-Za-z–ê-–Ø–∞-—è]|$)/i);
  if (!m) return null;
  const q = parseInt(m[1], 10);
  if (!Number.isFinite(q) || q <= 1) return null;
  return q;
}


function round2(n) {
  return Math.round(n * 100) / 100;
}

function samePrice(a, b) {
  const na = parsePriceNumber(a);
  const nb = parsePriceNumber(b);
  if (na !== null && nb !== null) return roundPrice(na) === roundPrice(nb);
  return String(a ?? '').trim() === String(b ?? '').trim();
}
    function removeFileExtension(fileName) {
        return fileName.replace(/\.(csv|xlsx|xls)$/i, '');
    }

    function handleSearch(e) {
        searchQuery = e.target.value.toLowerCase().trim();
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    async function handleMyPriceUpload(e) {
        try {
            const file = e.target.files[0];
            if (!file) return;
            myPriceData = await parseFile(file, 'üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å');
        const _mpSt=document.getElementById('myPriceStatus');if(_mpSt){_mpSt.className='upload-status upload-status--ok';_mpSt.textContent='‚úÖ '+file.name;}
            processAllData();
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:", error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: " + error.message);
        }
    }

    async function handleCompetitorUpload(e) {
        try {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            competitorFilesData = [];
            for (const file of files) {
                const fileData = await parseFile(file, removeFileExtension(file.name));
                competitorFilesData.push(fileData);
            }
            const _cSt=document.getElementById('competitorStatus');
            if(_cSt){_cSt.className='upload-status upload-status--ok';_cSt.textContent='‚úÖ '+files.length+' —Ñ–∞–π–ª'+(files.length===1?'':'–∞'+(files.length<5?'':'–æ–≤'))+'  ('+files.map(f=>f.name.replace(/\.(csv|xlsx?)/i,'')).join(', ').substring(0,60)+')';}
            processAllData();
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:", error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤: " + error.message);
        }
    }

    async function parseFile(file, fileName) {
        try {
            if (file.name.endsWith('.csv')) {
                return await parseCSV(file, fileName);
            } else {
                return await parseExcel(file, fileName);
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:", error);
            throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª");
        }
    }

    function parseCSV(file, fileName) {
        return new Promise(resolve => {
            Papa.parse(file, {
                header: true,
                encoding: 'UTF-8',
                skipEmptyLines: true,
                complete: (results) => {
                    resolve({
                        fileName,
                        data: results.data,
                        isMyPrice: fileName === 'üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å'
                    });
                }
            });
        });
    }

    function parseExcel(file, fileName) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                resolve({fileName, data: jsonData, isMyPrice: fileName === 'üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å'});
            };
            reader.readAsArrayBuffer(file);
        });
    }

    function processAllData() {
        if (!myPriceData && competitorFilesData.length === 0) return;
        allFilesData = [];
        if (myPriceData) allFilesData.push(myPriceData);
        allFilesData = allFilesData.concat(competitorFilesData);

        autoDetectColumns();
        processData();
        updateHiddenColumnsPanel();
        renderTable();
        updateUI();
        showCompletionToast();
    }

    function autoDetectColumns() {
        allColumns = [];
        visibleColumns.clear();
        stockColumn = null;
        barcodeColumn = null;
        nameColumn = null;

        if (allFilesData.length > 0 && allFilesData[0].data.length > 0) {
            const firstFileColumns = Object.keys(allFilesData[0].data[0]);
            barcodeColumn = firstFileColumns.find(col =>
                BARCODE_SYNONYMS.some(syn => col.toLowerCase().includes(syn.toLowerCase()))
            ) || firstFileColumns[0];

            nameColumn = firstFileColumns.find(col =>
                col !== barcodeColumn &&
                NAME_SYNONYMS.some(syn => col.toLowerCase().includes(syn.toLowerCase()))
            ) || (firstFileColumns.length > 1 ? firstFileColumns[1] : firstFileColumns[0]);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–ª—å–∫–æ –≤ –º–æ–µ–º –ø—Ä–∞–π—Å–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if (myPriceData && myPriceData.data && myPriceData.data.length > 0) {
            const myCols = Object.keys(myPriceData.data[0]);
            stockColumn = myCols.find(c => STOCK_COL_SYNONYMS.some(s => String(c).toLowerCase().includes(s))) || null;
        }

        }

        allFilesData.forEach(({fileName, data}) => {
            if (data.length > 0) {
                const fileColumns = Object.keys(data[0]);
                fileColumns.forEach(colName => {
            if (colName === barcodeColumn || colName === nameColumn) return;
            if (fileName === MY_PRICE_FILE_NAME && stockColumn && colName === stockColumn) return;
                    const colKey = `${fileName}|${colName}`;
                    allColumns.push({
                        fileName,
                        columnName: colName,
                        displayName: `${fileName} - ${colName}`,
                        key: colKey
                    });
                    visibleColumns.add(colKey);
                });
            }
        });
    

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –û—Å—Ç–∞—Ç–æ–∫ –∏ –í –ø—É—Ç–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –º–æ–µ–º –ø—Ä–∞–π—Å–µ –µ—Å—Ç—å –æ—Å—Ç–∞—Ç–æ–∫)
        if (stockColumn) {
            const stockCol = { fileName: MY_PRICE_FILE_NAME, columnName: '–û—Å—Ç–∞—Ç–æ–∫', displayName: '–û—Å—Ç–∞—Ç–æ–∫', key: META_STOCK_KEY, metaType: 'stock' };
            const transitCol = { fileName: MY_PRICE_FILE_NAME, columnName: '–í –ø—É—Ç–∏', displayName: '–í –ø—É—Ç–∏', key: META_TRANSIT_KEY, metaType: 'transit' };
            allColumns.unshift(transitCol);
            allColumns.unshift(stockCol);
            visibleColumns.add(META_STOCK_KEY);
            visibleColumns.add(META_TRANSIT_KEY);
        }
        const _am=allColumns.filter(c=>c.metaType);const _ap=allColumns.filter(c=>!c.metaType&&c.fileName===MY_PRICE_FILE_NAME);const _as=allColumns.filter(c=>!c.metaType&&c.fileName!==MY_PRICE_FILE_NAME);
        _as.sort((a,b)=>{const o={"–Ω–∞–ª":0,"–±–Ω":1,"other":2};return(o[getColPayGroup(a)]??2)-(o[getColPayGroup(b)]??2);});allColumns=[..._am,..._ap,..._as];
}

    function toggleColumn(colKey) {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (visibleColumns.has(colKey)) visibleColumns.delete(colKey);
        else visibleColumns.add(colKey);
        updateHiddenColumnsPanel();
        processData();
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function updateHiddenColumnsPanel() {
        const hiddenCols = allColumns.filter(col => !visibleColumns.has(col.key));
        if (hiddenCols.length > 0) {
            let html = '';
            hiddenCols.forEach(col => {
                html += `<button class="restore-column-btn" onclick="toggleColumn('${col.key}')" title="–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É ${col.displayName}">
                        ‚Ü©Ô∏è ${col.displayName}
                    </button>`;
            });
            hiddenColumnsList.innerHTML = html;
            hiddenColumnsPanel.style.display = 'flex';
        } else {
            hiddenColumnsPanel.style.display = 'none';
        }
    }

    function processData() {
        const barcodeMap = new Map();

        allFilesData.forEach(({fileName, data, isMyPrice}) => {
            data.forEach((row, index) => {
                let rawBarcode = row[barcodeColumn];
                if (!rawBarcode) return;

                const { canonical, wasSynonym } = canonicalizeBarcode(rawBarcode);
                const barcode = canonical;

                if (!barcodeMap.has(barcode)) {
                    barcodeMap.set(barcode, {
                        barcode,
                        names: [],
                        values: new Map(),
                        isInMyPrice: false,
                        myPriceOrder: -1,
                        filesWithBarcode: new Set(),
                        namesByFile: new Map(),
                        originalBarcodesByFile: new Map(),
                        isSynonym: false
                    });
                }

                const item = barcodeMap.get(barcode);
                item.filesWithBarcode.add(fileName);
                item.originalBarcodesByFile.set(fileName, rawBarcode);

                if (wasSynonym) {
                    item.isSynonym = true;
                }

                if (isMyPrice) {
                    item.isInMyPrice = true;
                    item.myPriceOrder = index;
                }

                const currentRowName = row[nameColumn];

                    // –û—Å—Ç–∞—Ç–æ–∫ —Ç–æ–ª—å–∫–æ –∏–∑ –º–æ–µ–≥–æ –ø—Ä–∞–π—Å–∞ (–µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –Ω–∞–π–¥–µ–Ω–∞)
                    if (isMyPrice && stockColumn) {
                        const stockVal = row[stockColumn];
                        if (!item.values.has(META_STOCK_KEY)) item.values.set(META_STOCK_KEY, []);
                        const arrStock = item.values.get(META_STOCK_KEY);
                        arrStock.length = 0;
                        arrStock.push({ val: (stockVal === undefined || stockVal === null) ? '' : stockVal, rowName: currentRowName, originalBarcode: rawBarcode, meta: true });
                    }
                if (currentRowName) {
                    const nameObj = {fileName, name: currentRowName};
                    if (!item.names.some(n => n.fileName === fileName && n.name === currentRowName)) {
                        item.names.push(nameObj);
                    }
                    if (!item.namesByFile.has(fileName)) {
                        item.namesByFile.set(fileName, currentRowName);
                    }

                    if (isMyPrice) {
                        // –ë–µ—Ä—ë–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ª—å–∫–æ –∏–∑ –º–æ–µ–≥–æ –ø—Ä–∞–π—Å–∞, –Ω–æ –∏—â–µ–º –Ω–µ —Ç–æ–ª—å–∫–æ –≤ nameColumn
                        const vals = Object.values(row).map(v => (v === undefined || v === null) ? '' : String(v));
                        for (const t of vals) {
                            const q = extractPackQtyFromName(t);
                            if (q) { item.packQty = q; break; }
                        }
                    }
                }

                Object.keys(row).forEach(colName => {
                    if (colName !== barcodeColumn && colName !== nameColumn) {
                        const key = `${fileName}|${colName}`;
                        const value = row[colName];
                        if (value !== undefined && value !== null && value !== '') {
                            if (!item.values.has(key)) {
                                item.values.set(key, []);
                            }
                            const arr = item.values.get(key);

                            // –î–ª—è –∫–æ–ª–æ–Ω–æ–∫ —Å —Ü–µ–Ω–æ–π: –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ü–µ–Ω—ã –Ω–µ —Å–æ–∑–¥–∞—é—Ç –Ω–æ–≤—É—é –≤–∞—Ä–∏–∞—Ü–∏—é
                            if (isPriceLikeColumn(colName)) {
                                const exists = arr.some(v => samePrice(v.val, value));
                                if (!exists) {
                                    arr.push({val: value, rowName: currentRowName, originalBarcode: rawBarcode});
                                }
                            } else {
                                arr.push({val: value, rowName: currentRowName, originalBarcode: rawBarcode});
                            }
                        }
                    }
                });
            });
        });

        groupedData = Array.from(barcodeMap.values()).map(item => {
            const visibleCols = allColumns.filter(col => visibleColumns.has(col.key));
            const numericValues = [];
            visibleCols.forEach(col => {
                const valuesArr = item.values.get(col.key);
                if (valuesArr && valuesArr.length > 0) {
                    valuesArr.forEach(vObj => {
                        const numValue = parseFloat(String(vObj.val).replace(/[^0-9.,]/g, '').replace(',', '.'));
                        if (!isNaN(numValue) && numValue > 0) {
                            numericValues.push(numValue);
                        }
                    });
                }
            });



            // –ê–≤—Ç–æ-–¥–µ–ª–µ–Ω–∏–µ: –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω "–ú–æ–π –ø—Ä–∞–π—Å" –∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä 30—à—Ç/24–±–ª),
            // —Ç–æ –¥–µ–ª–∏–º –≤—Å–µ —Ü–µ–Ω—ã –≤ —Å—Ç—Ä–æ–∫–µ, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –≤ 3 —Ä–∞–∑–∞, –Ω–∞ —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.
            const hasMyPriceLoaded = !!myPriceData;
            const packQty = (hasMyPriceLoaded && item.packQty) ? item.packQty : null;
            let autoDivFactor = null;

            if (packQty) {
                // –ê–≤—Ç–æ–ª–æ–≥–∏–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç —Å–∫—Ä—ã—Ç–∏—è –∫–æ–ª–æ–Ω–æ–∫ –≤ UI
                const cols2 = allColumns;

                // –ö–æ–ª–æ–Ω–∫–∏ —Ü–µ–Ω –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ (–º–æ–π –ø—Ä–∞–π—Å –∏—Å–∫–ª—é—á—ë–Ω, meta-–∫–æ–ª–æ–Ω–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã)
                const supplierPriceCols2 = cols2.filter(col => !col.metaType && col.fileName !== MY_PRICE_FILE_NAME && isPriceLikeColumn(col.columnName));

                // –ö–æ–ª–æ–Ω–∫–∏ —Ü–µ–Ω –≤ –º–æ—ë–º –ø—Ä–∞–π—Å–µ (–¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è)
                const myPriceCols2 = cols2.filter(col => !col.metaType && col.fileName === MY_PRICE_FILE_NAME && isPriceLikeColumn(col.columnName));

                const myNums2 = [];
                myPriceCols2.forEach(col => {
                    const arr = item.values.get(col.key);
                    if (!arr || arr.length === 0) return;
                    arr.forEach(v => {
                        const n = parsePriceNumber(v.val);
                        if (n !== null && n > 0) myNums2.push(n);
                    });
                });
                const myMin2 = myNums2.length ? Math.min(...myNums2) : null;

                const supplierNums2 = [];
                supplierPriceCols2.forEach(col => {
                    const arr = item.values.get(col.key);
                    if (!arr || arr.length === 0) return;
                    arr.forEach(v => {
                        const n = parsePriceNumber(v.val);
                        if (n !== null && n > 0) supplierNums2.push(n);
                    });
                });

                if (supplierNums2.length > 0) {
                    const minSupplier = Math.min(...supplierNums2);
                    const thresholdSupplier = minSupplier * 3;

                    // –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: –µ—Å–ª–∏ –∞–±—Å–æ–ª—é—Ç–Ω–æ –≤—Å–µ —Ü–µ–Ω—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ >= (–º–æ—è —Ü–µ–Ω–∞ * 3),
                    // —Ç–æ –¥–µ–ª–∏–º –í–°–ï —Ü–µ–Ω—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –Ω–∞ packQty.
                    const allSuppliers3xAboveMy = (myMin2 !== null) && supplierNums2.every(n => n >= myMin2 * 3);

                    let changed2 = false;
                    supplierPriceCols2.forEach(col => {
                        const arr = item.values.get(col.key);
                        if (!arr || arr.length === 0) return;
                        arr.forEach(vObj => {
                            const n = parsePriceNumber(vObj.val);
                            if (n === null || n <= 0) return;

                            if (allSuppliers3xAboveMy || n >= thresholdSupplier) {
                                if (vObj._autoDiv) return;
                                vObj._origVal = vObj.val;
                                vObj.val = roundPrice(n / packQty);
                                vObj._autoDiv = true;
                                vObj._autoDivFactor = packQty;
                                changed2 = true;
                            }
                        });
                    });

                    if (changed2) autoDivFactor = packQty;
                }
            }
            let priceDiffPercent = 0;
            if (numericValues.length > 1) {
                const minPrice = Math.min(...numericValues);
                const maxPrice = Math.max(...numericValues);
                if (minPrice > 0) {
                    priceDiffPercent = ((maxPrice - minPrice) / minPrice) * 100;
                }
            }

            const priceKeys = new Set(
                allColumns
                    .filter(c => isPriceLikeColumn(c.columnName))
                    .map(c => c.key)
            );

            const isDuplicate = false;
            const filesWithPrices = new Set();
            for (const [key, valuesArr] of item.values.entries()) {
                if (valuesArr && valuesArr.length > 0) {
                    const fileName = key.split('|')[0];
                    filesWithPrices.add(fileName);
                }
            }
            const coverageCount = filesWithPrices.size;

                        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ (–ø—É—Å—Ç—ã–µ, –µ—Å–ª–∏ –Ω–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è)
            if (stockColumn) {
                if (!item.values.has(META_STOCK_KEY)) {
                    item.values.set(META_STOCK_KEY, [{ val: '', rowName: '', originalBarcode: item.barcode, meta: true }]);
                }
                if (!item.values.has(META_TRANSIT_KEY)) {
                    item.values.set(META_TRANSIT_KEY, [{ val: '', rowName: '', originalBarcode: item.barcode, meta: true }]);
                }
            }

return { barcode: item.barcode, packQty, autoDivFactor,
                names: item.names,
                namesByFile: item.namesByFile,
                values: item.values,
                isInMyPrice: item.isInMyPrice,
                myPriceOrder: item.myPriceOrder,
                originalFileCount: item.filesWithBarcode.size,
                priceDiffPercent,
                isDuplicate,
                coverageCount,
                isSynonym: item.isSynonym,
                originalBarcodesByFile: item.originalBarcodesByFile
            };
        });
    }

    function toggleCart(barcode) {
        if (cart.has(barcode)) cart.delete(barcode);
        else cart.add(barcode);
        updateCartUI();

        const inCart = cart.has(barcode);
        document.querySelectorAll('tr[data-barcode]').forEach(row => {
            if (row.dataset.barcode !== String(barcode)) return;
            const isInMyPrice = row.dataset.inMyPrice === '1';
            const isSynonym = row.dataset.isSynonym === '1';

            row.classList.toggle('in-cart', inCart);
            row.classList.toggle('my-price-row', !inCart && isInMyPrice && !isSynonym);

            const btn = row.querySelector('.cart-btn');
            if (btn) {
                btn.textContent = inCart ? '‚úì' : 'üõí';
                btn.title = inCart ? '–£–±—Ä–∞—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É';
                btn.classList.toggle('in-cart', inCart);
            }
        });
    }

    function clearCart() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        cart.clear();
        updateCartUI();
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function updateCartUI() {
        const cartSize = cart.size;
        if (cartSize > 0) {
            cartBadge.textContent = cartSize;
            cartBadge.style.display = 'block';
            exportCartBtn.disabled = false;
            clearCartBtn.disabled = false;
            showCartBtn.disabled = false;
        } else {
            cartBadge.style.display = 'none';
            exportCartBtn.disabled = true;
            clearCartBtn.disabled = true;
            showCartBtn.disabled = true;
            if (sortMode === 'cart') {
                sortMode = 'default';
                showCartBtn.classList.remove('active');
                renderTable();
            }
        }
    }

    function toggleSortMatches() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (sortMode === 'matches') {
            sortMode = 'default';
            sortPayBtn.classList.remove('active');
        sortMatchesBtn.classList.remove('active');
        } else {
            sortMode = 'matches';
            sortMatchesBtn.classList.add('active');
            bigDiffBtn.classList.remove('active');
            showMyPriceBtn.classList.remove('active');
            showCartBtn.classList.remove('active');
        }
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleBigDiff() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (sortMode === 'bigdiff') {
            sortMode = 'default';
            bigDiffBtn.classList.remove('active');
        } else {
            sortMode = 'bigdiff';
            bigDiffBtn.classList.add('active');
            sortPayBtn.classList.remove('active');
        sortMatchesBtn.classList.remove('active');
            showMyPriceBtn.classList.remove('active');
            showCartBtn.classList.remove('active');
            maxCoverageBtn.classList.remove('active');
        }
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleMyPriceView() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (sortMode === 'myprice') {
            sortMode = 'default';
            showMyPriceBtn.classList.remove('active');
        } else {
            sortMode = 'myprice';
            showMyPriceBtn.classList.add('active');
            sortPayBtn.classList.remove('active');
        sortMatchesBtn.classList.remove('active');
            bigDiffBtn.classList.remove('active');
            showCartBtn.classList.remove('active');
            maxCoverageBtn.classList.remove('active');
        }
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleCartView() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (sortMode === 'cart') {
            sortMode = 'default';
            showCartBtn.classList.remove('active');
        } else {
            sortMode = 'cart';
            showCartBtn.classList.add('active');
            sortPayBtn.classList.remove('active');
        sortMatchesBtn.classList.remove('active');
            bigDiffBtn.classList.remove('active');
            showMyPriceBtn.classList.remove('active');
            maxCoverageBtn.classList.remove('active');
        }
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleMaxCoverage() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        filterNewItems = !filterNewItems;
        if (filterNewItems) {
            maxCoverageBtn.classList.add('active');
        } else {
            maxCoverageBtn.classList.remove('active');
        }
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleCompactMatches() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        compactMatches = !compactMatches;
        if (compactMatches) compactMatchesBtn.classList.add('active');
        else compactMatchesBtn.classList.remove('active');
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleBarcodeSort() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (barcodeSortOrder === 0) barcodeSortOrder = 1;
        else if (barcodeSortOrder === 1) barcodeSortOrder = -1;
        else barcodeSortOrder = 0;
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleFileBarcodesVisibility() {
        showFileBarcodes = !showFileBarcodes;
        if (showFileBarcodes) {
            toggleFileBarcodesBtn.classList.add('active');
        } else {
            toggleFileBarcodesBtn.classList.remove('active');
        }
        renderTable();
    }

    function getSortedData() {
        let data = [...groupedData];

        if (searchQuery) {
            data = data.filter(item =>
                item.names.some(n => n.name.toLowerCase().includes(searchQuery))
            );
        }

        // –§–∏–ª—å—Ç—Ä –Ω–æ–≤–∏–Ω–æ–∫ (–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –æ—Ç sortMode)
        if (filterNewItems) {
            data = data.filter(item => !item.isInMyPrice);
        }

        if (sortMode === 'matches') {
            data.sort((a, b) => {
                if (a.originalFileCount > 1 && b.originalFileCount === 1) return -1;
                if (a.originalFileCount === 1 && b.originalFileCount > 1) return 1;
                return 0;
            });
        } else if (sortMode === 'bigdiff') {
            data = data.filter(item => item.originalFileCount > 1 && item.priceDiffPercent > 10);
            data.sort((a, b) => b.priceDiffPercent - a.priceDiffPercent);
        } else if (sortMode === 'myprice') {
            data = data.filter(item => item.isInMyPrice);
            data.sort((a, b) => a.myPriceOrder - b.myPriceOrder);
        } else if (sortMode === 'cart') {
            data = data.filter(item => cart.has(item.barcode));
        } else if (sortMode === 'maxcoverage' || filterNewItems) {
            data.sort((a, b) => b.coverageCount - a.coverageCount);
        }

        if (barcodeSortOrder !== 0) {
            data.sort((a, b) => {
                const bcA = String(a.barcode);
                const bcB = String(b.barcode);
                return barcodeSortOrder === 1 ? bcA.localeCompare(bcB) : bcB.localeCompare(bcA);
            });
        }

        return data;
    }

    function copyBarcode(barcode, btn) {
        if (!navigator.clipboard) return;
        navigator.clipboard.writeText(String(barcode)).then(() => {
            const orig = btn.textContent;
            btn.textContent = '‚úì';
            setTimeout(() => {
                btn.textContent = orig;
            }, 600);
        }).catch(() => {
        });
    }

    function copyBarcodeFromPrice(barcode) {
        if (!navigator.clipboard) return;
        navigator.clipboard.writeText(String(barcode)).then(() => {
            console.log('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω —à—Ç—Ä–∏—Ö–∫–æ–¥:', barcode);
        }).catch(() => {});
    }

    function editColumnName(colKey) {
        const col = allColumns.find(c => c.key === colKey);
        if (!col) return;
        const newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏:', col.displayName);
        if (newName && newName.trim() !== '' && newName.trim() !== col.displayName) {
            col.displayName = newName.trim();
            const wrapper = document.querySelector('.table-wrapper');
            const scrollTop = wrapper ? wrapper.scrollTop : 0;
            updateHiddenColumnsPanel();
            renderTable();
            const newWrapper = document.querySelector('.table-wrapper');
            if (newWrapper) newWrapper.scrollTop = scrollTop;
        }
    }

    function renderTable() {
        const dataToShow = getSortedData();

        if (dataToShow.length === 0) {
            tableContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
                    <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã</p>
                </div>`;
            return;
        }

        const visibleCols = allColumns.filter(col => visibleColumns.has(col.key));

        let html = '<div class="table-wrapper"><table><thead><tr>';
        html += `<th class="col-actions"></th>`;

        let sortIcon = '';
        if (barcodeSortOrder === 1) sortIcon = ' ‚ñ≤';
        else if (barcodeSortOrder === -1) sortIcon = ' ‚ñº';
        html += `<th class="col-barcode" onclick="toggleBarcodeSort()" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É">–®—Ç—Ä–∏—Ö–∫–æ–¥${sortIcon}</th>`;

        // –ö–æ–ª–æ–Ω–∫–∏ —Å–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞–º–∏ –ø–æ —Ñ–∞–π–ª–∞–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç—ã)
        allFilesData.forEach(({fileName}, idx) => {
            const extraClass = showFileBarcodes ? '' : 'hidden-barcode-col';
            html += `<th class="col-barcode file-barcode-col ${extraClass}" data-file-index="${idx}" title="–®—Ç—Ä–∏—Ö–∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞ ${fileName}">–®—Ç—Ä–∏—Ö–∫–æ–¥ (${fileName})</th>`;
        });

        html += `<th class="col-name">${nameColumn}</th>`;

        visibleCols.forEach((col)=>{
            const _isMyP = !col.metaType && col.fileName===MY_PRICE_FILE_NAME;
            const _isMeta = !!col.metaType;
            const _cL = col.metaType ? col.displayName : col.columnName;
            const _fL = col.metaType ? null : col.fileName;
            // –ú–æ–π –ø—Ä–∞–π—Å –∏ –º–µ—Ç–∞: —Ç–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–∫–∞; –ü–æ—Å—Ç–∞–≤—â–∏–∫: —Ñ–∞–π–ª + –∫–æ–ª–æ–Ω–∫–∞
            if(_isMyP||_isMeta){
                const _thClass = _isMyP ? "col-my-price" : "col-meta";
                const _fileLabel = MY_PRICE_FILE_NAME;
                html+=`<th class="${_thClass}" title="${_fileLabel} ‚Äî ${_cL}"><div class="column-header"><div class="column-file-name column-file-name--my-price" title="${_fileLabel}">${_fileLabel}</div><div class="column-header-title"><span class="column-name-text">${_cL}</span></div></div></th>`;
            } else {
                html+=`<th title="${_fL} ‚Äî ${_cL}"><div class="column-header"><div class="column-file-name" title="${_fL}">${_fL}</div><div class="column-header-title"><span class="column-name-text">${_cL}</span></div></div></th>`;
            }
        });

        html += '</tr></thead><tbody>';

        dataToShow.forEach((item, index) => {
            const inCart = cart.has(item.barcode);
            let rowClass = '';
            
            if (item.isSynonym) rowClass = 'synonym-row';
            
            if (inCart) {
                if (item.isSynonym) rowClass = 'in-cart synonym-row';
                else rowClass = 'in-cart';
            } else if (item.isInMyPrice && !item.isSynonym) {
                rowClass = 'my-price-row';
            }

            const prev = dataToShow[index - 1];
            const next = dataToShow[index + 1];
            const isGroupStart = !prev || prev.barcode !== item.barcode;
            const isGroupEnd = !next || next.barcode !== item.barcode;
            if (isGroupStart) rowClass += (rowClass ? ' ' : '') + 'group-border-top';
            if (isGroupEnd) rowClass += (rowClass ? ' ' : '') + 'group-border-bottom';

            html += `<tr class="${rowClass}" data-barcode="${item.barcode}" data-in-my-price="${item.isInMyPrice?'1':'0'}" data-is-synonym="${item.isSynonym?'1':'0'}">`;
            html += `<td class="col-actions">
                    <button class="cart-btn ${inCart ? 'in-cart' : ''}"
                            title="${inCart ? '–£–±—Ä–∞—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É'}"
                            onclick="toggleCart('${item.barcode}')">
                        ${inCart ? '‚úì' : 'üõí'}
                    </button>
                </td>`;

            html += `<td class="col-barcode">
                    <div class="barcode-cell">
                        <span class="barcode-text" title="${item.barcode}">${item.barcode}</span>
                        <button class="copy-btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥"
                                onclick="copyBarcode('${item.barcode}', this)">üìã</button>
                    </div>
                </td>`;

            // –Ø—á–µ–π–∫–∏ —Å –®–ö –ø–æ —Ñ–∞–π–ª–∞–º
            allFilesData.forEach(({fileName}, idx) => {
                const extraClass = showFileBarcodes ? '' : 'hidden-barcode-col';
                const origBarcode = item.originalBarcodesByFile.get(fileName) || '‚Äî';
                html += `<td class="col-barcode file-barcode-col ${extraClass}" data-file-index="${idx}">
                        <div class="barcode-cell">
                            <span class="barcode-text" title="${origBarcode}">${origBarcode}</span>
                            ${origBarcode !== '‚Äî' ? `<button class="copy-btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥" onclick="copyBarcode('${origBarcode}', this)">üìã</button>` : ''}
                        </div>
                    </td>`;
            });

            if (compactMatches && item.names.length > 1) {
                const text = item.names.map(n => n.name).join(' | ');
                html += `<td class="col-name">
                        <div class="name-compact" title="${text}">
                            ${text}
                        </div>
                    </td>`;
            } else {
                if (item.names.length > 0) {
                    html+=`<td class="col-name"><div class="name-cell">`;const _nm=new Map();item.names.forEach(n=>{if(!_nm.has(n.name))_nm.set(n.name,n.fileName);});_nm.forEach((fn,name)=>{html+=`<div class="name-item" title="üìÅ ${fn}">${name}</div>`;});html+=`</div></td>`;
                } else {
                    html += `<td class="col-name">–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è</td>`;
                }
            }

            const numericValues=[];

            const supplierVisiblePriceCols=visibleCols.filter(col=>!col.metaType&&col.fileName!==MY_PRICE_FILE_NAME&&isPriceLikeColumn(col.columnName));
            const _gn={"–Ω–∞–ª":[],"–±–Ω":[],"other":[]};supplierVisiblePriceCols.forEach(col=>{const _g=getColPayGroup(col);const valuesArr=item.values.get(col.key);if(valuesArr)valuesArr.forEach(vObj=>{const n=parsePriceNumber(vObj.val);if(n!==null&&n>0){numericValues.push(n);_gn[_g].push(n);}});});
            const _gMin={"–Ω–∞–ª":_gn["–Ω–∞–ª"].length>0?Math.min(..._gn["–Ω–∞–ª"]):null,"–±–Ω":_gn["–±–Ω"].length>0?Math.min(..._gn["–±–Ω"]):null,"other":_gn["other"].length>0?Math.min(..._gn["other"]):null};
            const _gM={"–Ω–∞–ª":_gn["–Ω–∞–ª"].length>1,"–±–Ω":_gn["–±–Ω"].length>1,"other":_gn["other"].length>1};
            const globalMin=numericValues.length>0?Math.min(...numericValues):null;
            const globalMax=numericValues.length>0?Math.max(...numericValues):null;
            const hasMultipleGlobals=numericValues.length>1;

            visibleCols.forEach(col => {
                const valuesArr = item.values.get(col.key);
                let cellContent = '‚Äî';

                if(col.metaType){const _mv=(valuesArr&&valuesArr.length>0)?valuesArr[0].val:"";if(_mv===undefined||_mv===null||String(_mv).trim()===""){cellContent="‚Äî";}else{const _mn=parseFloat(String(_mv).replace(",","."));cellContent=!isNaN(_mn)?String(Math.round(_mn)):String(_mv);}html+=`<td>${cellContent}</td>`;return;}

                if (valuesArr && valuesArr.length > 0) {
                    cellContent = '<div class="multi-value-container">';
                    valuesArr.forEach((vObj, vIndex) => {
                        let displayValue;
                        let isMin = false;
                        let isMax = false;
                        let numValue = null;

                        const parsed = parseFloat(String(vObj.val).replace(/[^0-9.,]/g, '').replace(',', '.'));
                        if(!isNaN(parsed)&&parsed>0){numValue=parsed;displayValue=parsed.toFixed(PRICE_DECIMALS)+" ‚ÇΩ";const _pg=getColPayGroup(col);if(_gM[_pg]&&_gMin[_pg]!==null&&parsed===_gMin[_pg])isMin=true;if(hasMultipleGlobals&&parsed===globalMax&&globalMax>=3*globalMin)isMax=true;}else{displayValue=vObj.val;}

                        const barcodeForCopy = vObj.originalBarcode || item.barcode;
                        const autoBadge = vObj._autoDiv ? `<span class="auto-div-badge" title="–ê–≤—Ç–æ–¥–µ–ª–µ–Ω–∏–µ /${vObj._autoDivFactor || item.packQty}">√∑</span>` : '';
                        let innerHtml = `<span class="price-clickable" onclick="copyBarcodeFromPrice('${barcodeForCopy}')" title="–ö–ª–∏–∫ ‚Üí –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥ ${barcodeForCopy}">${displayValue}</span>${autoBadge}`;
                        
                        if (isMin) {
                            innerHtml = `<span class="price-val is-min price-clickable" onclick="copyBarcodeFromPrice('${barcodeForCopy}')" title="–ö–ª–∏–∫ ‚Üí –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥ ${barcodeForCopy}">${displayValue}</span>${autoBadge}`;
                        }

                        if (isMax && numValue) {
                            innerHtml = `<span class="price-clickable" onclick="copyBarcodeFromPrice('${barcodeForCopy}')" title="–ö–ª–∏–∫ ‚Üí –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥ ${barcodeForCopy}">${displayValue}</span>${autoBadge}
                                <div class="div-wrapper" title="–¶–µ–Ω–∞ —É–∫–∞–∑–∞–Ω–∞ –∑–∞ –±–ª–æ–∫? –†–∞–∑–¥–µ–ª–∏—Ç–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç—É–∫">
                                    <div class="div-icon">√∑</div>
                                    <select class="div-select" onchange="dividePrice('${item.barcode}','${col.key}', ${vIndex}, this.value); this.value='';">
                                        <option value="" disabled selected>√∑</option>
                                        ${Array.from({length: 99}, (_, i) => i + 2).map(n => `<option value="${n}">${n}</option>`).join('')}
                                    </select>
                                </div>`;
                        }

                        cellContent += `<div class="value-variant">${innerHtml}</div>`;
                    });
                    cellContent += '</div>';
                }

                html += `<td>${cellContent}</td>`;
            });

            html += '</tr>';
        });

        html += '</tbody></table></div>';
        tableContainer.innerHTML = html;
    }

    function dividePrice(barcode, colKey, valueIndex, factorStr) {
        const factor = parseFloat(factorStr);
        if (!factor || factor <= 0) return;

        const item = groupedData.find(x => String(x.barcode) === String(barcode));
        if (!item) return;

        const visibleCols = allColumns.filter(col => visibleColumns.has(col.key));
    const priceCols = visibleCols.filter(col => !col.metaType && isPriceLikeColumn(col.columnName));
    const nums = [];
        priceCols.forEach(col => {
            const arr = item.values.get(col.key);
            if (!arr || arr.length === 0) return;
            arr.forEach(v => {
                const n = parsePriceNumber(v.val);
                if (n !== null && n > 0) nums.push(n);
            });
        });
        if (nums.length === 0) return;

        const minValue = Math.min(...nums);
        const threshold = minValue * 3;

        let changed = false;
        priceCols.forEach(col => {
            const arr = item.values.get(col.key);
            if (!arr || arr.length === 0) return;
            arr.forEach(vObj => {
                const n = parsePriceNumber(vObj.val);
                if (n === null || n <= 0) return;
                if (n > threshold) {
                    vObj.val = roundPrice(n / factor);
                    changed = true;
                }
            });
        });

        if (!changed) return;

        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    // ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    // –ü—Ä–æ—Å—Ç–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–∏–∞–ª–æ–≥ –±—Ä–∞—É–∑–µ—Ä–∞
    function saveBlobWithDialogOrDownload(blob, fileName) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    async function generateExcel(mode) {
    try {
    const _exMeta=allColumns.filter(c=>c.metaType&&visibleColumns.has(c.key));
    const _exMyP =allColumns.filter(c=>!c.metaType&&c.fileName===MY_PRICE_FILE_NAME&&visibleColumns.has(c.key));
    const _exSup =allColumns.filter(c=>!c.metaType&&c.fileName!==MY_PRICE_FILE_NAME&&visibleColumns.has(c.key));
    const excelCols=[..._exMeta,..._exMyP,..._exSup];
    const fileNames=allFilesData.map(f=>f.fileName);
    const hasMyPrice=!!myPriceData;
    const myPriceFileName=hasMyPrice?MY_PRICE_FILE_NAME:null;
    const nameFileOrder=[];
    if(hasMyPrice) nameFileOrder.push(myPriceFileName);
    fileNames.forEach(fn=>{if(!hasMyPrice||fn!==myPriceFileName)nameFileOrder.push(fn);});
    const priceStartColBase=1+fileNames.length+nameFileOrder.length;

    // –ñ–∏—Ä–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏: –º–æ–π –ø—Ä–∞–π—Å‚Üí–ø–æ—Å—Ç–∞–≤—â–∏–∫–∏ + –Ω–∞–ª‚Üî–±–Ω
    const thickLeftAt=new Set();
    const _fsi=excelCols.findIndex(c=>!c.metaType&&c.fileName!==MY_PRICE_FILE_NAME);
    if(_fsi>0) thickLeftAt.add(_fsi);
    for(let i=1;i<excelCols.length;i++){
        const p=excelCols[i-1],c=excelCols[i];
        if(!c.metaType&&c.fileName!==MY_PRICE_FILE_NAME&&!p.metaType&&p.fileName!==MY_PRICE_FILE_NAME)
            if(getColPayGroup(p)!==getColPayGroup(c)) thickLeftAt.add(i);
    }

    let dataToExport=[];
    if(mode==='cart')         dataToExport=groupedData.filter(item=>cart.has(item.barcode));
    else if(mode==='myprice') dataToExport=groupedData.filter(item=>item.isInMyPrice).sort((a,b)=>a.myPriceOrder-b.myPriceOrder);
    else if(mode==='current') dataToExport=getSortedData();
    else                      dataToExport=groupedData;

    const workbook=new ExcelJS.Workbook();
    const worksheet=workbook.addWorksheet('–°—Ä–∞–≤–Ω–µ–Ω–∏–µ');
    const totalCols=1+fileNames.length+nameFileOrder.length+excelCols.length;

    // –ó–∞–≥–æ–ª–æ–≤–∫–∏: –º–æ–π –ø—Ä–∞–π—Å ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–∫–∞, –ø–æ—Å—Ç–∞–≤—â–∏–∫ ‚Äî —Ñ–∞–π–ª+–∫–æ–ª–æ–Ω–∫–∞
    const headers=['–®—Ç—Ä–∏—Ö–∫–æ–¥'];
    fileNames.forEach(fn=>headers.push(`–®—Ç—Ä–∏—Ö–∫–æ–¥ (${fn})`));
    nameFileOrder.forEach(fn=>headers.push('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ'));
    excelCols.forEach(col=>{
        const _isMyP=!col.metaType&&col.fileName===MY_PRICE_FILE_NAME;
        if(_isMyP||col.metaType){
            headers.push(col.metaType?col.displayName:col.columnName);
        } else {
            headers.push(col.fileName+'\n'+col.columnName);
        }
    });
    const _xlH=worksheet.addRow(headers);
    _xlH.alignment={vertical:'middle',horizontal:'center',wrapText:true};
    _xlH.height=45;

    // –î–∞–Ω–Ω—ã–µ
    dataToExport.forEach(item=>{
        {
            const row=[item.barcode];
            fileNames.forEach(fn=>row.push(item.originalBarcodesByFile.get(fn)||''));
            if(mode==='current'){
                const _bestName=(item.names||[]).filter(n=>n.fileName!==MY_PRICE_FILE_NAME).reduce((b,n)=>n.name&&n.name.length>b.length?n.name:b,'');
                nameFileOrder.forEach((_fn,_i)=>row.push(_i===0?_bestName:''));
            } else {
                nameFileOrder.forEach(fn=>row.push((item.namesByFile&&item.namesByFile.get(fn))||''));
            }
            const priceStartCol=row.length;
            const numericColsInRow=[];
            const _eg={'–Ω–∞–ª':[],'–±–Ω':[],'other':[]};
            const _ei={'–Ω–∞–ª':[],'–±–Ω':[],'other':[]};
            const _multiValCols=new Set();
            excelCols.forEach((col,idx)=>{
                const va=item.values.get(col.key);let cellValue='';
                if(va&&va.length>0){
                    if(!col.metaType&&isPriceLikeColumn(col.columnName)){
                        const uniquePrices=[];
                        va.forEach(vObj=>{
                            const num=parseFloat(String(vObj.val).replace(/[^0-9.,]/g,'').replace(',','.'));
                            if(!isNaN(num)&&num>0){const r=roundPrice(num);if(!uniquePrices.includes(r))uniquePrices.push(r);}
                        });
                        if(uniquePrices.length===1){
                            cellValue=uniquePrices[0];
                            numericColsInRow.push(priceStartCol+idx);
                            if(col.fileName!==MY_PRICE_FILE_NAME){
                                const _g=getColPayGroup(col);
                                _eg[_g].push(uniquePrices[0]);
                                _ei[_g].push({ci:priceStartCol+idx,vi:_eg[_g].length-1});
                            }
                        } else if(uniquePrices.length>1){
                            cellValue=uniquePrices.map(p=>String(p).replace('.',',')).join(' / ');
                            _multiValCols.add(priceStartCol+idx);
                            if(col.fileName!==MY_PRICE_FILE_NAME){
                                const _g=getColPayGroup(col);
                                uniquePrices.forEach(p=>{_eg[_g].push(p);_ei[_g].push({ci:priceStartCol+idx,vi:_eg[_g].length-1});});
                            }
                        } else {
                            cellValue=va[0]?.val||'';
                        }
                    } else if(col.metaType){
                        const num=parseFloat(String(va[0].val).replace(/[^0-9.,]/g,'').replace(',','.'));
                        cellValue=(!isNaN(num)&&num>0)?Math.round(num):(va[0].val||'');
                    } else {
                        cellValue=va[0]?.val||'';
                    }
                }
                row.push(cellValue);
            });
            const excelRow=worksheet.addRow(row);
            numericColsInRow.forEach(ci=>{const c=excelRow.getCell(ci+1);if(typeof c.value==='number')c.numFmt='0.0';});
            if(item.isSynonym){excelRow.getCell(1).fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFE6F7FF'}};}
            ['–Ω–∞–ª','–±–Ω','other'].forEach(g=>{
                if(_eg[g].length>1){
                    const mn=Math.min(..._eg[g]);
                    const minCells=new Set();
                    _ei[g].forEach(({ci,vi})=>{if(_eg[g][vi]===mn)minCells.add(ci);});
                    minCells.forEach(ci=>{
                        const cell=excelRow.getCell(ci+1);
                        cell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFFFCCCC'}};
                        cell.font={color:{argb:'FF000000'}};
                    });
                }
            });
        }
    });

    // –®–∏—Ä–∏–Ω—ã + –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
    const fbS=2,fbE=1+fileNames.length,nsS=fbE+1,nsE=nsS+nameFileOrder.length-1;
    worksheet.columns.forEach((col,idx)=>{
        const ci=idx+1;
        if(ci===1)col.width=15;
        else if(ci>=fbS&&ci<=fbE)col.width=13;
        else if(ci>=nsS&&ci<=nsE)col.width=(hasMyPrice&&nameFileOrder[0]===myPriceFileName&&ci===nsS)?50:20;
        else col.width=10;
    });
    if(fileNames.length>0){worksheet.properties.outlineProperties={summaryBelow:true};for(let c=fbS;c<=fbE;c++){worksheet.getColumn(c).outlineLevel=1;worksheet.getColumn(c).hidden=true;}}
    if(nameFileOrder.length>1){worksheet.properties.outlineProperties={summaryBelow:true};const st=hasMyPrice?nsS+1:nsS;for(let c=st;c<=nsE;c++){worksheet.getColumn(c).outlineLevel=1;worksheet.getColumn(c).hidden=true;}}
    worksheet.views=[{state:'frozen',xSplit:0,ySplit:1}];

    // –ì—Ä–∞–Ω–∏—Ü—ã: —Ç–æ–Ω–∫–∏–µ + –∂–∏—Ä–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ + –∂–∏—Ä–Ω–∞—è –≤–Ω–µ—à–Ω—è—è —Ä–∞–º–∫–∞
    const totalRows=worksheet.rowCount;
    worksheet.eachRow((row,rowNum)=>{
        row.eachCell({includeEmpty:true},(cell,colNum)=>{
            const _eci=colNum-1-priceStartColBase;
            cell.border={
                top:   {style:rowNum===1?'medium':'thin'},
                left:  {style:(colNum===1||(_eci>=0&&thickLeftAt.has(_eci)))?'medium':'thin'},
                bottom:{style:rowNum===totalRows?'medium':'thin'},
                right: {style:colNum===totalCols?'medium':'thin'}
            };
        });
    });

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
    const headerRow=worksheet.getRow(1);
    headerRow.font={bold:true};
    headerRow.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFE0E0E0'}};
    headerRow.alignment={vertical:'middle',horizontal:'center',wrapText:true};
    headerRow.height=45;
    // –ú–æ–π –ø—Ä–∞–π—Å –∫–æ–ª–æ–Ω–∫–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ ‚Äî –∑–µ–ª—ë–Ω—ã–π —Ü–≤–µ—Ç
    excelCols.forEach((col,idx)=>{
    });
    if(fbS<=headers.length)headerRow.getCell(fbS).note='–®—Ç—Ä–∏—Ö–∫–æ–¥—ã –ø–æ —Ñ–∞–π–ª–∞–º';
    if(nsS<=headers.length)headerRow.getCell(nsS).note='–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –ø–æ —Ñ–∞–π–ª–∞–º';

    const buffer=await workbook.xlsx.writeBuffer();
    const now=new Date(),yyyy=now.getFullYear(),mm=String(now.getMonth()+1).padStart(2,'0'),dd=String(now.getDate()).padStart(2,'0');
    let fileName=`monitoring-${yyyy}-${mm}-${dd}.xlsx`;
    if(mode==='cart')    fileName=`monitoring-cart-${yyyy}-${mm}-${dd}.xlsx`;
    if(mode==='myprice') fileName=`monitoring-myprice-${yyyy}-${mm}-${dd}.xlsx`;
    if(mode==='current') fileName=`monitoring-current-${yyyy}-${mm}-${dd}.xlsx`;
    const blob=new Blob([buffer],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    await saveBlobWithDialogOrDownload(blob,fileName);
    } catch(err) {
        console.error('generateExcel error:', err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Excel-—Ñ–∞–π–ª–∞:\n' + (err.message || err));
    }
}


    function updateUI() {
        const hasData = groupedData.length > 0;
        const hasMyPrice = myPriceData !== null;

        sortPayBtn.disabled=!hasData;
        exportAllBtn.disabled = !hasData;
        exportCurrentBtn.disabled = !hasData;
        exportMyPriceBtn.disabled = !hasMyPrice || !hasData;
        clearBtn.disabled = !hasData;
        sortMatchesBtn.disabled = !hasData;
        bigDiffBtn.disabled = !hasData;
        showMyPriceBtn.disabled = !hasMyPrice || !hasData;
        compactMatchesBtn.disabled = !hasData;
        maxCoverageBtn.disabled = !hasData;
        toggleFileBarcodesBtn.disabled = !hasData;
        searchInput.disabled = !hasData;

        if (hasData) {
            infoPanel.style.display='grid';
            const _lp=document.getElementById('legendPanel');if(_lp)_lp.style.display='flex';
            const matchCount = groupedData.filter(item => item.originalFileCount > 1).length;
            document.getElementById('productCount').textContent = groupedData.length;
            document.getElementById('fileCount').textContent = allFilesData.length;
            document.getElementById('columnCount').textContent = allColumns.length;
            document.getElementById('matchCount').textContent = matchCount;
        } else {
            infoPanel.style.display='none';
            const _lp2=document.getElementById('legendPanel');if(_lp2)_lp2.style.display='none';
        }
    }

    function clearAll() {
        myPriceData = null;
        competitorFilesData = [];
        allFilesData = [];
        groupedData = [];
        allColumns = [];
        visibleColumns.clear();
        cart.clear();
        barcodeColumn = null;
        nameColumn = null;
        sortMode = 'default';
        compactMatches = false;
        searchQuery = '';
        barcodeSortOrder = 0;
        showFileBarcodes = false;
        filterNewItems = false;

        myPriceInput.value = '';
        competitorInput.value = '';
        synonymsInput.value = '';
        const _mpSt2=document.getElementById('myPriceStatus');if(_mpSt2){_mpSt2.className='upload-status upload-status--idle';_mpSt2.textContent='–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω';}
        const _cSt2=document.getElementById('competitorStatus');if(_cSt2){_cSt2.className='upload-status upload-status--idle';_cSt2.textContent='–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã';}
        const _snSt2=document.getElementById('synonymsStatus');if(_snSt2){_snSt2.className='upload-status upload-status--idle';_snSt2.textContent='–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã';}
        resetBarcodeAliases();
        searchInput.value = '';
        sortPayBtn.classList.remove('active');
        sortMatchesBtn.classList.remove('active');
        bigDiffBtn.classList.remove('active');
        showMyPriceBtn.classList.remove('active');
        showCartBtn.classList.remove('active');
        compactMatchesBtn.classList.remove('active');
        maxCoverageBtn.classList.remove('active');
        toggleFileBarcodesBtn.classList.remove('active');
        hiddenColumnsPanel.style.display = 'none';
        updateCartUI();

        tableContainer.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç—ã</h3>
                <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à –ø—Ä–∞–π—Å –∏ —Ñ–∞–π–ª—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</p>
            </div>`;
        updateUI();
    }

    function applySortByPayment(){const _m=allColumns.filter(c=>c.metaType);const _p=allColumns.filter(c=>!c.metaType&&c.fileName===MY_PRICE_FILE_NAME);const _s=allColumns.filter(c=>!c.metaType&&c.fileName!==MY_PRICE_FILE_NAME);_s.sort((a,b)=>{const o={"–Ω–∞–ª":0,"–±–Ω":1,"other":2};return(o[getColPayGroup(a)]??2)-(o[getColPayGroup(b)]??2);});allColumns=[..._m,..._p,..._s];const _w=document.querySelector(".table-wrapper"),_st=_w?_w.scrollTop:0;updateHiddenColumnsPanel();renderTable();const _w2=document.querySelector(".table-wrapper");if(_w2)_w2.scrollTop=_st;sortPayBtn.classList.add("active");setTimeout(()=>sortPayBtn.classList.remove("active"),1200);}
    function downloadCurrentSynonyms(){const g={};barcodeAliasMap.forEach((c,a)=>{if(!g[c])g[c]=[];if(a!==c)g[c].push(a);});const blob=new Blob([JSON.stringify(g,null,2)],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement("a"),now=new Date();a.href=url;a.download=`synonyms_${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}.json`;a.click();URL.revokeObjectURL(url);}
    window.toggleColumn = toggleColumn;
    window.toggleCart = toggleCart;
    window.copyBarcode = copyBarcode;
    window.copyBarcodeFromPrice = copyBarcodeFromPrice;
    window.toggleBarcodeSort = toggleBarcodeSort;
    window.dividePrice = dividePrice;
    window.editColumnName = editColumnName;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –†–ï–ñ–ò–ú –û–ë–£–ß–ï–ù–ò–Ø
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    (function initTutorial() {
        // ‚îÄ‚îÄ –°–ª–æ–≤–∞—Ä—å –ø–æ–¥—Å–∫–∞–∑–æ–∫ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const TIPS = {
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
            'myPriceInput':          { t: 'üìã –ú–æ–π –ø—Ä–∞–π—Å', b: '–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à –ø—Ä–∞–π—Å-–ª–∏—Å—Ç (CSV, XLS, XLSX). –ò–º–µ–Ω–Ω–æ –µ–≥–æ —Ç–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –±–∞–∑–æ–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è ‚Äî –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ–∫–∞–∂–µ—Ç, —É –∫–æ–≥–æ –∏–∑ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –¥–µ—à–µ–≤–ª–µ.' },
            'competitorInput':       { t: 'üì¶ –ü—Ä–∞–π—Å—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤', b: '–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤. –ü—Ä–æ–≥—Ä–∞–º–º–∞ —Å—Ä–∞–≤–Ω–∏—Ç —Ü–µ–Ω—ã —Å–æ –≤—Å–µ–º–∏ —Å—Ä–∞–∑—É –∏ –≤—ã–¥–µ–ª–∏—Ç –ª—É—á—à–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.' },
            'synonymsInput':         { t: 'üîó –°–∏–Ω–æ–Ω–∏–º—ã —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤', b: '–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ. JSON-—Ñ–∞–π–ª —Å –≥—Ä—É–ø–ø–∞–º–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤-—Å–∏–Ω–æ–Ω–∏–º–æ–≤: –µ—Å–ª–∏ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ç–æ–≤–∞—Ä –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö –∑–∞–ø–∏—Å–∞–Ω —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–¥–∞–º–∏ ‚Äî –ø—Ä–æ–≥—Ä–∞–º–º–∞ –æ–±—ä–µ–¥–∏–Ω–∏—Ç –∏—Ö –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É.' },
            'synonymsStatus':        { t: 'üìä –°—Ç–∞—Ç—É—Å —Å–∏–Ω–æ–Ω–∏–º–æ–≤', b: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ —Ñ–∞–π–ª —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –∏ —Å–∫–æ–ª—å–∫–æ –≤ –Ω—ë–º –≥—Ä—É–ø–ø. –ï—Å–ª–∏ —Å–∏–Ω–æ–Ω–∏–º—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã ‚Äî —Ç–æ–≤–∞—Ä—ã —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é —à—Ç—Ä–∏—Ö–∫–æ–¥–∞.' },
            'downloadSynBtn':        { t: '‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å JSON', b: '–°–∫–∞—á–∞—Ç—å —Ç–µ–∫—É—â–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–∏–Ω–æ–Ω–∏–º–æ–≤ ‚Äî —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–ª–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–Ω–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã.' },
            'resetSynBtn':           { t: '‚úñÔ∏è –°–±—Ä–æ—Å–∏—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã', b: '–û—Ç–∫–ª—é—á–∏—Ç—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ —Å–∏–Ω–æ–Ω–∏–º–∞–º. –ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ —Ç–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é —à—Ç—Ä–∏—Ö–∫–æ–¥–∞.' },
            // –ü–æ–∏—Å–∫
            'searchInput':           { t: 'üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é', b: '–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ ‚Äî —Ç–∞–±–ª–∏—Ü–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è. –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –≤—Å–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è–º.' },
            // –§–∏–ª—å—Ç—Ä—ã
            'sortMatchesBtn':        { t: 'üîù –°–Ω–∞—á–∞–ª–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è', b: '–°–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É —Ç–∞–∫, —á—Ç–æ–±—ã —Ç–æ–≤–∞—Ä—ã, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å—Ä–∞–∑—É —É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤, —à–ª–∏ –ø–µ—Ä–≤—ã–º–∏ ‚Äî —É–¥–æ–±–Ω–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ª—É—á—à–µ–π —Ü–µ–Ω—ã.' },
            'bigDiffBtn':            { t: 'üìâ –ë–æ–ª—å—à–∞—è —Ä–∞–∑–Ω–∏—Ü–∞', b: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –≤–∞—à–µ–π —Ü–µ–Ω–æ–π –∏ —Ü–µ–Ω–æ–π –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 10%. –ü–æ–º–æ–≥–∞–µ—Ç –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ —Å–∞–º—ã–µ –≤—ã–≥–æ–¥–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏.' },
            'showMyPriceBtn':        { t: 'üè∑Ô∏è –¢–æ–ª—å–∫–æ –º–æ–π –ø—Ä–∞–π—Å', b: '–û—Å—Ç–∞–≤–ª—è–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –≤–∞—à–µ–º –ø—Ä–∞–π—Å–µ. –£–¥–æ–±–Ω–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ —Å–≤–æ–π –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç.' },
            'showCartBtn':           { t: 'üõí –¢–æ–ª—å–∫–æ –∫–æ—Ä–∑–∏–Ω–∞', b: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã, –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–æ–π üõí (–¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –≤ –∫–æ—Ä–∑–∏–Ω—É). –£–¥–æ–±–Ω–æ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–æ—Ä—Ç–æ–º.' },
            'maxCoverageBtn':        { t: 'üìä –ü–æ –æ—Ö–≤–∞—Ç—É', b: '–°–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ç–æ–≤–∞—Ä—ã –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Ü–µ–Ω–∞ –Ω–∞ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä. –í–≤–µ—Ä—Ö—É ‚Äî —Å–∞–º—ã–µ ¬´–ø–æ–ø—É–ª—è—Ä–Ω—ã–µ¬ª –ø–æ–∑–∏—Ü–∏–∏.' },
            'filterNewItemsBtn':     { t: 'üÜï –ù–æ–≤–∏–Ω–∫–∏', b: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –≤–∞—à–µ–º –ø—Ä–∞–π—Å–µ. –£–¥–æ–±–Ω–æ –∏—Å–∫–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç.' },
            // –í–∏–¥
            'compactMatchesBtn':     { t: 'üìê –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥', b: '–£–º–µ–Ω—å—à–∞–µ—Ç –≤—ã—Å–æ—Ç—É —Å—Ç—Ä–æ–∫: –≤—Å–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É —Å –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ–º. –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤–∏–¥–µ—Ç—å –±–æ–ª—å—à–µ –ø–æ–∑–∏—Ü–∏–π –Ω–∞ —ç–∫—Ä–∞–Ω–µ.' },
            'toggleFileBarcodesBtn': { t: '# –®—Ç—Ä–∏—Ö–∫–æ–¥—ã –ø–æ —Ñ–∞–π–ª–∞–º', b: '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç/—Å–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ —Å–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞–º–∏ –∏–∑ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞. –ü–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è ‚Äî –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å, –∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ –∫–æ–¥ –±—ã–ª –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ.' },
            'sortPayBtn':            { t: 'üí≥ –ù–∞–ª / –ë–µ–∑–Ω–∞–ª', b: '–°–æ—Ä—Ç–∏—Ä—É–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤: —Å–Ω–∞—á–∞–ª–∞ –∏–¥—É—Ç –∫–æ–ª–æ–Ω–∫–∏ —Å –Ω–∞–ª–∏—á–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏, –∑–∞—Ç–µ–º –±–µ–∑–Ω–∞–ª–∏—á–Ω—ã–µ. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–æ–ª–æ–Ω–∫–∏.' },
            // –≠–∫—Å–ø–æ—Ä—Ç
            'exportMyPriceBtn':      { t: '‚≠ê –≠–∫—Å–ø–æ—Ä—Ç: –ú–æ–π –ø—Ä–∞–π—Å', b: '–°–∫–∞—á–∏–≤–∞–µ—Ç Excel —Ç–æ–ª—å–∫–æ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–∞–π—Å–∞. –í —Ñ–∞–π–ª –≤–æ–π–¥—É—Ç –≤–∏–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏: –æ—Å—Ç–∞—Ç–æ–∫, —Ü–µ–Ω—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.' },
            'exportAllBtn':          { t: 'üíæ –≠–∫—Å–ø–æ—Ä—Ç: –í—Å—ë', b: '–°–∫–∞—á–∏–≤–∞–µ—Ç Excel —Å–æ –≤—Å–µ–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ ‚Äî –±–µ–∑ —É—á—ë—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ –∏ –ø–æ–∏—Å–∫–∞. –ü–æ–ª–Ω—ã–π —Å—Ä–µ–∑ –¥–∞–Ω–Ω—ã—Ö.' },
            'exportCurrentBtn':      { t: 'üîç –≠–∫—Å–ø–æ—Ä—Ç: –¢–µ–∫—É—â–∏–π –≤–∏–¥', b: '–°–∫–∞—á–∏–≤–∞–µ—Ç Excel –∏–º–µ–Ω–Ω–æ —Ç–æ, —á—Ç–æ –≤–∏–¥–Ω–æ —Å–µ–π—á–∞—Å: —Å —É—á—ë—Ç–æ–º –ø–æ–∏—Å–∫–∞, —Ñ–∏–ª—å—Ç—Ä–æ–≤, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ —Å–∫—Ä—ã—Ç—ã—Ö –∫–æ–ª–æ–Ω–æ–∫.' },
            'exportCartBtn':         { t: 'üõí –≠–∫—Å–ø–æ—Ä—Ç: –ö–æ—Ä–∑–∏–Ω–∞', b: '–°–∫–∞—á–∏–≤–∞–µ—Ç Excel —Ç–æ–ª—å–∫–æ —Å –æ—Ç–º–µ—á–µ–Ω–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏ (–∫–æ—Ä–∑–∏–Ω–∞). –£–¥–æ–±–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É.' },
            // –û—á–∏—Å—Ç–∫–∞
            'clearCartBtn':          { t: 'üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É', b: '–°–Ω–∏–º–∞–µ—Ç –æ—Ç–º–µ—Ç–∫—É üõí —Å–æ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤. –ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–∞–µ—Ç—Å—è, –Ω–æ –¥–∞–Ω–Ω—ã–µ –∏ —Ç–∞–±–ª–∏—Ü–∞ –æ—Å—Ç–∞—é—Ç—Å—è.' },
            'clearBtn':              { t: '‚ö†Ô∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë', b: '–£–¥–∞–ª—è–µ—Ç –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É –≤ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.' },
            // –û–±—É—á–µ–Ω–∏–µ
            'tutorialBtn':           { t: 'üéì –†–µ–∂–∏–º –æ–±—É—á–µ–Ω–∏—è', b: '–í—ã —É–∂–µ –≤ —Ä–µ–∂–∏–º–µ –æ–±—É—á–µ–Ω–∏—è! –ù–∞–≤–æ–¥–∏—Ç–µ –º—ã—à—å –Ω–∞ –ª—é–±–æ–π —ç–ª–µ–º–µ–Ω—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ‚Äî –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º. –ù–∞–∂–º–∏—Ç–µ –µ—â—ë —Ä–∞–∑, —á—Ç–æ–±—ã –≤—ã–π—Ç–∏.' },
        };

        // ‚îÄ‚îÄ –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ç–∞–±–ª–∏—Ü—ã (–ø–æ CSS-–∫–ª–∞—Å—Å—É) ‚îÄ‚îÄ
        const CLASS_TIPS = [
            { sel: '.cart-btn',         t: 'üõí –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É', b: '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É. –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ ‚Äî —É–±—Ä–∞—Ç—å. –¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ –º–æ–∂–Ω–æ –ø–æ—Ç–æ–º —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ.' },
            { sel: '.copy-btn',         t: 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥', b: '–ö–æ–ø–∏—Ä—É–µ—Ç —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞. –£–¥–æ–±–Ω–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–∞ –≤ –¥—Ä—É–≥–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö.' },
            { sel: 'td.col-barcode',    t: '# –®—Ç—Ä–∏—Ö–∫–æ–¥', b: '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ–≤–∞—Ä–∞. –ü–æ –Ω–µ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∞ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å—Ç—Ä–æ–∫–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ –æ–¥–Ω—É –≥—Ä—É–ø–ø—É.' },
            { sel: 'td.col-name',       t: 'üìù –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', b: '–ù–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤. –ï—Å–ª–∏ —É –æ–¥–Ω–æ–≥–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–π ‚Äî –≤—Å–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ.' },
            { sel: 'th.col-meta',       t: 'üìä –ú–æ–π –ø—Ä–∞–π—Å: –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ', b: '–ö–æ–ª–æ–Ω–∫–∞ –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–∞–π—Å–∞: –û—Å—Ç–∞—Ç–æ–∫, –í –ø—É—Ç–∏ –∏ —Ç.–¥. –ü–æ–º–æ–≥–∞–µ—Ç –≤–∏–¥–µ—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ —Å —Ü–µ–Ω–∞–º–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤.' },
            { sel: 'th.col-my-price',   t: 'üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å: —Ü–µ–Ω–∞', b: '–í–∞—à–∞ —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –Ω–∞ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä. –°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ —Å —Ü–µ–Ω–∞–º–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ª—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.' },
            { sel: 'th.col-barcode',    t: '# –®—Ç—Ä–∏—Ö–∫–æ–¥ (–∫–ª–∏–∫ = —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞)', b: '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫, —á—Ç–æ–±—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É. –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫ ‚Äî –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞.' },
            { sel: 'th.col-name',       t: 'üìù –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', b: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–∑–≤–∞–Ω–∏–π, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö.' },
            { sel: 'th.col-actions',    t: 'üéõÔ∏è –î–µ–π—Å—Ç–≤–∏—è', b: '–ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–æ–π: –¥–æ–±–∞–≤–∏—Ç—å/—É–±—Ä–∞—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã.' },
            { sel: '.price-clickable',  t: 'üí∞ –¶–µ–Ω–∞ (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞)', b: '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ü–µ–Ω—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –µ—ë –∫–∞–∫ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—É—é –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –í—ã–±—Ä–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ –≤—ã–¥–µ–ª—è–µ—Ç—Å—è.' },
            { sel: 'tr.my-price-row td', t: 'üè∑Ô∏è –°—Ç—Ä–æ–∫–∞ –∏–∑ –º–æ–µ–≥–æ –ø—Ä–∞–π—Å–∞', b: '–≠—Ç–∞ —Å—Ç—Ä–æ–∫–∞ ‚Äî –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–∞–π—Å–∞. –°–≤–µ—Ç–ª–æ-–∑–µ–ª—ë–Ω—ã–π —Ñ–æ–Ω –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —à—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–∞–π–¥–µ–Ω –≤ –≤–∞—à–µ–º —Ñ–∞–π–ª–µ.' },
            { sel: 'tr.synonym-row td', t: 'üîó –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ —Å–∏–Ω–æ–Ω–∏–º—É', b: '–≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä –æ–±—ä–µ–¥–∏–Ω—ë–Ω —Å –≥—Ä—É–ø–ø–æ–π —á–µ—Ä–µ–∑ —Å–∏–Ω–æ–Ω–∏–º —à—Ç—Ä–∏—Ö–∫–æ–¥–∞. –ì–æ–ª—É–±–æ–π —Ñ–æ–Ω ‚Äî –ø—Ä–∏–∑–Ω–∞–∫ —Å–∏–Ω–æ–Ω–∏–º–Ω–æ–π —Å—Ç—Ä–æ–∫–∏.' },
            { sel: '.legend-item',      t: 'üìñ –õ–µ–≥–µ–Ω–¥–∞', b: '–û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤—ã—Ö –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–π —Ç–∞–±–ª–∏—Ü—ã: –∑–µ–ª—ë–Ω—ã–π ‚Äî –º–æ–π –ø—Ä–∞–π—Å, –≥–æ–ª—É–±–æ–π ‚Äî —Å–∏–Ω–æ–Ω–∏–º—ã, –∫—Ä–∞—Å–Ω—ã–π ‚Äî –¥—É–±–ª–∏–∫–∞—Ç—ã.' },
            { sel: '.restore-column-btn', t: 'üëÅÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É', b: '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∑–∞—Ç—å —Å–∫—Ä—ã—Ç—É—é –∫–æ–ª–æ–Ω–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ.' },
            { sel: '.hide-col-btn',     t: '‚úï –°–∫—Ä—ã—Ç—å –∫–æ–ª–æ–Ω–∫—É', b: '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —ç—Ç—É –∫–æ–ª–æ–Ω–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã. –°–∫—Ä—ã—Ç—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å –≤—ã—à–µ.' },
        ];

        // ‚îÄ‚îÄ –°–æ–∑–¥–∞—ë–º —Ç—É–ª—Ç–∏–ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const tip = document.createElement('div');
        tip.id = 'tutorialTooltip';
        tip.innerHTML = '<div class="tt-title"></div><div class="tt-body"></div>';
        document.body.appendChild(tip);
        const tipTitle = tip.querySelector('.tt-title');
        const tipBody  = tip.querySelector('.tt-body');
        let tutorialActive = false;
        let hideTimer = null;

        function showTip(x, y, title, body) {
            clearTimeout(hideTimer);
            tipTitle.textContent = title;
            tipBody.textContent  = body;
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Å –æ—Ç—Å—Ç—É–ø–æ–º –æ—Ç –∫—É—Ä—Å–æ—Ä–∞
            const margin = 14;
            const tw = 340, th = 120;
            let left = x + margin;
            let top  = y + margin;
            if (left + tw > window.innerWidth)  left = x - tw - margin;
            if (top  + th > window.innerHeight) top  = y - th - margin;
            tip.style.left = left + 'px';
            tip.style.top  = top  + 'px';
            tip.classList.add('visible');
        }

        function hideTip(delay = 80) {
            clearTimeout(hideTimer);
            hideTimer = setTimeout(() => tip.classList.remove('visible'), delay);
        }

        function findTip(el) {
            // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ ID
            if (el.id && TIPS[el.id]) return TIPS[el.id];
            // –ó–∞—Ç–µ–º –ø–æ CSS-–∫–ª–∞—Å—Å–∞–º (–æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫ –æ–±—â–µ–º—É)
            for (const {sel, t, b} of CLASS_TIPS) {
                if (el.matches && el.matches(sel)) return {t, b};
            }
            // –ò—â–µ–º —É –±–ª–∏–∂–∞–π—à–µ–≥–æ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –ø—Ä–µ–¥–∫–∞
            const parent = el.parentElement;
            if (parent && parent !== document.body) return findTip(parent);
            return null;
        }

        function onMouseMove(e) {
            if (!tutorialActive) return;
            const el = document.elementFromPoint(e.clientX, e.clientY);
            if (!el || el === tip) return;
            const info = findTip(el);
            if (info) {
                showTip(e.clientX, e.clientY, info.t, info.b);
            } else {
                hideTip(200);
            }
        }

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç–∫–ª—é—á—ë–Ω–Ω—ã—Ö title-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
        const _savedTitles = new Map();

        function _disableTitles() {
            document.querySelectorAll('[title]').forEach(el => {
                _savedTitles.set(el, el.getAttribute('title'));
                el.setAttribute('data-title-bak', el.getAttribute('title'));
                el.removeAttribute('title');
            });
        }

        function _restoreTitles() {
            _savedTitles.forEach((val, el) => {
                // –í–µ—Ä–Ω—É—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –±—ã–ª –∑–∞–º–µ–Ω—ë–Ω —á–µ–º-—Ç–æ –¥—Ä—É–≥–∏–º
                if (!el.hasAttribute('title')) el.setAttribute('title', val);
            });
            _savedTitles.clear();
        }

        // –¢–∞–∫–∂–µ –æ—Ç–∫–ª—é—á–∞–µ–º title —É —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º—ã—Ö –≤ DOM –≤–æ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è
        let _titleObserver = null;

        function toggleTutorial() {
            tutorialActive = !tutorialActive;
            const btn = document.getElementById('tutorialBtn');
            if (tutorialActive) {
                document.body.classList.add('tutorial-active');
                _disableTitles();
                // –°–ª–µ–¥–∏–º –∑–∞ –Ω–æ–≤—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —Å title (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞)
                _titleObserver = new MutationObserver(() => {
                    document.querySelectorAll('[title]').forEach(el => {
                        if (!_savedTitles.has(el)) {
                            _savedTitles.set(el, el.getAttribute('title'));
                            el.removeAttribute('title');
                        }
                    });
                });
                _titleObserver.observe(document.body, { subtree: true, childList: true, attributes: true, attributeFilter: ['title'] });
                document.addEventListener('mousemove', onMouseMove);
                btn.classList.add('active');
                btn.textContent = 'üéì –í—ã–π—Ç–∏ –∏–∑ –æ–±—É—á–µ–Ω–∏—è';
            } else {
                document.body.classList.remove('tutorial-active');
                if (_titleObserver) { _titleObserver.disconnect(); _titleObserver = null; }
                _restoreTitles();
                document.removeEventListener('mousemove', onMouseMove);
                tip.classList.remove('visible');
                btn.classList.remove('active');
                btn.textContent = 'üéì –û–±—É—á–µ–Ω–∏–µ';
            }
        }

        // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('tutorialBtn');
            if (btn) btn.addEventListener('click', toggleTutorial);
        });
        // –ï—Å–ª–∏ DOM —É–∂–µ –≥–æ—Ç–æ–≤
        if (document.readyState !== 'loading') {
            const btn = document.getElementById('tutorialBtn');
            if (btn) btn.addEventListener('click', toggleTutorial);
        }
    })();


    // ‚îÄ‚îÄ –¢–æ—Å—Ç –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showCompletionToast() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø—Ä–∞–π—Å—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
        if (competitorFilesData.length === 0) return;
        const total = groupedData.length;
        const matched = groupedData.filter(i => i.isInMyPrice).length;
        const suppliers = competitorFilesData.length;
        if (total === 0) return;

        let toast = document.getElementById('_completionToast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = '_completionToast';
            Object.assign(toast.style, {
                position: 'fixed', bottom: '24px', right: '24px',
                background: '#0f172a', color: '#f1f5f9',
                border: '1px solid #22c55e',
                padding: '14px 18px', borderRadius: '10px',
                fontSize: '13px', lineHeight: '1.6',
                boxShadow: '0 6px 28px rgba(0,0,0,.45)',
                zIndex: '99998', maxWidth: '300px',
                transition: 'opacity .4s, transform .4s',
                transform: 'translateY(20px)', opacity: '0'
            });
            document.body.appendChild(toast);
        }
        toast.innerHTML =
            `<div style="font-size:15px;font-weight:700;color:#22c55e;margin-bottom:6px;">‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≥–æ—Ç–æ–≤!</div>` +
            `<div>üì¶ –¢–æ–≤–∞—Ä–æ–≤: <b style="color:#7dd3fc">${total.toLocaleString('ru')}</b></div>` +
            (matched ? `<div>üè∑Ô∏è –°–æ–≤–ø–∞–ª–æ —Å –ø—Ä–∞–π—Å–æ–º: <b style="color:#7dd3fc">${matched.toLocaleString('ru')}</b></div>` : '') +
            `<div>üìÇ –ü–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤: <b style="color:#7dd3fc">${suppliers}</b></div>`;

        // Animate in
        requestAnimationFrame(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
        });
        clearTimeout(toast._timer);
        toast._timer = setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(20px)';
        }, 9000);
    }

</script>

</body>
</html>
