<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='80'%3E%F0%9F%92%B2%3C/text%3E%3C/svg%3E" />
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style> * { margin: 0; padding: 0; box-sizing: border-box; }body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Arial, sans-serif; background: #f2f2f7; padding: 16px; color: #1c1c1e; }.container { max-width: 100%; margin: 0 –∞–≤—Ç–æ; background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); }h1 { font-size: 28px; font-weight: 600; margin-bottom: 20px; color: #1c1c1e; letter-spacing: -0.5px; }.upload-section { display: grid; grid-template-columns: 1.5fr 1.5fr 1fr; gap: 12px; margin-bottom: 12px; }.upload-card { background: #f9f9fb; border-radius: 12px; padding: 12px; border: 2px dashed #c7c7cc; transition: all 0.2s; }.upload-card:hover { border-color: #007aff; }.upload-card.my-price { border-color: #34c759; background: #f0fdf4; }.upload-card.my-price:hover { border-color: #28a745; }.upload-label { display: block; font-size: 12px; font-weight: 600; color: #8e8e93; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }.upload-card.my-price .upload-label { color: #34c759; }.file-input-wrapper { position: relative; }.file-input-wrapper input[type="file"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }.file-input-display { display: flex; align-items: center; gap: 6px; padding: 8px 10px; background: white; border-radius: 8px; font-size: 13px; color: #007aff; font-weight: 500; cursor: pointer; transition: all 0.2s; }.file-input-display:hover { background: #e8f4ff; }.upload-card.my-price .file-input-display { color: #34c759; }.upload-card.my-price .file-input-display:hover { background: #e6f9ec; }.upload-card.synonyms { border-color: #ffcc00; background: #fff9e6; }.upload-card.synonyms .upload-label { color: #ff9500; }.search-box { margin-bottom: 12px; }.search-input { width: 100%; padding: 10px 12px; border: 2px solid #e5e5ea; border-radius: 10px; font-size: 14px; font-family: inherit; transition: all 0.2s; }.search-input:focus { outline: none; border-color: #007aff; background: #f0f7ff; }.controls { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }.btn { padding: 6px 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.2s; display: flex; align-items: center; gap: 4px; line-height: 1; white-space: nowrap; }.btn span.icon { font-size: 14px; }.btn-primary { background: #007aff; color: white; }.btn-primary:hover { background: #0051d5; transform: translateY(-1px); box-shadow: 0 3px 8px rgba(0, 122, 255, 0.25); }.btn-success { background: #34c759; color: white; }.btn-success:hover { background: #28a745; transform: translateY(-1px); box-shadow: 0 3px 8px rgba(52, 199, 89, 0.25); }.btn-warning { background: #ff9500; color: white; }.btn-warning:hover { background: #e08600; transform: translateY(-1px); box-shadow: 0 3px 8px rgba(255, 149, 0, 0.25); }.btn-danger { background: #ff3b30; color: white; }.btn-danger:hover { background: #d70015; }.btn-secondary { background: #f9f9fb; color: #007aff; border: 1px solid #e5e5ea; }.btn-secondary:hover { background: #e8f4ff; }.btn-secondary.active { background: #007aff; color: white; }.btn:disabled { background: #e5e5ea; color: #aeaeb2; cursor: not-allowed; transform: none; }.cart-badge { background: #ff3b30; color: white; border-radius: 10px; padding: 1px 6px; font-size: 11px; font-weight: 700; min-width: 18px; text-align: center; }.info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-bottom: 12px; }.info-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 10px; color: white; }.info-card:nth-child(2) { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }.info-card:nth-child(3) { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }.info-card:nth-child(4) { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }.info-value { font-size: 22px; font-weight: 700; margin-bottom: 2px; letter-spacing: -0.5px; }.info-label { font-size: 11px; opacity: 0.9; font-weight: 500; }.hidden-columns { background: #fff3cd; border: 1px solid #ffc107; border-radius: 12px; padding: 8px 10px; margin-bottom: 10px; display: none; align-items: center; gap: 8px; flex-wrap: wrap; }.hidden-columns-label { font-size: 12px; font-weight: 600; color: #856404; }.restore-column-btn { padding: 4px 8px; background: white; border: 1px solid #ffc107; border-radius: 6px; font-size: 11px; font-weight: 600; color: #856404; cursor: pointer; transition: all 0.2s; }.restore-column-btn:hover { background: #ffc107; color: white; }.table-wrapper { overflow-x: auto; border-radius: 12px; border: 1px solid #e5e5ea; max-height: 70vh; }table { width: 100%; border-collapse: collapse; min-width: 700px; }th { background: #f9f9fb; padding: 4px 6px; text-align: left; font-weight: 600; font-size: 11px; color: #8e8e93; border-bottom: 1px solid #e5e5ea; position: sticky; top: 0; z-index: 10; letter-spacing: 0.3px; max-width: 160px; overflow: visible; vertical-align: top; }th.col-barcode { min-width: 140px; max-width: 140px; cursor: pointer; user-select: none; }th.col-barcode:hover { background: #e8f4ff; }th.col-name { min-width: 320px; max-width: 320px; }th.col-actions { min-width: 70px; max-width: 70px; }.column-header { display: flex; flex-direction: column; gap: 2px; min-width: 80px; }.column-header-title { display: flex; align-items: center; gap: 3px; }.column-name-text { overflow: hidden; text-overflow: ellipsis; white-space: normal; word-break: break-word; font-size: 10px; line-height: 1.3; }
.column-file-name { font-size: 10px; color: #007aff; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-transform: none; letter-spacing: 0; border-bottom: 1px solid #e5e5ea; padding-bottom: 2px; margin-bottom: 2px; }td { padding: 4px 8px; border-bottom: 1px solid #f2f2f7; font-size: 13px; color: #1c1c1e; max-width: 150px; vertical-align: top; }td.col-barcode { min-width: 140px; max-width: 140px; }td.col-name { min-width: 320px; max-width: 320px; line-height: 1.3; padding: 0; }.name-cell { width: 100%; }.name-item { padding: 4px 8px; border-bottom: 1px solid #e5e5ea; }.name-item:last-child { border-bottom: none; }.name-compact { padding: 4px 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }td.col-actions { min-width: 70px; max-width: 70px; }tr { border-top: 1px solid #e5e5ea; }tr.group-border-top { border-top: 2px solid #c7c7cc; }tr.group-border-bottom { border-bottom: 2px solid #c7c7cc; }tr:hover { background: #f9f9fb; }tr.my-price-row { background: #f0fdf4; }tr.my-price-row:hover { background: #e6f9ec; }tr.in-cart { background: #d4f4dd; }tr.in-cart:hover { background: #c0eeca; }tr.duplicate-row { background: #ffe6f0 !important; }tr.duplicate-row:hover { background: #ffd6e7 !important; }tr.duplicate-row.in-cart { background: #ffc6d8 !important; }tr.duplicate-row.in-cart:hover { background: #ffb6c8 !important; }/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ —Å–∏–Ω–æ–Ω–∏–º–∞–º */ tr.synonym-row { background: #e6f7ff !important; }tr.synonym-row:hover { background: #d1efff !important; }tr.synonym-row.in-cart { background: #b8e6ff !important; }tr.synonym-row.in-cart:hover { background: #a3dcff !important; }.multi-value-container { display: flex; flex-direction: column; gap: 4px; }.value-variant { display: flex; flex-direction: column; border-bottom: 1px dashed #e5e5ea; padding-bottom: 2px; position: relative; padding-right: 15px; }.div-wrapper { position: absolute; top: 0; right: 0; width: 14px; height: 14px; overflow: hidden; }.div-icon { color: #ff3b30; font-size: 14px; line-height: 1; font-weight: bold; text-align: center; pointer-events: none; }.div-select { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; font-size: 16px; }.value-variant:last-child { border-bottom: none; padding-bottom: 0; }.price-val.is-min { color: #28a745; font-weight: 700; }/* –¶–µ–Ω–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ */ .price-clickable { cursor: pointer; transition: all 0.15s; }.price-clickable:hover { background: #fff3cd; padding: 2px 4px; margin: -2px -4px; border-radius: 4px; }.cart-btn { background: transparent; color: #34c759; border: none; padding: 2px; border-radius: 6px; cursor: pointer; font-size: 18px; transition: all 0.2s; }.cart-btn:hover { background: #e6f9ec; transform: scale(1.05); }.cart-btn.in-cart { color: #34c759; }.barcode-cell { display: flex; align-items: center; gap: 4px; }.barcode-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }.copy-btn { border: none; background: #f2f2f7; border-radius: 4px; padding: 2px 4px; font-size: 11px; cursor: pointer; color: #555; flex-shrink: 0; }.copy-btn:hover { background: #e0e0e4; }/* –°–∫—Ä—ã—Ç—ã–µ –∫–æ–ª–æ–Ω–∫–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ –≤ UI */ .hidden-barcode-col { display: none; }.empty-state { text-align: center; padding: 40px 20px; color: #8e8e93; }.empty-state-icon { font-size: 48px; margin-bottom: 12px; }.empty-state h3 { font-size: 18px; font-weight: 600; margin-bottom: 6px; color: #1c1c1e; }.empty-state p { font-size: 13px; }@media (max-width: 900px) { .upload-section { grid-template-columns: 1fr; } }@media (max-width: 768px) { .info-grid { grid-template-columns: repeat(2, 1fr); } } 
.auto-div-badge {
  display: inline-block;
  margin-left: 4px;
  color: #ffcc00;
  font-weight: 900;
  font-size: 13px;
  line-height: 1;
  text-shadow: 0 1px 0 rgba(0,0,0,0.15);
}
.legend-panel{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-start;background:#f9f9fb;border:1px solid #e5e5ea;border-radius:10px;padding:8px 12px;margin-bottom:10px;font-size:12px;}.legend-item{display:flex;align-items:center;gap:5px;white-space:normal;max-width:500px;line-height:1.3;}.legend-swatch{width:16px;height:16px;border-radius:3px;border:1px solid rgba(0,0,0,0.1);flex-shrink:0;}
:root { --global-nav-h: 52px; }

.global-nav{
  position: sticky;
  top: 0;
  z-index: 5000;
  background: #ffffff;
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  border-bottom: none;
}

.global-nav__inner{
  max-width: 100%;
  margin: 0 auto;
  padding: 10px 24px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.global-nav__brand{
  text-decoration: none;
  font-weight: 800;
  color: #1c1c1e;
  white-space: nowrap;
}

.global-nav__links{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
}

.global-nav__link{
  text-decoration: none;
  font-size: 13px;
  font-weight: 650;
  color: #007aff;
  background: rgba(0,122,255,0.08);
  border: 1px solid rgba(0,122,255,0.18);
  padding: 6px 10px;
  border-radius: 999px;
  white-space: nowrap;
  transition: transform .12s ease, background .12s ease;
}

.global-nav__link:hover{
  transform: translateY(-1px);
  background: rgba(0,122,255,0.14);
}

.global-nav__link.is-active{
  color: #fff;
  background: #007aff;
  border-color: #007aff;
}

</style>
</head>
<body>
<header class="global-nav">
  <div class="global-nav__inner">
    <a class="global-nav__brand" href="https://erofly83-arch.github.io/pricematcher/">
      –ù–∞–≤–∏–≥–∞—Ç–æ—Ä
    </a>

    <nav class="global-nav__links" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º">
      <a class="global-nav__link" href="https://erofly83-arch.github.io/synonyms/" data-match="/synonyms/">
        –†–µ–¥–∞–∫—Ç–æ—Ä JSON
      </a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/pricematcher/" data-match="/pricematcher/">
        –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
      </a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/obrezatel/" data-match="/obrezatel/">
        –û–±—Ä–µ–∑–∞—Ç–µ–ª—å
      </a>
      <a class="global-nav__link" href="https://erofly83-arch.github.io/sininimfinder/" data-match="/sininimfinder/">
        –ü–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
      </a>
    </nav>
  </div>
</header>
<div class="container">
    <h1>üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω</h1>

    <div class="upload-section">
        <div class="upload-card my-price">
            <label class="upload-label">üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å</label>
            <div class="file-input-wrapper">
                <input type="file" id="myPriceInput" accept=".csv,.xlsx,.xls"/>
                <div class="file-input-display" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∞—à –ø—Ä–∞–π—Å-—Ñ–∞–π–ª">
                    <span>üìÑ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</span>
                </div>
            </div>
        </div>

        <div class="upload-card">
            <label class="upload-label">üì¶ –ü—Ä–∞–π—Å—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</label>
            <div class="file-input-wrapper">
                <input type="file" id="competitorInput" multiple accept=".csv,.xlsx,.xls"/>
                <div class="file-input-display" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤">
                    <span>üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</span>
                </div>
            </div>
        </div>

        <div class="upload-card synonyms">
            <label class="upload-label">üîó –°–∏–Ω–æ–Ω–∏–º—ã —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ (JSON)</label>
            <div class="file-input-wrapper">
                <input type="file" id="synonymsInput" accept=".json"/>
                <div class="file-input-display" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª synonyms.json —Å –≥—Ä—É–ø–ø–∞–º–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤">
                    <span>üß© –í—ã–±—Ä–∞—Ç—å synonyms.json</span>
                </div>
            </div>
            <div id="synonymsStatus" style="margin-top:6px;font-size:11px;color:#34c759;">–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–∏–Ω–æ–Ω–∏–º–æ–≤ (166 –≥—Ä—É–ø–ø)</div>
            <div style="display:flex;gap:6px;margin-top:6px;">
                <button id="downloadSynBtn" class="btn btn-secondary" style="font-size:11px;padding:3px 8px;">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å JSON</button>
                <button id="resetSynBtn"    class="btn btn-secondary" style="font-size:11px;padding:3px 8px;">‚Ü©Ô∏è –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π</button>
            </div>
        </div>
    </div>

    <div class="search-box">
        <input type="text" id="searchInput" class="search-input"
               placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–æ–≤–∞—Ä–∞..."
               title="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ —á–∞—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤">
    </div>

    <div class="controls">
        <button id="sortMatchesBtn" class="btn btn-secondary" disabled
                title="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞ —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–∞—Ö">
            <span class="icon">üîÑ</span> –°–æ–≤–ø–∞–¥–µ–Ω–∏—è
        </button>
        <button id="bigDiffBtn" class="btn btn-secondary" disabled
                title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã —Å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è–º–∏, –≥–¥–µ —Ä–∞–∑–Ω–∏—Ü–∞ —Ü–µ–Ω –±–æ–ª—å—à–µ 10%">
            <span class="icon">üìä</span> –ë–æ–ª—å—à–∞—è —Ä–∞–∑–Ω–∏—Ü–∞
        </button>
        <button id="showMyPriceBtn" class="btn btn-secondary" disabled
                title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–∞–π—Å–∞">
            <span class="icon">‚≠ê</span> –ú–æ–π –ø—Ä–∞–π—Å
        </button>
        <button id="showCartBtn" class="btn btn-secondary" disabled
                title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –≤ –∫–æ—Ä–∑–∏–Ω—É">
            <span class="icon">üõíüëÅÔ∏è</span> –ö–æ—Ä–∑–∏–Ω–∞
        </button>
        <button id="compactMatchesBtn" class="btn btn-secondary" disabled
                title="–£–º–µ–Ω—å—à–∏—Ç—å –≤—ã—Å–æ—Ç—É —Å—Ç—Ä–æ–∫ —Å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è–º–∏, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É">
            <span class="icon">üìè</span> –ö–æ–º–ø–∞–∫—Ç–Ω–æ
        </button>
        <button id="maxCoverageBtn" class="btn btn-secondary" disabled
                title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Ü–µ–Ω–∞ –Ω–∞ —Ç–æ–≤–∞—Ä">
            <span class="icon">üìä</span> –ú–∞–∫—Å.—Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
        </button>
        <button id="toggleFileBarcodesBtn" class="btn btn-secondary" disabled
                title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–æ–ª–æ–Ω–∫–∏ —Å–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞–º–∏ –ø–æ —Ñ–∞–π–ª–∞–º">
            <span class="icon">üîé</span> –®–ö –ø–æ —Ñ–∞–π–ª–∞–º
        </button>
        <button id="exportMyPriceBtn" class="btn btn-success" disabled
                title="–°–∫–∞—á–∞—Ç—å Excel —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–∞–π—Å–∞ –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏">
            <span class="icon">‚≠êüíæ</span> –ú–æ–π –ø—Ä–∞–π—Å
        </button>
        <button id="exportAllBtn" class="btn btn-success" disabled
                title="–°–∫–∞—á–∞—Ç—å Excel —Å–æ –≤—Å–µ–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏ –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏">
            <span class="icon">üíæ</span> –í—Å—ë
        </button>
        <button id="exportCartBtn" class="btn btn-warning" disabled
                title="–°–∫–∞—á–∞—Ç—å Excel —Ç–æ–ª—å–∫–æ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã">
            <span class="icon">üõíüíæ</span> –ö–æ—Ä–∑–∏–Ω–∞
            <span id="cartBadge" class="cart-badge" style="display:none;">0</span>
        </button>
        <button id="clearCartBtn" class="btn btn-danger" disabled
                title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã">
            <span class="icon">üõíüóëÔ∏è</span> –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
        </button>
        <button id="sortPayBtn" class="btn btn-secondary" disabled title="–ù–∞–ª ‚Üí –ë–Ω"><span class="icon">üí≥</span> –ù–∞–ª/–ë–Ω</button>
        <button id="clearBtn" class="btn btn-danger" disabled
                title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ">
            <span class="icon">üóëÔ∏è</span> –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë
        </button>
    </div>

    <div id="infoPanel" class="info-grid" style="display:none;">
        <div class="info-card">
            <div class="info-value" id="productCount">0</div>
            <div class="info-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</div>
        </div>
        <div class="info-card">
            <div class="info-value" id="fileCount">0</div>
            <div class="info-label">–§–∞–π–ª–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</div>
        </div>
        <div class="info-card">
            <div class="info-value" id="columnCount">0</div>
            <div class="info-label">–ö–æ–ª–æ–Ω–æ–∫ –¥–∞–Ω–Ω—ã—Ö</div>
        </div>
        <div class="info-card">
            <div class="info-value" id="matchCount">0</div>
            <div class="info-label">–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</div>
        </div>
    </div>

    <div id="hiddenColumnsPanel" class="hidden-columns">
        <span class="hidden-columns-label">üîç –°–∫—Ä—ã—Ç—ã–µ –∫–æ–ª–æ–Ω–∫–∏:</span>
        <div id="hiddenColumnsList"></div>
    </div>

    <div class="legend-panel" id="legendPanel" style="display:none;">
        <strong style="font-size:12px;color:#555;margin-right:4px;">–ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫:</strong>
        <div class="legend-item"><div class="legend-swatch" style="background:#e6f7ff;"></div><span><b>–°–∏–Ω–æ–Ω–∏–º—ã</b> ‚Äî –°–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ —Å–∏–Ω–æ–Ω–∏–º–∞–º</span></div>
        <div class="legend-item"><div class="legend-swatch" style="background:#ffe6f0;"></div><span><b>–î—É–±–ª—å —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</b> ‚Äî –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ –æ–¥–Ω–æ–º –ø—Ä–∞–π—Å–µ</span></div>
        <div class="legend-item"><div class="legend-swatch" style="background:#fff;border:2px solid #28a745;"></div><span style="color:#28a745;font-weight:600;">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞</span></div>
    </div>
    <div id="tableContainer">
        <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç—ã</h3>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à –ø—Ä–∞–π—Å –∏ —Ñ–∞–π–ª—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</p>
        </div>
    </div>
</div>

<script>
    // ======== –°–õ–û–í–ê–†–¨ –°–ò–ù–û–ù–ò–ú–û–í –®–¢–†–ò–•–ö–û–î–û–í (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ JSON) ========

    const BUILTIN_SYNONYMS={
  "40084107": [
    "–®–æ–∫ –Ø–π—Ü–æ –ö–∏–Ω–¥–µ—Ä –§–∏–∫—Å–∏–∫–∏ 20–≥—Ä/36—à—Ç"
  ],
  "40099484": [
    "–ñ–µ–≤. –û—Ä–±–∏—Ç 15–≥—Ä –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π 30—à—Ç/20–±–ª"
  ],
  "42113164": [
    "–ñ–µ–≤. –û—Ä–±–∏—Ç 15–≥—Ä –ù–µ–∂–Ω–∞—è –ú—è—Ç–∞ 30—à—Ç/20–±–ª"
  ],
  "42113270": [
    "–ñ–µ–≤. –û—Ä–±–∏—Ç 15–≥—Ä –ê—Ä–±—É–∑ 30—à—Ç/20–±–ª"
  ],
  "42203100": [
    "–ñ–µ–≤. –û—Ä–±–∏—Ç 15–≥—Ä –ö–ª—É–±–Ω–∏–∫–∞/–ë–∞–Ω–∞–Ω 30—à—Ç/20–±–ª",
    "42203100"
  ],
  "46040145": [
    "–ò—Ä–∏—Å –ú–µ–ª–ª–µ—Ä 38–≥—Ä –®–æ–∫–æ–ª–∞–¥ 24—à—Ç/8–±–ª",
    "87108156"
  ],
  "46065780": [
    "–õ–µ–¥ –ß—É–ø–∞ –ß—É–ø—Å XXL –¢—Ä–∏–æ 40—à—Ç/12–±–ª"
  ],
  "46078476": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª 15.5–≥—Ä –ú–æ—Ä–æ–∑–Ω–∞—è –ú—è—Ç–∞ 30—à—Ç/24–±–ª"
  ],
  "46078483": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª 15.5–≥—Ä –ù–µ–∂–Ω–∞—è –ú—è—Ç–∞ 30—à—Ç/24–±–ª"
  ],
  "46149305": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª 15.5–≥—Ä –ö–ª—É–±–Ω–∏–∫–∞/–ß–µ—Ä–µ—à–Ω—è (–î–ª—è –ù–µ–µ) 30—à—Ç/24–±–ª",
    "46149749",
    "7622210618184",
    "7622210365675"
  ],
  "46164179": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª 15.5–≥—Ä –ú–∞—Ä–∞–∫—É–π—è 30—à—Ç/24–±–ª"
  ],
  "46164209": [
    "–õ–µ–¥ –•–æ–ª–ª—Å –û—Ä–∏–≥–∏–Ω–∞–ª 12—à—Ç/30–±–ª"
  ],
  "46164230": [
    "–õ–µ–¥ –•–æ–ª–ª—Å –ú–µ–¥/–õ–∏–º–æ–Ω 12—à—Ç/30–±–ª"
  ],
  "46177889": [
    "–õ–µ–¥ –•–æ–ª–ª—Å –≠–∫—Å—Ç—Ä–∞/–ú–µ–Ω—Ç–æ–ª 12—à—Ç/30–±–ª"
  ],
  "46187857": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª 15.5–≥—Ä –§—Ä—É–∫—Ç—ã/–ú—è—Ç–∞ 30—à—Ç/24–±–ª"
  ],
  "46204813": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ì–æ–ª–¥ 95–≥—Ä/12—à—Ç —Å—Ç/–±"
  ],
  "46204837": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ì–æ–ª–¥ 47.5–≥—Ä/12—à—Ç —Å—Ç/–±",
    "46024756"
  ],
  "46214621": [
    "–ñ–µ–≤. –ú–µ–Ω—Ç–æ—Å 15.5–≥—Ä –¢—É—Ç—Ç–∏-–§—Ä—É—Ç—Ç–∏ 24—à—Ç/12–±–ª",
    "46265456"
  ],
  "46214638": [
    "–ñ–µ–≤. –ú–µ–Ω—Ç–æ—Å 15.5–≥—Ä –ù–µ–∂–Ω–∞—è –ú—è—Ç–∞ 24—à—Ç/12–±–ª"
  ],
  "46214645": [
    "–ñ–µ–≤. –ú–µ–Ω—Ç–æ—Å 15.5–≥—Ä –ö–ª—É–±–Ω–∏–∫–∞ 24—à—Ç/12–±–ª"
  ],
  "46227720": [
    "–ñ–µ–≤. –ú–µ–Ω—Ç–æ—Å 15.5–≥—Ä –í–∏–Ω–æ–≥—Ä–∞–¥ 24—à—Ç/12–±–ª"
  ],
  "46227737": [
    "–ñ–µ–≤. –ú–µ–Ω—Ç–æ—Å 15.5–≥—Ä –ê—Ä–±—É–∑ 24—à—Ç/12–±–ª"
  ],
  "50173808": [
    "–ñ–µ–≤. –û—Ä–±–∏—Ç 15–≥—Ä –°–ª–∞–¥–∫–∞—è –ú—è—Ç–∞ 30—à—Ç/20–±–ª"
  ],
  "50173976": [
    "–ñ–µ–≤. –û—Ä–±–∏—Ç 15–≥—Ä –ó–∏–º–Ω—è—è –°–≤–µ–∂–µ—Å—Ç—å 30—à—Ç/20–±–ª"
  ],
  "57626543": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª 15.5–≥—Ä –ê—Ä–±—É–∑ 30—à—Ç/24–±–ª",
    "46103536",
    "5700626163169"
  ],
  "80741244": [
    "–®–æ–∫ –Ø–π—Ü–æ –ö–∏–Ω–¥–µ—Ä –õ–∏—Ü–µ–Ω–∑–∏—è 20–≥—Ä/36—à—Ç"
  ],
  "80741251": [
    "–®–æ–∫ –Ø–π—Ü–æ –ö–∏–Ω–¥–µ—Ä –î–µ–≤–æ—á–∫–∏ 20–≥—Ä/36—à—Ç"
  ],
  "5000159438056": [
    "–î—Ä–∞–∂–µ –°–∫–∏—Ç—Ç–µ–ª—Å 38–≥—Ä –ö–∏—Å–ª–æ–º–∏–∫—Å 12—à—Ç/12–±–ª"
  ],
  "4011100156364": [
    "–î—Ä–∞–∂–µ –°–∫–∏—Ç—Ç–µ–ª—Å 38–≥—Ä –§—Ä—É–∫—Ç—ã 12—à—Ç/12/–±–ª",
    "5000159372923",
    "4009900527576"
  ],
  "4600815107299": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª 15.5–≥—Ä –ê—Ä–±—É–∑/–î—ã–Ω—è 30—à—Ç/24–±–ª",
    "46058157",
    "46103550"
  ],
  "7622201135492": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª 15.5–≥—Ä –ö–ª—É–±–Ω–∏–∫–∞/–ö–æ–∫–æ—Å 30—à—Ç/24–±–ª",
    "57027906",
    "7622201136239"
  ],
  "7622201429942": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª 15.5–≥—Ä –ö–ª—É–±–Ω–∏—á–Ω–∞—è –ø–æ–ª—è–Ω–∞ 30—à—Ç/24–±–ª",
    "46092076"
  ],
  "4600815109545": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª 15.5–≥—Ä –õ–µ–¥—è–Ω–∞—è –ú—è—Ç–∞ 30—à—Ç/24–±–ª",
    "46090812"
  ],
  "4600815108661": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª 15.5–≥—Ä –ú—è—Ç–∞ 30—à—Ç/24–±–ª"
  ],
  "7622210742407": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª 15.5–≥—Ä –ú—è—Ç–∞ –í–∞–π—Ç 30—à—Ç/24–±–ª",
    "46190369"
  ],
  "7622201140892": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª 15.5–≥—Ä –£–≥–æ–ª—å/–ú—è—Ç–∞ 30—à—Ç/24–±–ª",
    "57027913"
  ],
  "7622201461065": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª 15.5–≥—Ä –§—Ä—É–∫—Ç–æ–≤—ã–π –†–∞–Ω–¥–æ–º (–ö–æ–ª–æ—Ä—Å) 30—à—Ç/24–±–ª",
    "7622201461072"
  ],
  "7622202229787": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª –í–∏–Ω–æ–≥—Ä–∞–¥ 30—à—Ç/24–±–ª",
    "7622202229770"
  ],
  "7622202288661": [
    "–ñ–µ–≤. –î–∏—Ä–æ–ª –•–•L –ö–æ–ª–æ—Ä –ö–ª—É–±–Ω–∏–∫–∞ 18—à—Ç/20–±–ª"
  ],
  "4602606003001": [
    "–ñ–µ–≤. –ú–µ–Ω—Ç–æ—Å 15.5–≥—Ä –í–∏—à–Ω—è 24—à—Ç/12–±–ª",
    "46260888"
  ],
  "4602606006071": [
    "–ñ–µ–≤. –ú–µ–Ω—Ç–æ—Å 15.5–≥—Ä –°–≤–µ–∂–∞—è –ú—è—Ç–∞ 24—à—Ç/12–±–ª"
  ],
  "4009900492942": [
    "–ñ–µ–≤. –û—Ä–±–∏—Ç 15–≥—Ä –ë–∞–±–ª–º–∏–Ω—Ç 30—à—Ç/20–±–ª",
    "46141538"
  ],
  "4009900367356": [
    "–ñ–µ–≤. –û—Ä–±–∏—Ç 15–≥—Ä –û—Å–≤–µ–∂–∞—é—â–∞—è –ú—è—Ç–∞ 30—à—Ç/20–±–ª",
    "42069942"
  ],
  "4607085682334": [
    "–ö–∞–∫–∞–æ –ú–∏–∫—Å –§–∏–∫—Å 375–≥—Ä/12—à—Ç –ø–ª/–±",
  ],
  "4607065373337": [
    "–ö–æ—Ä–º –¥–ª—è –∫–æ—à–µ–∫ –ö–∏—Ç–µ–∫–µ—Ç 15–∫–≥/42—à—Ç"
  ],
  "4620007592597": [
    "–ö–æ—Ñ–µ –ê–º–±–∞—Å—Å–∞–¥–æ—Ä 150–≥—Ä/6—à—Ç –º/—É"
  ],
  "4620007592580": [
    "–ö–æ—Ñ–µ –ê–º–±–∞—Å—Å–∞–¥–æ—Ä 75–≥—Ä/12—à—Ç –º/—É"
  ],
  "4620007590951": [
    "–ö–æ—Ñ–µ –ê–º–±–∞—Å—Å–∞–¥–æ—Ä 95–≥—Ä/6—à—Ç —Å—Ç/–±"
  ],
  "4607805480462": [
    "–ö–æ—Ñ–µ –ò–Ω–¥–∏–π—Å–∫–∏–π 90–≥—Ä/12—à—Ç –∂/–±"
  ],
  "4607001772972": [
    "–ö–æ—Ñ–µ –ö–∞—Ä—Ç –ù—É–∞—Ä 1.8–≥—Ä 30—à—Ç/20–±–ª",
    "8714599516966"
  ],
  "4601985007310": [
    "–ö–æ—Ñ–µ –ú–ö–ü –ê—Ä–∞–±–∏–∫–∞ 75–≥—Ä/12—à—Ç –º/—É",
    "4601985000519"
  ],
  "4601985007334": [
    "–ö–æ—Ñ–µ –ú–ö–ü –ê—Ä–∞–±–∏–∫–∞ 95–≥—Ä/12—à—Ç —Å—Ç/–±"
  ],
  "4601985002803": [
    "–ö–æ—Ñ–µ –ú–ö–ü –ê—Ä–∞–±–∏–∫–∞ 95–≥—Ä/8—à—Ç —Å—Ç/–±"
  ],
  "4601985000526": [
    "–ö–æ—Ñ–µ –ú–ö–ü –ö–æ–ª–æ–º–±–æ 75–≥—Ä/12—à—Ç –º/—É"
  ],
  "4601985002810": [
    "–ö–æ—Ñ–µ –ú–ö–ü –ö–æ–ª–æ–º–±–æ 95–≥—Ä/8—à—Ç —Å—Ç/–±"
  ],
  "4601985005507": [
    "–ö–æ—Ñ–µ –ú–ö–ü –°—É–∞—Ä–µ 150–≥—Ä/10—à—Ç –º/—É"
  ],
  "4601985000533": [
    "–ö–æ—Ñ–µ –ú–ö–ü –°—É–∞—Ä–µ 75–≥—Ä/12—à—Ç –º/—É"
  ],
  "4601985003541": [
    "–ö–æ—Ñ–µ –ú–ö–ü –°—É–∞—Ä–µ 95–≥—Ä/12—à—Ç –º/—É"
  ],
  "4601985002827": [
    "–ö–æ—Ñ–µ –ú–ö–ü –°—É–∞—Ä–µ 95–≥—Ä/12—à—Ç —Å—Ç/–±"
  ],
  "4607805480448": [
    "–ö–æ—Ñ–µ –ú–æ—Å–∫–æ–≤—Å–∫–∏–π 90–≥—Ä/12—à—Ç –∂/–±"
  ],
  "4600680011486": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ 3–≤1 –ö–ª–∞—Å—Å–∏–∫ 20–≥—Ä/20—à—Ç/20–±–ª",
    "4607150089747",
    "46226914"
  ],
  "4600680011523": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ 3–≤1 –ö—Ä–µ–ø–∫–∏–π 20–≥—Ä/20—à—Ç/20–±–ª",
    "46226921"
  ],
  "4600680008158": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ì–æ–ª–¥ 130–≥—Ä/8—à—Ç –º/—É"
  ],
  "4600680000640": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ì–æ–ª–¥ 190–≥—Ä/6—à—Ç —Å—Ç/–±",
    "4606272002269",
    "7616100981328"
  ],
  "4606272027231": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ì–æ–ª–¥ 190–≥—Ä/8—à—Ç –º/—É"
  ],
  "4600680008387": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ì–æ–ª–¥ 220–≥—Ä/12—à—Ç –º/—É"
  ],
  "4600680001975": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ì–æ–ª–¥ 500–≥—Ä/12—à—Ç –º/—É",
    "4600680001976",
    "4600648001975"
  ],
  "4606272019922": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ì–æ–ª–¥ 750–≥—Ä/6—à—Ç –º/—É",
    "4600680001951"
  ],
  "4606272014217": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ì–æ–ª–¥ 75–≥—Ä/8—à—Ç –º/—É",
    "4600680000534"
  ],
  "4606272033300": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ì–æ–ª–¥ –ë–∞—Ä–∏—Å—Ç–∞ 85–≥—Ä/6—à—Ç —Å—Ç/–±"
  ],
  "4600680011691": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ö–ª–∞—Å—Å–∏–∫ 1000–≥—Ä/6—à—Ç –º/—É"
  ],
  "4600680010595": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ö–ª–∞—Å—Å–∏–∫ 130–≥—Ä/12—à—Ç –º/—É"
  ],
  "4600680010601": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ö–ª–∞—Å—Å–∏–∫ 190–≥—Ä/8—à—Ç –º/—É"
  ],
  "4600680016641": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ö–ª–∞—Å—Å–∏–∫ 320–≥—Ä/8—à—Ç –º/—É"
  ],
  "4600680010557": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ö–ª–∞—Å—Å–∏–∫ 500–≥—Ä/6—à—Ç –º/—É"
  ],
  "4600680010588": [
    "–ö–æ—Ñ–µ –ù–µ—Å–∫–∞—Ñ–µ –ö–ª–∞—Å—Å–∏–∫ 60–≥—Ä/12—à—Ç –º/—É"
  ],
  "7892222500092": [
    "–ö–æ—Ñ–µ –ü–µ–ª–µ 100–≥—Ä/24—à—Ç –∂/–±",
    "7898647600898"
  ],
  "898647600904": [
    "–ö–æ—Ñ–µ –ü–µ–ª–µ 200–≥—Ä/24—à—Ç –∂/–±",
    "7892222500108"
  ],
  "7892222110024": [
    "–ö–æ—Ñ–µ –ü–µ–ª–µ 50–≥—Ä/24—à—Ç –∂/–±",
    "7898647600881"
  ],
  "4607066405129": [
    "–ö–æ—Ñ–µ –¢–∏–±–∏–æ –ì–æ–ª–¥ 75–≥—Ä/14—à—Ç –º/—É"
  ],
  "4607066404979": [
    "–ö–æ—Ñ–µ –¢–∏–±–∏–æ –ì–æ–ª–¥ 95–≥—Ä/6—à—Ç —Å—Ç/–±"
  ],
  "4607066405082": [
    "–ö–æ—Ñ–µ –¢–∏–±–∏–æ –≠–∫—Å–∫–ª—é–∑–∏–≤ 75–≥—Ä/14—à—Ç –º/—É",
    "4046234771497"
  ],
  "4046234766974": [
    "–ö–æ—Ñ–µ –¢–∏–±–∏–æ –≠–∫—Å–∫–ª—é–∑–∏–≤ 95–≥—Ä/6—à—Ç —Å—Ç/–±",
    "4607066404931"
  ],
  "4602216001213": [
    "–ö–æ—Ñ–µ –ß–µ—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞ 1000–≥—Ä/6—à—Ç –∑–µ—Ä–Ω–æ –º/—É"
  ],
  "4602216000513": [
    "–ö–æ—Ñ–µ –ß–µ—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞ 500–≥—Ä/6—à—Ç –∑–µ—Ä–Ω–æ –º/—É"
  ],
  "4620007590685": [
    "–ö–æ—Ñ–µ –ß–µ—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞ –ì–æ–ª–¥ 150–≥—Ä/6—à—Ç –º/—É"
  ],
  "4620007590425": [
    "–ö–æ—Ñ–µ –ß–µ—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞ –ì–æ–ª–¥ 285–≥—Ä/6—à—Ç –º/—É"
  ],
  "4620007590692": [
    "–ö–æ—Ñ–µ –ß–µ—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞ –ì–æ–ª–¥ 75–≥—Ä/12—à—Ç –º/—É"
  ],
  "4620007592337": [
    "–ö–æ—Ñ–µ –ß–µ—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞ –ì–æ–ª–¥ 95–≥—Ä/6—à—Ç —Å—Ç/–±"
  ],
  "4620007592405": [
    "–ö–æ—Ñ–µ –ß–µ—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞ –≠–∫—Å–∫–ª –ë—Ä–∞–∑–∏–ª 190–≥—Ä/6—à—Ç —Å—Ç/–±"
  ],
  "4620007592689": [
    "–ö–æ—Ñ–µ –ß–µ—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞ –≠–∫—Å–∫–ª –ë—Ä–∞–∑–∏–ª 75–≥—Ä/12—à—Ç –º/—É"
  ],
  "4607001771678": [
    "–ö–æ—Ñ–µ –Ø–∫–æ–±—Å –ì–æ–ª–¥ 500–≥—Ä/6—à—Ç –º/—É"
  ],
  "8711000578704": [
    "–ö–æ—Ñ–µ –Ø–∫–æ–±—Å –ì–æ–ª–¥ 95–≥—Ä/12—à—Ç —Å—Ç/–±",
    "4607001771517"
  ],
  "4607001773283": [
    "–ö–æ—Ñ–µ –Ø–∫–æ–±—Å –ú–∏–ª–ª–∏–≥—Ä–∞–Ω–æ 70–≥—Ä/12—à—Ç –º/—É"
  ],
  "4607001772903": [
    "–ö–æ—Ñ–µ –Ø–∫–æ–±—Å –ú–æ–Ω–∞—Ä—Ö 1.8–≥—Ä/30—à—Ç/20–±–ª",
    "4607001771548"
  ],
  "4607001772750": [
    "–ö–æ—Ñ–µ –Ø–∫–æ–±—Å –ú–æ–Ω–∞—Ä—Ö 130–≥—Ä/9—à—Ç –º/—É",
    "4607001779452",
    "8714599512197",
    "4607001772774"
  ],
  "4607001771814": [
    "–ö–æ—Ñ–µ –Ø–∫–æ–±—Å –ú–æ–Ω–∞—Ä—Ö 210–≥—Ä/6—à—Ç –º/—É"
  ],
  "4607001772255": [
    "–ö–æ—Ñ–µ –Ø–∫–æ–±—Å –ú–æ–Ω–∞—Ä—Ö 3–≤1 –ö–ª–∞—Å—Å–∏–∫ 24—à—Ç/10–±–ª",
    "4607001772248"
  ],
  "4607001773214": [
    "–ö–æ—Ñ–µ –Ø–∫–æ–±—Å –ú–æ–Ω–∞—Ä—Ö 3–≤1 –ö—Ä–µ–ø–∫–∏–π 24—à—Ç/10–±–ª",
    "4607001773207"
  ],
  "4607001773191": [
    "–ö–æ—Ñ–µ –Ø–∫–æ–±—Å –ú–æ–Ω–∞—Ä—Ö 3–≤1 –ú—è–≥–∫–∏–π 24—à—Ç/10–±–ª",
    "4607001773184"
  ],
  "4607001772477": [
    "–ö–æ—Ñ–µ –Ø–∫–æ–±—Å –ú–æ–Ω–∞—Ä—Ö 47.5–≥—Ä/12—à—Ç —Å—Ç/–±",
    "4607001771760"
  ],
  "4607001772941": [
    "–ö–æ—Ñ–µ –Ø–∫–æ–±—Å –ú–æ–Ω–∞—Ä—Ö 500–≥—Ä/6—à—Ç –º/—É",
    "4607001771838"
  ],
  "8714599512043": [
    "–ö–æ—Ñ–µ –Ø–∫–æ–±—Å –ú–æ–Ω–∞—Ä—Ö 75–≥—Ä/15—à—Ç –º/—É",
    "4607001771807"
  ],
  "4607001772309": [
    "–ö–æ—Ñ–µ –Ø–∫–æ–±—Å –ú–æ–Ω–∞—Ä—Ö 95–≥—Ä/12—à—Ç —Å—Ç/–±",
    "4607001771784",
    "8714599524220",
    "4607001776512"
  ],
  "7622201511135": [
    "–õ–µ–¥ –•–æ–ª–ª—Å –ê–ø–µ–ª—å—Å–∏–Ω/–í–∏—Ç–∞–º–∏–Ω –° 12—à—Ç/30–±–ª"
  ],
  "4650065522830": [
    "–ß–∞–π –ê–∫–±–∞—Ä –ó–æ–ª–æ—Ç–æ–π 100–ø–∞–∫/6—à—Ç —Å/—è"
  ],
  "4650065520973": [
    "–ß–∞–π –ê–∫–±–∞—Ä –ö—Ä–∞—Å–Ω–æ/–ë–µ–ª—ã–π 100–ø–∞–∫/6—à—Ç —Å/—è"
  ],
  "4650065521154": [
    "–ß–∞–π –ê–∫–±–∞—Ä –ö—Ä–∞—Å–Ω–æ/–ë–µ–ª—ã–π 25–ø–∞–∫/15—à—Ç —Å/—è"
  ],
  "4607051150676": [
    "–ß–∞–π –ö–æ—Ä–æ–Ω–∞ –†–æ—Å –ò–º–ø–µ—Ä 100–≥—Ä/16—à—Ç –ª–∏—Å—Ç"
  ],
  "4607051150270": [
    "–ß–∞–π –ö–æ—Ä–æ–Ω–∞ –†–æ—Å –ò–º–ø–µ—Ä 100–ø–∞–∫/6—à—Ç"
  ],
  "4607051150683": [
    "–ß–∞–π –ö–æ—Ä–æ–Ω–∞ –†–æ—Å –ò–º–ø–µ—Ä 200–≥—Ä/12—à—Ç –ª–∏—Å—Ç"
  ],
  "4607051150720": [
    "–ß–∞–π –ö–æ—Ä–æ–Ω–∞ –†–æ—Å –ò–º–ø–µ—Ä 25–ø–∞–∫/18—à—Ç"
  ],
  "4607051150478": [
    "–ß–∞–π –õ–∏—Å–º–∞ –ö—Ä–µ–ø–∫–∏–π 100–ø–∞–∫/6—à—Ç —Å/—è"
  ],
  "4607051150201": [
    "–ß–∞–π –õ–∏—Å–º–∞ –ö—Ä–µ–ø–∫–∏–π 25–ø–∞–∫/18—à—Ç —Å/—è"
  ],
  "4607051153417": [
    "–ß–∞–π –õ–∏—Å–º–∞ –ö—Ä–µ–ø–∫–∏–π 300–≥—Ä/18—à—Ç –º/—É"
  ],
  "4620015850269": [
    "–ß–∞–π –õ–∏—Å–º–∞ –ù–∞—Å—ã—â–µ–Ω–Ω—ã–π 100–ø–∞–∫/6—à—Ç —Å/—è"
  ],
  "4620015850252": [
    "–ß–∞–π –õ–∏—Å–º–∞ –ù–∞—Å—ã—â–µ–Ω–Ω—ã–π 25–ø–∞–∫/18—à—Ç —Å/—è"
  ],
  "4607051151369": [
    "–ß–∞–π –ú–∞–π—Å–∫–∏–π –û—Ç–±–æ—Ä–Ω—ã–π 100–ø–∞–∫/6—à—Ç —Å/—è"
  ],
  "4607051151345": [
    "–ß–∞–π –ú–∞–π—Å–∫–∏–π –û—Ç–±–æ—Ä–Ω—ã–π 25–ø–∞–∫/18—à—Ç —Å/—è"
  ],
  "4605246002014": [
    "–ß–∞–π –ü—Ä–∏–Ω—Ü–µ—Å—Å–∞ –ù—É—Ä–∏ –í—ã—Å–æ–∫ 100–ø–∞–∫/18—à—Ç —Å/—è"
  ],
  "4605246001970": [
    "–ß–∞–π –ü—Ä–∏–Ω—Ü–µ—Å—Å–∞ –ù—É—Ä–∏ –í—ã—Å–æ–∫ 25–ø–∞–∫/18—à—Ç —Å/—è"
  ],
  "4620015851778": [
    "–ß–∞–π –†–∏—á–∞—Ä–¥ –†–æ—è–ª –ò–Ω–≥–ª –ë—Ä–µ–∫—Ñ–∞—Å—Ç 100–ø–∞–∫/6—à—Ç —Å/—è"
  ],
  "4607051159945": [
    "–ß–∞–π –†–∏—á–∞—Ä–¥ –†–æ—è–ª –¶–µ–π–ª–æ–Ω 100–ø–∞–∫/6—à—Ç —Å/—è"
  ],
  "4607051159938": [
    "–ß–∞–π –†–∏—á–∞—Ä–¥ –†–æ—è–ª –¶–µ–π–ª–æ–Ω 25–ø–∞–∫/12—à—Ç —Å/—è"
  ],
  "4605504515188": [
    "–®–æ–∫ –ê–ª–µ–Ω–∫–∞ 15–≥—Ä/42—à—Ç/7–±–ª",
    "4600300000609"
  ],
  "4603955002165": [
    "–®–æ–∫ –ê–ª–µ–Ω–∫–∞ 200–≥—Ä/18—à—Ç"
  ],
  "4600300098552": [
    "–®–æ–∫ –ê–ª–µ–Ω–∫–∞ 75–≥—Ä/16—à—Ç/6–±–ª",
    "4600080294250"
  ],
  "7622201427061": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –ê—Ä–∞—Ö–∏—Å/–ö—É–∫—É—Ä —Ö–ª–æ–ø—å—è 80–≥—Ä/21—à—Ç",
    "7622201696078"
  ],
  "7622201696344": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –ë–µ–ª—ã–π –º–∏–Ω–ª–∞–ª—å/–ö–æ–∫–æ—Å 90–≥—Ä/21—à—Ç"
  ],
  "7622201137083": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –ò–Ω–∂–∏—Ä/–ö–æ–∫–æ—Å 80–≥—Ä/20—à—Ç",
    "7622201696283"
  ],
  "7622201706289": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –ô–æ–≥—É—Ä—Ç/–ö–ª—É–±–Ω–∏–∫–∞ 90–≥—Ä/21—à—Ç"
  ],
  "7622201700553": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –ô–æ–≥—É—Ä—Ç/–ß–µ—Ä–Ω–∏–∫–∞ 90–≥—Ä/21—à—Ç"
  ],
  "7622201700768": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –ö–∞–ø—É—á–∏–Ω–æ 90–≥—Ä/21—à—Ç"
  ],
  "7622202220838": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –ú–æ–ª–æ—á–Ω—ã–π 90–≥—Ä/21—à—Ç",
    "7622201695927"
  ],
  "7622201700645": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –û—Ä–µ–æ 85–≥—Ä/19—à—Ç"
  ],
  "7622202047206": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –û—Ä–µ–æ –î–≤–∞ —à–æ–∫–æ–ª–∞–¥–∞ 85–≥—Ä/19—à—Ç"
  ],
  "7622201500658": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –û—Ä–µ–æ –ö–ª—É–±–Ω–∏–∫–∞ 85–≥—Ä/19—à—Ç",
    "7622202047961"
  ],
  "7622202048234": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –û—Ä–µ–æ –ß–µ—Ä–Ω–∏–∫–∞ 85–≥—Ä/19—à—Ç"
  ],
  "7622201700706": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –û—Ä–µ–æ –ß–∏–∑–∫–µ–π–∫ 85–≥—Ä/19—à—Ç"
  ],
  "7622201700737": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –û—Ä–µ–æ –®–æ–∫–æ–ª–∞–¥ 85–≥—Ä/19—à—Ç"
  ],
  "7622201766610": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –ü–∏–Ω–∞–∫–æ–ª–∞–¥–∞ 80–≥—Ä/20—à—Ç"
  ],
  "7622201696313": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –°–æ–ª–µ–Ω—ã–π –∞—Ä–∞—Ö–∏—Å/–ö—Ä–µ–∫–µ—Ä 90–≥—Ä/21—à—Ç"
  ],
  "7622201696047": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –°–æ–ª–µ–Ω—ã–π –º–∏–Ω–¥–∞–ª—å/–ö–∞—Ä–∞–º–µ–ª—å 80–≥—Ä/21—à—Ç"
  ],
  "7622202007743": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –¢—Ä–æ–ø–∏—á–µ—Å–∫–∏–π –∫–æ–∫–æ—Å 80–≥—Ä/21—à—Ç"
  ],
  "7622201695958": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –§—É–Ω–¥—É–∫ 90–≥—Ä/21—à—Ç"
  ],
  "7622201695989": [
    "–®–æ–∫ –ê–ª—å–ø–µ–Ω –ì–æ–ª–¥ –§—É–Ω–¥—É–∫/–ò–∑—é–º 90–≥—Ä/21—à—Ç"
  ],
  "4600823030091": [
    "–®–æ–∫ –ë–∞–±–∞–µ–≤—Å–∫–∏–π –±–∞—Ç –°–ª–∏–≤–æ—á–Ω—ã–π 50–≥—Ä/20—à—Ç/6–±–ª"
  ],
  "4600823651319": [
    "–®–æ–∫ –ë–∞–±–∞–µ–≤—Å–∫–∏–π –õ—é–∫—Å 75–≥—Ä/19—à—Ç/4–±–ª",
  ],
  "7622210343161": [
    "–®–æ–∫ –í–æ–∑–¥—É—à–Ω—ã–π –ë–µ–ª—ã–π 85–≥—Ä/20—à—Ç",
    "7622201777142"
  ],
  "7622201777227": [
    "–®–æ–∫ –í–æ–∑–¥—É—à–Ω—ã–π –ú–æ–ª–æ—á–Ω—ã–π 85–≥—Ä/20—à—Ç"
  ],
  "7622201777111": [
    "–®–æ–∫ –í–æ–∑–¥—É—à–Ω—ã–π –¢–µ–º–Ω—ã–π 85–≥—Ä/20—à—Ç"
  ],
  "4008400200217": [
    "–®–æ–∫ –ö–∏–Ω–¥–µ—Ä 100–≥—Ä/10—à—Ç/4–±–ª",
    "40084701"
  ],
  "8000500033784": [
    "–®–æ–∫ –ö–∏–Ω–¥–µ—Ä 50–≥—Ä/20—à—Ç/4–±–ª",
    "80177609"
  ],
  "7622201769444": [
    "–®–æ–∫ –ú–∏–ª–∫–∞ –ë–∞–±–±–ª—Å –ë–∞–Ω–∞–Ω/–ô–æ–≥—É—Ä—Ç 87–≥—Ä/16—à—Ç",
    "7622202048623"
  ],
  "7622202048685": [
    "–®–æ–∫ –ú–∏–ª–∫–∞ –ë–∞–±–±–ª—Å –ú–æ–ª–æ—á–Ω—ã–π 87–≥—Ä/16—à—Ç"
  ],
  "7622202048296": [
    "–®–æ–∫ –ú–∏–ª–∫–∞ –¥—Ä–æ–±–ª –§—É–Ω–¥—É–∫ 80–≥—Ä/20—à—Ç"
  ],
  "7622210345806": [
    "–®–æ–∫ –ú–∏–ª–∫–∞ –ö–∞—Ä–∞–º–µ–ª—å 80–≥—Ä/20—à—Ç",
    "7622201769574"
  ],
  "7622202048487": [
    "–®–æ–∫ –ú–∏–ª–∫–∞ –ö–ª—É–±–Ω–∏–∫–∞ 80–≥—Ä/20—à—Ç"
  ],
  "7622202048517": [
    "–®–æ–∫ –ú–∏–ª–∫–∞ –ú–∏–Ω–¥–∞–ª—å/–õ–µ—Å–Ω —è–≥–æ–¥—ã 80–≥—Ä/20—à—Ç"
  ],
  "7622202048326": [
    "–®–æ–∫ –ú–∏–ª–∫–∞ –ú–æ–ª–æ—á–Ω—ã–π 80–≥—Ä/20—à—Ç"
  ],
  "7622202048562": [
    "–®–æ–∫ –ú–∏–ª–∫–∞ –û—Ä–µ—Ö–æ–≤–∞—è –ø–∞—Å—Ç–∞ 80–≥—Ä/20—à—Ç",
    "7622202237140"
  ],
  "7622202048357": [
    "–®–æ–∫ –ú–∏–ª–∫–∞ –§—É–Ω–¥—É–∫/–ò–∑—é–º 80–≥—Ä/20—à—Ç"
  ],
  "7622201773472": [
    "–®–æ–∫ –ú–∏–ª–∫–∞ —Ü–µ–ª—å–Ω—ã–π –ú–∏–Ω–¥–∞–ª—å 80–≥—Ä/20—à—Ç",
    "7622202048456"
  ],
  "7622201771140": [
    "–®–æ–∫ –ú–∏–ª–∫–∞ —Ü–µ–ª—å–Ω—ã–π –§—É–Ω–¥—É–∫ 80–≥—Ä/19—à—Ç",
    "7622202048388"
  ],
  "4607065001445": [
    "–®–æ–∫ –°–Ω–∏–∫–µ—Ä—Å –±–∞—Ç 50.5–≥—Ä/48—à—Ç/6–±–ª"
  ],
  "4660085515163": [
    "–®–æ–∫ –°–Ω–∏–∫–µ—Ä—Å –°—É–ø–µ—Ä –±–∞—Ç 80–≥—Ä/32—à—Ç/4–±–ª"
  ]
};
    let barcodeAliasMap=new Map(),synonymsLoaded=false,_usingBuiltin=true;
    function _buildAliasMap(j){const m=new Map();Object.keys(j).forEach(k=>{const mk=String(k).trim();if(!mk)return;m.set(mk,mk);const l=j[k];if(Array.isArray(l))l.forEach(b=>{const v=String(b).trim();if(v)m.set(v,mk);});});return m;}
    barcodeAliasMap=_buildAliasMap(BUILTIN_SYNONYMS);synonymsLoaded=true;

    function resetBarcodeAliases(){
        barcodeAliasMap=_buildAliasMap(BUILTIN_SYNONYMS);synonymsLoaded=true;_usingBuiltin=true;
        const s=document.getElementById('synonymsStatus');if(s){s.style.color='#34c759';s.textContent='–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–∏–Ω–æ–Ω–∏–º–æ–≤ (166 –≥—Ä—É–ø–ø)';}
    }

    function loadBarcodeAliasesFromFile(file) {
        const status = document.getElementById('synonymsStatus');
        if (!file) {
            resetBarcodeAliases();
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const json = JSON.parse(text);
                barcodeAliasMap=_buildAliasMap(json);synonymsLoaded=true;_usingBuiltin=false;
                if(status){status.style.color='#34c759';status.textContent='–ó–∞–≥—Ä—É–∂–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∞–π–ª, –≥—Ä—É–ø–ø: '+Object.keys(json).length;}
                if (allFilesData.length > 0) {
                    processData();
                    renderTable();
                    updateUI();
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è synonyms.json:', err);
                resetBarcodeAliases();
                if (status) {
                    status.style.color = '#ff3b30';
                    status.textContent = '–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON';
                }
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ —Å–∏–Ω–æ–Ω–∏–º–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç JSON.');
            }
        };
        reader.onerror = () => {
            resetBarcodeAliases();
            if (status) {
                status.style.color = '#ff3b30';
                status.textContent = '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞';
            }
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª —Å–∏–Ω–æ–Ω–∏–º–æ–≤.');
        };
        reader.readAsText(file, 'utf-8');
    }

    function canonicalizeBarcode(rawBarcode) {
        if (rawBarcode === undefined || rawBarcode === null) return { canonical: rawBarcode, wasSynonym: false };
        const b = String(rawBarcode).trim();
        if (!synonymsLoaded) return { canonical: b, wasSynonym: false };
        const canon = barcodeAliasMap.get(b);
        if (canon && canon !== b) {
            return { canonical: canon, wasSynonym: true };
        }
        return { canonical: b, wasSynonym: false };
    }

    // ======== –û–°–ù–û–í–ù–û–ô –ö–û–î –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ========

    let myPriceData = null;
    let competitorFilesData = [];
    let allFilesData = [];
    let groupedData = [];
    let allColumns = [];
    let visibleColumns = new Set();
    let cart = new Set();
    let barcodeColumn = null;
    let nameColumn = null;
    let stockColumn = null; // –∫–æ–ª–æ–Ω–∫–∞ –æ—Å—Ç–∞—Ç–∫–∞ –≤ –ú–û–Å–ú –ø—Ä–∞–π—Å–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    let sortMode = 'default';
    let compactMatches = false;
    let searchQuery = '';
    let barcodeSortOrder = 0;
    let showFileBarcodes = false; // UI: –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –ª–∏ –∫–æ–ª–æ–Ω–∫–∏ –®–ö –ø–æ —Ñ–∞–π–ª–∞–º

    const myPriceInput = document.getElementById('myPriceInput');
    const competitorInput = document.getElementById('competitorInput');
    const synonymsInput = document.getElementById('synonymsInput');
    const searchInput = document.getElementById('searchInput');
    const sortMatchesBtn = document.getElementById('sortMatchesBtn');
    const bigDiffBtn = document.getElementById('bigDiffBtn');
    const showMyPriceBtn = document.getElementById('showMyPriceBtn');
    const showCartBtn = document.getElementById('showCartBtn');
    const compactMatchesBtn = document.getElementById('compactMatchesBtn');
    const maxCoverageBtn = document.getElementById('maxCoverageBtn');
    const toggleFileBarcodesBtn = document.getElementById('toggleFileBarcodesBtn');
    const exportMyPriceBtn = document.getElementById('exportMyPriceBtn');
    const exportAllBtn = document.getElementById('exportAllBtn');
    const exportCartBtn = document.getElementById('exportCartBtn');
    const clearCartBtn = document.getElementById('clearCartBtn');
    const sortPayBtn=document.getElementById('sortPayBtn');
    const downloadSynBtn=document.getElementById('downloadSynBtn');
    const resetSynBtn=document.getElementById('resetSynBtn');
    const clearBtn=document.getElementById('clearBtn');
    const infoPanel = document.getElementById('infoPanel');
    const hiddenColumnsPanel = document.getElementById('hiddenColumnsPanel');
    const hiddenColumnsList = document.getElementById('hiddenColumnsList');
    const tableContainer = document.getElementById('tableContainer');
    const cartBadge = document.getElementById('cartBadge');

    const BARCODE_SYNONYMS = [
        '—à—Ç—Ä–∏—Ö-–∫–æ–¥', '—à—Ç—Ä–∏—Ö–∫–æ–¥', 'barcode', '–®—Ç—Ä–∏—Ö-–∫–æ–¥', '–®—Ç—Ä–∏—Ö–∫–æ–¥', 'Barcode',
        '–∫–æ–¥', '–ö–æ–¥', 'ean', 'EAN', 'ean13', 'EAN13', '—à—Ç—Ä–∏—Ö –∫–æ–¥', '–®—Ç—Ä–∏—Ö –∫–æ–¥',
        'bar_code', 'bar-code', 'product_code', 'sku', 'SKU', '–∞—Ä—Ç–∏–∫—É–ª', '–ê—Ä—Ç–∏–∫—É–ª'
    ];

    const NAME_SYNONYMS = [
        '–Ω–∞–∑–≤–∞–Ω–∏–µ', 'name', '–ù–∞–∑–≤–∞–Ω–∏–µ', 'Name', '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ',
        '—Ç–æ–≤–∞—Ä', '–¢–æ–≤–∞—Ä', 'product', 'Product', '–æ–ø–∏—Å–∞–Ω–∏–µ', '–û–ø–∏—Å–∞–Ω–∏–µ',
        'product_name', 'title', 'Title', '–∏–º—è', '–ò–º—è'
    ];

    myPriceInput.addEventListener('change', handleMyPriceUpload);
    competitorInput.addEventListener('change', handleCompetitorUpload);
    synonymsInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        loadBarcodeAliasesFromFile(file);
    });
    searchInput.addEventListener('input', handleSearch);
    sortMatchesBtn.addEventListener('click', toggleSortMatches);
    bigDiffBtn.addEventListener('click', toggleBigDiff);
    showMyPriceBtn.addEventListener('click', toggleMyPriceView);
    showCartBtn.addEventListener('click', toggleCartView);
    compactMatchesBtn.addEventListener('click', toggleCompactMatches);
    maxCoverageBtn.addEventListener('click', toggleMaxCoverage);
    toggleFileBarcodesBtn.addEventListener('click', toggleFileBarcodesVisibility);
exportMyPriceBtn.addEventListener('click', async () => await generateExcel('myprice'));
exportAllBtn.addEventListener('click', async () => await generateExcel('all'));
exportCartBtn.addEventListener('click', async () => await generateExcel('cart'));

    clearCartBtn.addEventListener('click', clearCart);
    sortPayBtn.addEventListener('click',applySortByPayment);
    downloadSynBtn.addEventListener('click',downloadCurrentSynonyms);
    resetSynBtn.addEventListener('click',()=>{resetBarcodeAliases();document.getElementById('synonymsInput').value='';if(allFilesData.length>0){processData();renderTable();updateUI();}});
    clearBtn.addEventListener('click', clearAll);

    function normalizeString(str) {
        return str?.toString().trim().toLowerCase() || '';
    }



// --- Deduplicate same-price duplicates inside one supplier file ---
const PRICE_COL_SYNONYMS = [
  '—Ü–µ–Ω–∞', 'price', 'cost', '—Å—Ç–æ–∏–º–æ—Å—Ç—å', '–ø—Ä–∞–π—Å', '–æ–ø—Ç', '–æ–ø—Ç–æ–≤', '—Ä–æ–∑–Ω', '—Ä—Ä—Ü', '—Ä—Ü',
  'retail', 'wholesale'
];

const MY_PRICE_FILE_NAME = 'üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å';
const META_STOCK_KEY = '__meta_stock';
const META_TRANSIT_KEY = '__meta_transit';
const STOCK_COL_SYNONYMS = ['–æ—Å—Ç–∞—Ç–æ–∫', '–æ—Å—Ç–∞—Ç–∫–∏', '–Ω–∞–ª–∏—á–∏–µ', '—Å–∫–ª–∞–¥'];


const PRICE_DECIMALS = 1;

function roundPrice(n) {
  const m = 10 ** PRICE_DECIMALS;
  return Math.round(n * m) / m;
}


function isPriceLikeColumn(colName) {
  const s = String(colName || '').toLowerCase();
  // –ò—Å–∫–ª—é—á–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏
  const isStock = STOCK_COL_SYNONYMS.some(k => s.includes(k));
  if (isStock) return false;
  return PRICE_COL_SYNONYMS.some(k => s.includes(k));
}


function parsePriceNumber(val) {
  const s = String(val ?? '').trim();
  if (!s) return null;
  const n = parseFloat(s.replace(/[^0-9.,-]/g, '').replace(',', '.'));
  return Number.isFinite(n) ? n : null;
}

function getColPayGroup(col){const n=(col.displayName||col.columnName||"").toLowerCase();if(n.includes("–Ω–∞–ª"))return"–Ω–∞–ª";if(n.includes("–±–Ω"))return"–±–Ω";return"other";}
function extractPackQtyFromName(name) {
  const s = String(name ?? '');
  // –õ—é–±–æ–µ —á–∏—Å–ª–æ –ø–µ—Ä–µ–¥ "—à—Ç"/"—à—Ç—É–∫": 30—à—Ç/24–±–ª, 30 —à—Ç, 30 —à—Ç.
  const m = s.match(/(\d{1,6})\s*(?:—à—Ç|—à—Ç—É–∫)(?=[^0-9A-Za-z–ê-–Ø–∞-—è]|$)/i);
  if (!m) return null;
  const q = parseInt(m[1], 10);
  if (!Number.isFinite(q) || q <= 1) return null;
  return q;
}


function round2(n) {
  return Math.round(n * 100) / 100;
}

function samePrice(a, b) {
  const na = parsePriceNumber(a);
  const nb = parsePriceNumber(b);
  if (na !== null && nb !== null) return roundPrice(na) === roundPrice(nb);
  return String(a ?? '').trim() === String(b ?? '').trim();
}
    function removeFileExtension(fileName) {
        return fileName.replace(/\.(csv|xlsx|xls)$/i, '');
    }

    function handleSearch(e) {
        searchQuery = e.target.value.toLowerCase().trim();
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    async function handleMyPriceUpload(e) {
        try {
            const file = e.target.files[0];
            if (!file) return;
            myPriceData = await parseFile(file, 'üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å');
            processAllData();
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:", error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: " + error.message);
        }
    }

    async function handleCompetitorUpload(e) {
        try {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            competitorFilesData = [];
            for (const file of files) {
                const fileData = await parseFile(file, removeFileExtension(file.name));
                competitorFilesData.push(fileData);
            }
            processAllData();
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:", error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤: " + error.message);
        }
    }

    async function parseFile(file, fileName) {
        try {
            if (file.name.endsWith('.csv')) {
                return await parseCSV(file, fileName);
            } else {
                return await parseExcel(file, fileName);
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:", error);
            throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª");
        }
    }

    function parseCSV(file, fileName) {
        return new Promise(resolve => {
            Papa.parse(file, {
                header: true,
                encoding: 'UTF-8',
                skipEmptyLines: true,
                complete: (results) => {
                    resolve({
                        fileName,
                        data: results.data,
                        isMyPrice: fileName === 'üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å'
                    });
                }
            });
        });
    }

    function parseExcel(file, fileName) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                resolve({fileName, data: jsonData, isMyPrice: fileName === 'üè∑Ô∏è –ú–æ–π –ø—Ä–∞–π—Å'});
            };
            reader.readAsArrayBuffer(file);
        });
    }

    function processAllData() {
        if (!myPriceData && competitorFilesData.length === 0) return;
        allFilesData = [];
        if (myPriceData) allFilesData.push(myPriceData);
        allFilesData = allFilesData.concat(competitorFilesData);

        autoDetectColumns();
        processData();
        updateHiddenColumnsPanel();
        renderTable();
        updateUI();
    }

    function autoDetectColumns() {
        allColumns = [];
        visibleColumns.clear();
        stockColumn = null;
        barcodeColumn = null;
        nameColumn = null;

        if (allFilesData.length > 0 && allFilesData[0].data.length > 0) {
            const firstFileColumns = Object.keys(allFilesData[0].data[0]);
            barcodeColumn = firstFileColumns.find(col =>
                BARCODE_SYNONYMS.some(syn => col.toLowerCase().includes(syn.toLowerCase()))
            ) || firstFileColumns[0];

            nameColumn = firstFileColumns.find(col =>
                col !== barcodeColumn &&
                NAME_SYNONYMS.some(syn => col.toLowerCase().includes(syn.toLowerCase()))
            ) || (firstFileColumns.length > 1 ? firstFileColumns[1] : firstFileColumns[0]);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–ª—å–∫–æ –≤ –º–æ–µ–º –ø—Ä–∞–π—Å–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if (myPriceData && myPriceData.data && myPriceData.data.length > 0) {
            const myCols = Object.keys(myPriceData.data[0]);
            stockColumn = myCols.find(c => STOCK_COL_SYNONYMS.some(s => String(c).toLowerCase().includes(s))) || null;
        }

        }

        allFilesData.forEach(({fileName, data}) => {
            if (data.length > 0) {
                const fileColumns = Object.keys(data[0]);
                fileColumns.forEach(colName => {
            if (colName === barcodeColumn || colName === nameColumn) return;
            if (fileName === MY_PRICE_FILE_NAME && stockColumn && colName === stockColumn) return;
                    const colKey = `${fileName}|${colName}`;
                    allColumns.push({
                        fileName,
                        columnName: colName,
                        displayName: `${fileName} - ${colName}`,
                        key: colKey
                    });
                    visibleColumns.add(colKey);
                });
            }
        });
    

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –û—Å—Ç–∞—Ç–æ–∫ –∏ –í –ø—É—Ç–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –º–æ–µ–º –ø—Ä–∞–π—Å–µ –µ—Å—Ç—å –æ—Å—Ç–∞—Ç–æ–∫)
        if (stockColumn) {
            const stockCol = { fileName: MY_PRICE_FILE_NAME, columnName: '–û—Å—Ç–∞—Ç–æ–∫', displayName: '–û—Å—Ç–∞—Ç–æ–∫', key: META_STOCK_KEY, metaType: 'stock' };
            const transitCol = { fileName: MY_PRICE_FILE_NAME, columnName: '–í –ø—É—Ç–∏', displayName: '–í –ø—É—Ç–∏', key: META_TRANSIT_KEY, metaType: 'transit' };
            allColumns.unshift(transitCol);
            allColumns.unshift(stockCol);
            visibleColumns.add(META_STOCK_KEY);
            visibleColumns.add(META_TRANSIT_KEY);
        }
        const _am=allColumns.filter(c=>c.metaType);const _ap=allColumns.filter(c=>!c.metaType&&c.fileName===MY_PRICE_FILE_NAME);const _as=allColumns.filter(c=>!c.metaType&&c.fileName!==MY_PRICE_FILE_NAME);
        _as.sort((a,b)=>{const o={"–Ω–∞–ª":0,"–±–Ω":1,"other":2};return(o[getColPayGroup(a)]??2)-(o[getColPayGroup(b)]??2);});allColumns=[..._am,..._ap,..._as];
}

    function toggleColumn(colKey) {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (visibleColumns.has(colKey)) visibleColumns.delete(colKey);
        else visibleColumns.add(colKey);
        updateHiddenColumnsPanel();
        processData();
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function updateHiddenColumnsPanel() {
        const hiddenCols = allColumns.filter(col => !visibleColumns.has(col.key));
        if (hiddenCols.length > 0) {
            let html = '';
            hiddenCols.forEach(col => {
                html += `<button class="restore-column-btn" onclick="toggleColumn('${col.key}')" title="–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É ${col.displayName}">
                        ‚Ü©Ô∏è ${col.displayName}
                    </button>`;
            });
            hiddenColumnsList.innerHTML = html;
            hiddenColumnsPanel.style.display = 'flex';
        } else {
            hiddenColumnsPanel.style.display = 'none';
        }
    }

    function processData() {
        const barcodeMap = new Map();

        allFilesData.forEach(({fileName, data, isMyPrice}) => {
            data.forEach((row, index) => {
                let rawBarcode = row[barcodeColumn];
                if (!rawBarcode) return;

                const { canonical, wasSynonym } = canonicalizeBarcode(rawBarcode);
                const barcode = canonical;

                if (!barcodeMap.has(barcode)) {
                    barcodeMap.set(barcode, {
                        barcode,
                        names: [],
                        values: new Map(),
                        isInMyPrice: false,
                        myPriceOrder: -1,
                        filesWithBarcode: new Set(),
                        namesByFile: new Map(),
                        originalBarcodesByFile: new Map(),
                        isSynonym: false
                    });
                }

                const item = barcodeMap.get(barcode);
                item.filesWithBarcode.add(fileName);
                item.originalBarcodesByFile.set(fileName, rawBarcode);

                if (wasSynonym) {
                    item.isSynonym = true;
                }

                if (isMyPrice) {
                    item.isInMyPrice = true;
                    item.myPriceOrder = index;
                }

                const currentRowName = row[nameColumn];

                    // –û—Å—Ç–∞—Ç–æ–∫ —Ç–æ–ª—å–∫–æ –∏–∑ –º–æ–µ–≥–æ –ø—Ä–∞–π—Å–∞ (–µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –Ω–∞–π–¥–µ–Ω–∞)
                    if (isMyPrice && stockColumn) {
                        const stockVal = row[stockColumn];
                        if (!item.values.has(META_STOCK_KEY)) item.values.set(META_STOCK_KEY, []);
                        const arrStock = item.values.get(META_STOCK_KEY);
                        arrStock.length = 0;
                        arrStock.push({ val: (stockVal === undefined || stockVal === null) ? '' : stockVal, rowName: currentRowName, originalBarcode: rawBarcode, meta: true });
                    }
                if (currentRowName) {
                    const nameObj = {fileName, name: currentRowName};
                    if (!item.names.some(n => n.fileName === fileName && n.name === currentRowName)) {
                        item.names.push(nameObj);
                    }
                    if (!item.namesByFile.has(fileName)) {
                        item.namesByFile.set(fileName, currentRowName);
                    }

                    if (isMyPrice) {
                        // –ë–µ—Ä—ë–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ª—å–∫–æ –∏–∑ –º–æ–µ–≥–æ –ø—Ä–∞–π—Å–∞, –Ω–æ –∏—â–µ–º –Ω–µ —Ç–æ–ª—å–∫–æ –≤ nameColumn
                        const vals = Object.values(row).map(v => (v === undefined || v === null) ? '' : String(v));
                        for (const t of vals) {
                            const q = extractPackQtyFromName(t);
                            if (q) { item.packQty = q; break; }
                        }
                    }
                }

                Object.keys(row).forEach(colName => {
                    if (colName !== barcodeColumn && colName !== nameColumn) {
                        const key = `${fileName}|${colName}`;
                        const value = row[colName];
                        if (value !== undefined && value !== null && value !== '') {
                            if (!item.values.has(key)) {
                                item.values.set(key, []);
                            }
                            const arr = item.values.get(key);

                            // –î–ª—è –∫–æ–ª–æ–Ω–æ–∫ —Å —Ü–µ–Ω–æ–π: –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ü–µ–Ω—ã –Ω–µ —Å–æ–∑–¥–∞—é—Ç –Ω–æ–≤—É—é –≤–∞—Ä–∏–∞—Ü–∏—é
                            if (isPriceLikeColumn(colName)) {
                                const exists = arr.some(v => samePrice(v.val, value));
                                if (!exists) {
                                    arr.push({val: value, rowName: currentRowName, originalBarcode: rawBarcode});
                                }
                            } else {
                                arr.push({val: value, rowName: currentRowName, originalBarcode: rawBarcode});
                            }
                        }
                    }
                });
            });
        });

        groupedData = Array.from(barcodeMap.values()).map(item => {
            const visibleCols = allColumns.filter(col => visibleColumns.has(col.key));
            const numericValues = [];
            visibleCols.forEach(col => {
                const valuesArr = item.values.get(col.key);
                if (valuesArr && valuesArr.length > 0) {
                    valuesArr.forEach(vObj => {
                        const numValue = parseFloat(String(vObj.val).replace(/[^0-9.,]/g, '').replace(',', '.'));
                        if (!isNaN(numValue) && numValue > 0) {
                            numericValues.push(numValue);
                        }
                    });
                }
            });



            // –ê–≤—Ç–æ-–¥–µ–ª–µ–Ω–∏–µ: –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω "–ú–æ–π –ø—Ä–∞–π—Å" –∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä 30—à—Ç/24–±–ª),
            // —Ç–æ –¥–µ–ª–∏–º –≤—Å–µ —Ü–µ–Ω—ã –≤ —Å—Ç—Ä–æ–∫–µ, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –≤ 3 —Ä–∞–∑–∞, –Ω–∞ —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.
            const hasMyPriceLoaded = !!myPriceData;
            const packQty = (hasMyPriceLoaded && item.packQty) ? item.packQty : null;
            let autoDivFactor = null;

            if (packQty) {
                // –ê–≤—Ç–æ–ª–æ–≥–∏–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç —Å–∫—Ä—ã—Ç–∏—è –∫–æ–ª–æ–Ω–æ–∫ –≤ UI
                const cols2 = allColumns;

                // –ö–æ–ª–æ–Ω–∫–∏ —Ü–µ–Ω –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ (–º–æ–π –ø—Ä–∞–π—Å –∏—Å–∫–ª—é—á—ë–Ω, meta-–∫–æ–ª–æ–Ω–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã)
                const supplierPriceCols2 = cols2.filter(col => !col.metaType && col.fileName !== MY_PRICE_FILE_NAME && isPriceLikeColumn(col.columnName));

                // –ö–æ–ª–æ–Ω–∫–∏ —Ü–µ–Ω –≤ –º–æ—ë–º –ø—Ä–∞–π—Å–µ (–¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è)
                const myPriceCols2 = cols2.filter(col => !col.metaType && col.fileName === MY_PRICE_FILE_NAME && isPriceLikeColumn(col.columnName));

                const myNums2 = [];
                myPriceCols2.forEach(col => {
                    const arr = item.values.get(col.key);
                    if (!arr || arr.length === 0) return;
                    arr.forEach(v => {
                        const n = parsePriceNumber(v.val);
                        if (n !== null && n > 0) myNums2.push(n);
                    });
                });
                const myMin2 = myNums2.length ? Math.min(...myNums2) : null;

                const supplierNums2 = [];
                supplierPriceCols2.forEach(col => {
                    const arr = item.values.get(col.key);
                    if (!arr || arr.length === 0) return;
                    arr.forEach(v => {
                        const n = parsePriceNumber(v.val);
                        if (n !== null && n > 0) supplierNums2.push(n);
                    });
                });

                if (supplierNums2.length > 0) {
                    const minSupplier = Math.min(...supplierNums2);
                    const thresholdSupplier = minSupplier * 3;

                    // –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: –µ—Å–ª–∏ –∞–±—Å–æ–ª—é—Ç–Ω–æ –≤—Å–µ —Ü–µ–Ω—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ >= (–º–æ—è —Ü–µ–Ω–∞ * 3),
                    // —Ç–æ –¥–µ–ª–∏–º –í–°–ï —Ü–µ–Ω—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –Ω–∞ packQty.
                    const allSuppliers3xAboveMy = (myMin2 !== null) && supplierNums2.every(n => n >= myMin2 * 3);

                    let changed2 = false;
                    supplierPriceCols2.forEach(col => {
                        const arr = item.values.get(col.key);
                        if (!arr || arr.length === 0) return;
                        arr.forEach(vObj => {
                            const n = parsePriceNumber(vObj.val);
                            if (n === null || n <= 0) return;

                            if (allSuppliers3xAboveMy || n >= thresholdSupplier) {
                                if (vObj._autoDiv) return;
                                vObj._origVal = vObj.val;
                                vObj.val = roundPrice(n / packQty);
                                vObj._autoDiv = true;
                                vObj._autoDivFactor = packQty;
                                changed2 = true;
                            }
                        });
                    });

                    if (changed2) autoDivFactor = packQty;
                }
            }
            let priceDiffPercent = 0;
            if (numericValues.length > 1) {
                const minPrice = Math.min(...numericValues);
                const maxPrice = Math.max(...numericValues);
                if (minPrice > 0) {
                    priceDiffPercent = ((maxPrice - minPrice) / minPrice) * 100;
                }
            }

            const priceKeys = new Set(
                allColumns
                    .filter(c => isPriceLikeColumn(c.columnName))
                    .map(c => c.key)
            );

            let isDuplicate = false;
            for (const [key, valuesArr] of item.values.entries()) {
                if (!priceKeys.has(key)) continue;
                if (valuesArr && valuesArr.length > 1) {
                    isDuplicate = true;
                    break;
                }
            }
            const filesWithPrices = new Set();
            for (const [key, valuesArr] of item.values.entries()) {
                if (valuesArr && valuesArr.length > 0) {
                    const fileName = key.split('|')[0];
                    filesWithPrices.add(fileName);
                }
            }
            const coverageCount = filesWithPrices.size;

                        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ (–ø—É—Å—Ç—ã–µ, –µ—Å–ª–∏ –Ω–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è)
            if (stockColumn) {
                if (!item.values.has(META_STOCK_KEY)) {
                    item.values.set(META_STOCK_KEY, [{ val: '', rowName: '', originalBarcode: item.barcode, meta: true }]);
                }
                if (!item.values.has(META_TRANSIT_KEY)) {
                    item.values.set(META_TRANSIT_KEY, [{ val: '', rowName: '', originalBarcode: item.barcode, meta: true }]);
                }
            }

return { barcode: item.barcode, packQty, autoDivFactor,
                names: item.names,
                namesByFile: item.namesByFile,
                values: item.values,
                isInMyPrice: item.isInMyPrice,
                myPriceOrder: item.myPriceOrder,
                originalFileCount: item.filesWithBarcode.size,
                priceDiffPercent,
                isDuplicate,
                coverageCount,
                isSynonym: item.isSynonym,
                originalBarcodesByFile: item.originalBarcodesByFile
            };
        });
    }

    function toggleCart(barcode) {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (cart.has(barcode)) cart.delete(barcode);
        else cart.add(barcode);
        updateCartUI();
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function clearCart() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        cart.clear();
        updateCartUI();
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function updateCartUI() {
        const cartSize = cart.size;
        if (cartSize > 0) {
            cartBadge.textContent = cartSize;
            cartBadge.style.display = 'block';
            exportCartBtn.disabled = false;
            clearCartBtn.disabled = false;
            showCartBtn.disabled = false;
        } else {
            cartBadge.style.display = 'none';
            exportCartBtn.disabled = true;
            clearCartBtn.disabled = true;
            showCartBtn.disabled = true;
            if (sortMode === 'cart') {
                sortMode = 'default';
                showCartBtn.classList.remove('active');
                renderTable();
            }
        }
    }

    function toggleSortMatches() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (sortMode === 'matches') {
            sortMode = 'default';
            sortPayBtn.classList.remove('active');
        sortMatchesBtn.classList.remove('active');
        } else {
            sortMode = 'matches';
            sortMatchesBtn.classList.add('active');
            bigDiffBtn.classList.remove('active');
            showMyPriceBtn.classList.remove('active');
            showCartBtn.classList.remove('active');
            maxCoverageBtn.classList.remove('active');
        }
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleBigDiff() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (sortMode === 'bigdiff') {
            sortMode = 'default';
            bigDiffBtn.classList.remove('active');
        } else {
            sortMode = 'bigdiff';
            bigDiffBtn.classList.add('active');
            sortPayBtn.classList.remove('active');
        sortMatchesBtn.classList.remove('active');
            showMyPriceBtn.classList.remove('active');
            showCartBtn.classList.remove('active');
            maxCoverageBtn.classList.remove('active');
        }
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleMyPriceView() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (sortMode === 'myprice') {
            sortMode = 'default';
            showMyPriceBtn.classList.remove('active');
        } else {
            sortMode = 'myprice';
            showMyPriceBtn.classList.add('active');
            sortPayBtn.classList.remove('active');
        sortMatchesBtn.classList.remove('active');
            bigDiffBtn.classList.remove('active');
            showCartBtn.classList.remove('active');
            maxCoverageBtn.classList.remove('active');
        }
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleCartView() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (sortMode === 'cart') {
            sortMode = 'default';
            showCartBtn.classList.remove('active');
        } else {
            sortMode = 'cart';
            showCartBtn.classList.add('active');
            sortPayBtn.classList.remove('active');
        sortMatchesBtn.classList.remove('active');
            bigDiffBtn.classList.remove('active');
            showMyPriceBtn.classList.remove('active');
            maxCoverageBtn.classList.remove('active');
        }
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleMaxCoverage() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (sortMode === 'maxcoverage') {
            sortMode = 'default';
            maxCoverageBtn.classList.remove('active');
        } else {
            sortMode = 'maxcoverage';
            maxCoverageBtn.classList.add('active');
            sortPayBtn.classList.remove('active');
        sortMatchesBtn.classList.remove('active');
            bigDiffBtn.classList.remove('active');
            showMyPriceBtn.classList.remove('active');
            showCartBtn.classList.remove('active');
        }
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleCompactMatches() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        compactMatches = !compactMatches;
        if (compactMatches) compactMatchesBtn.classList.add('active');
        else compactMatchesBtn.classList.remove('active');
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleBarcodeSort() {
        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        if (barcodeSortOrder === 0) barcodeSortOrder = 1;
        else if (barcodeSortOrder === 1) barcodeSortOrder = -1;
        else barcodeSortOrder = 0;
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    function toggleFileBarcodesVisibility() {
        showFileBarcodes = !showFileBarcodes;
        if (showFileBarcodes) {
            toggleFileBarcodesBtn.classList.add('active');
        } else {
            toggleFileBarcodesBtn.classList.remove('active');
        }
        renderTable();
    }

    function getSortedData() {
        let data = [...groupedData];

        if (searchQuery) {
            data = data.filter(item =>
                item.names.some(n => n.name.toLowerCase().includes(searchQuery))
            );
        }

        if (sortMode === 'matches') {
            data.sort((a, b) => {
                if (a.originalFileCount > 1 && b.originalFileCount === 1) return -1;
                if (a.originalFileCount === 1 && b.originalFileCount > 1) return 1;
                return 0;
            });
        } else if (sortMode === 'bigdiff') {
            data = data.filter(item => item.originalFileCount > 1 && item.priceDiffPercent > 10);
            data.sort((a, b) => b.priceDiffPercent - a.priceDiffPercent);
        } else if (sortMode === 'myprice') {
            data = data.filter(item => item.isInMyPrice);
            data.sort((a, b) => a.myPriceOrder - b.myPriceOrder);
        } else if (sortMode === 'cart') {
            data = data.filter(item => cart.has(item.barcode));
        } else if (sortMode === 'maxcoverage') {
            data.sort((a, b) => b.coverageCount - a.coverageCount);
        }

        if (barcodeSortOrder !== 0) {
            data.sort((a, b) => {
                const bcA = String(a.barcode);
                const bcB = String(b.barcode);
                return barcodeSortOrder === 1 ? bcA.localeCompare(bcB) : bcB.localeCompare(bcA);
            });
        }

        return data;
    }

    function copyBarcode(barcode, btn) {
        if (!navigator.clipboard) return;
        navigator.clipboard.writeText(String(barcode)).then(() => {
            const orig = btn.textContent;
            btn.textContent = '‚úì';
            setTimeout(() => {
                btn.textContent = orig;
            }, 600);
        }).catch(() => {
        });
    }

    function copyBarcodeFromPrice(barcode) {
        if (!navigator.clipboard) return;
        navigator.clipboard.writeText(String(barcode)).then(() => {
            console.log('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω —à—Ç—Ä–∏—Ö–∫–æ–¥:', barcode);
        }).catch(() => {});
    }

    function editColumnName(colKey) {
        const col = allColumns.find(c => c.key === colKey);
        if (!col) return;
        const newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏:', col.displayName);
        if (newName && newName.trim() !== '' && newName.trim() !== col.displayName) {
            col.displayName = newName.trim();
            const wrapper = document.querySelector('.table-wrapper');
            const scrollTop = wrapper ? wrapper.scrollTop : 0;
            updateHiddenColumnsPanel();
            renderTable();
            const newWrapper = document.querySelector('.table-wrapper');
            if (newWrapper) newWrapper.scrollTop = scrollTop;
        }
    }

    function renderTable() {
        const dataToShow = getSortedData();

        if (dataToShow.length === 0) {
            tableContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
                    <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã</p>
                </div>`;
            return;
        }

        const visibleCols = allColumns.filter(col => visibleColumns.has(col.key));

        let html = '<div class="table-wrapper"><table><thead><tr>';
        html += `<th class="col-actions">–ö–æ—Ä–∑–∏–Ω–∞</th>`;

        let sortIcon = '';
        if (barcodeSortOrder === 1) sortIcon = ' ‚ñ≤';
        else if (barcodeSortOrder === -1) sortIcon = ' ‚ñº';
        html += `<th class="col-barcode" onclick="toggleBarcodeSort()" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É">–®—Ç—Ä–∏—Ö–∫–æ–¥ (–∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π)${sortIcon}</th>`;

        // –ö–æ–ª–æ–Ω–∫–∏ —Å–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞–º–∏ –ø–æ —Ñ–∞–π–ª–∞–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç—ã)
        allFilesData.forEach(({fileName}, idx) => {
            const extraClass = showFileBarcodes ? '' : 'hidden-barcode-col';
            html += `<th class="col-barcode file-barcode-col ${extraClass}" data-file-index="${idx}" title="–®—Ç—Ä–∏—Ö–∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞ ${fileName}">–®—Ç—Ä–∏—Ö–∫–æ–¥ (${fileName})</th>`;
        });

        html += `<th class="col-name">${nameColumn}</th>`;

        visibleCols.forEach((col)=>{
            const _isMyP = !col.metaType && col.fileName===MY_PRICE_FILE_NAME;
            const _isMeta = !!col.metaType;
            const _cL = col.metaType ? col.displayName : col.columnName;
            const _fL = col.metaType ? null : col.fileName;
            // –ú–æ–π –ø—Ä–∞–π—Å –∏ –º–µ—Ç–∞: —Ç–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–∫–∞; –ü–æ—Å—Ç–∞–≤—â–∏–∫: —Ñ–∞–π–ª + –∫–æ–ª–æ–Ω–∫–∞
            if(_isMyP||_isMeta){
                const _color = _isMyP ? "#28a745" : "#8e8e93";
                html+=`<th title="${_cL}"><div class="column-header"><div class="column-header-title"><span class="column-name-text" style="color:${_color};font-weight:700;">${_cL}</span></div></div></th>`;
            } else {
                html+=`<th title="${_fL} ‚Äî ${_cL}"><div class="column-header"><div class="column-file-name" title="${_fL}">${_fL}</div><div class="column-header-title"><span class="column-name-text">${_cL}</span></div></div></th>`;
            }
        });

        html += '</tr></thead><tbody>';

        dataToShow.forEach((item, index) => {
            const inCart = cart.has(item.barcode);
            let rowClass = '';
            
            if (item.isSynonym) rowClass = 'synonym-row';
            else if (item.isDuplicate) rowClass = 'duplicate-row';
            
            if (inCart) {
                if (item.isSynonym) rowClass = 'in-cart synonym-row';
                else if (item.isDuplicate) rowClass = 'in-cart duplicate-row';
                else rowClass = 'in-cart';
            } else if (item.isInMyPrice && !item.isDuplicate && !item.isSynonym) {
                rowClass = 'my-price-row';
            }

            const prev = dataToShow[index - 1];
            const next = dataToShow[index + 1];
            const isGroupStart = !prev || prev.barcode !== item.barcode;
            const isGroupEnd = !next || next.barcode !== item.barcode;
            if (isGroupStart) rowClass += (rowClass ? ' ' : '') + 'group-border-top';
            if (isGroupEnd) rowClass += (rowClass ? ' ' : '') + 'group-border-bottom';

            html += `<tr class="${rowClass}">`;
            html += `<td class="col-actions">
                    <button class="cart-btn ${inCart ? 'in-cart' : ''}"
                            title="${inCart ? '–£–±—Ä–∞—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É'}"
                            onclick="toggleCart('${item.barcode}')">
                        ${inCart ? '‚úì' : 'üõí'}
                    </button>
                </td>`;

            html += `<td class="col-barcode">
                    <div class="barcode-cell">
                        <span class="barcode-text" title="${item.barcode}">${item.barcode}</span>
                        <button class="copy-btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥"
                                onclick="copyBarcode('${item.barcode}', this)">üìã</button>
                    </div>
                </td>`;

            // –Ø—á–µ–π–∫–∏ —Å –®–ö –ø–æ —Ñ–∞–π–ª–∞–º
            allFilesData.forEach(({fileName}, idx) => {
                const extraClass = showFileBarcodes ? '' : 'hidden-barcode-col';
                const origBarcode = item.originalBarcodesByFile.get(fileName) || '‚Äî';
                html += `<td class="col-barcode file-barcode-col ${extraClass}" data-file-index="${idx}">
                        <div class="barcode-cell">
                            <span class="barcode-text" title="${origBarcode}">${origBarcode}</span>
                            ${origBarcode !== '‚Äî' ? `<button class="copy-btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥" onclick="copyBarcode('${origBarcode}', this)">üìã</button>` : ''}
                        </div>
                    </td>`;
            });

            if (compactMatches && item.names.length > 1) {
                const text = item.names.map(n => n.name).join(' | ');
                html += `<td class="col-name">
                        <div class="name-compact" title="${text}">
                            ${text}
                        </div>
                    </td>`;
            } else {
                if (item.names.length > 0) {
                    html+=`<td class="col-name"><div class="name-cell">`;const _nm=new Map();item.names.forEach(n=>{if(!_nm.has(n.name))_nm.set(n.name,n.fileName);});_nm.forEach((fn,name)=>{html+=`<div class="name-item" title="üìÅ ${fn}">${name}</div>`;});html+=`</div></td>`;
                } else {
                    html += `<td class="col-name">–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è</td>`;
                }
            }

            const numericValues=[];

            const supplierVisiblePriceCols=visibleCols.filter(col=>!col.metaType&&col.fileName!==MY_PRICE_FILE_NAME&&isPriceLikeColumn(col.columnName));
            const _gn={"–Ω–∞–ª":[],"–±–Ω":[],"other":[]};supplierVisiblePriceCols.forEach(col=>{const _g=getColPayGroup(col);const valuesArr=item.values.get(col.key);if(valuesArr)valuesArr.forEach(vObj=>{const n=parsePriceNumber(vObj.val);if(n!==null&&n>0){numericValues.push(n);_gn[_g].push(n);}});});
            const _gMin={"–Ω–∞–ª":_gn["–Ω–∞–ª"].length>0?Math.min(..._gn["–Ω–∞–ª"]):null,"–±–Ω":_gn["–±–Ω"].length>0?Math.min(..._gn["–±–Ω"]):null,"other":_gn["other"].length>0?Math.min(..._gn["other"]):null};
            const _gM={"–Ω–∞–ª":_gn["–Ω–∞–ª"].length>1,"–±–Ω":_gn["–±–Ω"].length>1,"other":_gn["other"].length>1};
            const globalMin=numericValues.length>0?Math.min(...numericValues):null;
            const globalMax=numericValues.length>0?Math.max(...numericValues):null;
            const hasMultipleGlobals=numericValues.length>1;

            visibleCols.forEach(col => {
                const valuesArr = item.values.get(col.key);
                let cellContent = '‚Äî';

                if(col.metaType){const _mv=(valuesArr&&valuesArr.length>0)?valuesArr[0].val:"";if(_mv===undefined||_mv===null||String(_mv).trim()===""){cellContent="‚Äî";}else{const _mn=parseFloat(String(_mv).replace(",","."));cellContent=!isNaN(_mn)?String(Math.round(_mn)):String(_mv);}html+=`<td>${cellContent}</td>`;return;}

                if (valuesArr && valuesArr.length > 0) {
                    cellContent = '<div class="multi-value-container">';
                    valuesArr.forEach((vObj, vIndex) => {
                        let displayValue;
                        let isMin = false;
                        let isMax = false;
                        let numValue = null;

                        const parsed = parseFloat(String(vObj.val).replace(/[^0-9.,]/g, '').replace(',', '.'));
                        if(!isNaN(parsed)&&parsed>0){numValue=parsed;displayValue=parsed.toFixed(PRICE_DECIMALS)+" ‚ÇΩ";const _pg=getColPayGroup(col);if(_gM[_pg]&&_gMin[_pg]!==null&&parsed===_gMin[_pg])isMin=true;if(hasMultipleGlobals&&parsed===globalMax&&globalMax>=3*globalMin)isMax=true;}else{displayValue=vObj.val;}

                        const barcodeForCopy = vObj.originalBarcode || item.barcode;
                        const autoBadge = vObj._autoDiv ? `<span class="auto-div-badge" title="–ê–≤—Ç–æ–¥–µ–ª–µ–Ω–∏–µ /${vObj._autoDivFactor || item.packQty}">√∑</span>` : '';
                        let innerHtml = `<span class="price-clickable" onclick="copyBarcodeFromPrice('${barcodeForCopy}')" title="–ö–ª–∏–∫ ‚Üí –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥ ${barcodeForCopy}">${displayValue}</span>${autoBadge}`;
                        
                        if (isMin) {
                            innerHtml = `<span class="price-val is-min price-clickable" onclick="copyBarcodeFromPrice('${barcodeForCopy}')" title="–ö–ª–∏–∫ ‚Üí –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥ ${barcodeForCopy}">${displayValue}</span>${autoBadge}`;
                        }

                        if (isMax && numValue) {
                            innerHtml = `<span class="price-clickable" onclick="copyBarcodeFromPrice('${barcodeForCopy}')" title="–ö–ª–∏–∫ ‚Üí –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥ ${barcodeForCopy}">${displayValue}</span>${autoBadge}
                                <div class="div-wrapper" title="–¶–µ–Ω–∞ —É–∫–∞–∑–∞–Ω–∞ –∑–∞ –±–ª–æ–∫? –†–∞–∑–¥–µ–ª–∏—Ç–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç—É–∫">
                                    <div class="div-icon">√∑</div>
                                    <select class="div-select" onchange="dividePrice('${item.barcode}','${col.key}', ${vIndex}, this.value); this.value='';">
                                        <option value="" disabled selected>√∑</option>
                                        ${Array.from({length: 99}, (_, i) => i + 2).map(n => `<option value="${n}">${n}</option>`).join('')}
                                    </select>
                                </div>`;
                        }

                        cellContent += `<div class="value-variant">${innerHtml}</div>`;
                    });
                    cellContent += '</div>';
                }

                html += `<td>${cellContent}</td>`;
            });

            html += '</tr>';
        });

        html += '</tbody></table></div>';
        tableContainer.innerHTML = html;
    }

    function dividePrice(barcode, colKey, valueIndex, factorStr) {
        const factor = parseFloat(factorStr);
        if (!factor || factor <= 0) return;

        const item = groupedData.find(x => String(x.barcode) === String(barcode));
        if (!item) return;

        const visibleCols = allColumns.filter(col => visibleColumns.has(col.key));
    const priceCols = visibleCols.filter(col => !col.metaType && isPriceLikeColumn(col.columnName));
    const nums = [];
        priceCols.forEach(col => {
            const arr = item.values.get(col.key);
            if (!arr || arr.length === 0) return;
            arr.forEach(v => {
                const n = parsePriceNumber(v.val);
                if (n !== null && n > 0) nums.push(n);
            });
        });
        if (nums.length === 0) return;

        const minValue = Math.min(...nums);
        const threshold = minValue * 3;

        let changed = false;
        priceCols.forEach(col => {
            const arr = item.values.get(col.key);
            if (!arr || arr.length === 0) return;
            arr.forEach(vObj => {
                const n = parsePriceNumber(vObj.val);
                if (n === null || n <= 0) return;
                if (n > threshold) {
                    vObj.val = roundPrice(n / factor);
                    changed = true;
                }
            });
        });

        if (!changed) return;

        const wrapper = document.querySelector('.table-wrapper');
        const scrollTop = wrapper ? wrapper.scrollTop : 0;
        renderTable();
        const newWrapper = document.querySelector('.table-wrapper');
        if (newWrapper) newWrapper.scrollTop = scrollTop;
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–∏–∞–ª–æ–≥ (Chrome/Edge –∏ –¥—Ä. Chromium), –∏–Ω–∞—á–µ fallback –Ω–∞ FileSaver.js saveAs()
    async function saveBlobWithDialogOrDownload(blob, fileName) {
        // File System Access API (–¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ –º–µ—Å—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
        if (window.showSaveFilePicker) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'Excel (.xlsx)',
                        accept: {
                            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']
                        }
                    }]
                });

                const writable = await handle.createWritable();
                await writable.write(blob);
                await writable.close();
                return; // —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥
            } catch (err) {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –¥–∏–∞–ª–æ–≥ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º –º–æ–ª—á–∞
                if (err && (err.name === 'AbortError' || err.name === 'NotAllowedError')) return;
                // –ò–Ω–∞—á–µ ‚Äî —É–ø–∞–¥—ë–º –≤ –æ–±—ã—á–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
                console.warn('Save picker failed, fallback to download:', err);
            }
        }

        // Fallback: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        await saveBlobWithDialogOrDownload(blob, fileName);
    }


    async function generateExcel(mode) {
    const _exMeta=allColumns.filter(c=>c.metaType&&visibleColumns.has(c.key));
    const _exMyP =allColumns.filter(c=>!c.metaType&&c.fileName===MY_PRICE_FILE_NAME&&visibleColumns.has(c.key));
    const _exSup =allColumns.filter(c=>!c.metaType&&c.fileName!==MY_PRICE_FILE_NAME&&visibleColumns.has(c.key));
    const excelCols=[..._exMeta,..._exMyP,..._exSup];
    const fileNames=allFilesData.map(f=>f.fileName);
    const hasMyPrice=!!myPriceData;
    const myPriceFileName=hasMyPrice?MY_PRICE_FILE_NAME:null;
    const nameFileOrder=[];
    if(hasMyPrice) nameFileOrder.push(myPriceFileName);
    fileNames.forEach(fn=>{if(!hasMyPrice||fn!==myPriceFileName)nameFileOrder.push(fn);});
    const priceStartColBase=1+fileNames.length+nameFileOrder.length;

    // –ñ–∏—Ä–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏: –º–æ–π –ø—Ä–∞–π—Å‚Üí–ø–æ—Å—Ç–∞–≤—â–∏–∫–∏ + –Ω–∞–ª‚Üî–±–Ω
    const thickLeftAt=new Set();
    const _fsi=excelCols.findIndex(c=>!c.metaType&&c.fileName!==MY_PRICE_FILE_NAME);
    if(_fsi>0) thickLeftAt.add(_fsi);
    for(let i=1;i<excelCols.length;i++){
        const p=excelCols[i-1],c=excelCols[i];
        if(!c.metaType&&c.fileName!==MY_PRICE_FILE_NAME&&!p.metaType&&p.fileName!==MY_PRICE_FILE_NAME)
            if(getColPayGroup(p)!==getColPayGroup(c)) thickLeftAt.add(i);
    }

    let dataToExport=[];
    if(mode==='cart')         dataToExport=groupedData.filter(item=>cart.has(item.barcode));
    else if(mode==='myprice') dataToExport=groupedData.filter(item=>item.isInMyPrice).sort((a,b)=>a.myPriceOrder-b.myPriceOrder);
    else                      dataToExport=groupedData;

    const workbook=new ExcelJS.Workbook();
    const worksheet=workbook.addWorksheet('–°—Ä–∞–≤–Ω–µ–Ω–∏–µ');
    const totalCols=1+fileNames.length+nameFileOrder.length+excelCols.length;

    // –ó–∞–≥–æ–ª–æ–≤–∫–∏: –º–æ–π –ø—Ä–∞–π—Å ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–∫–∞, –ø–æ—Å—Ç–∞–≤—â–∏–∫ ‚Äî —Ñ–∞–π–ª+–∫–æ–ª–æ–Ω–∫–∞
    const headers=['–®—Ç—Ä–∏—Ö–∫–æ–¥ (–∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π)'];
    fileNames.forEach(fn=>headers.push(`–®—Ç—Ä–∏—Ö–∫–æ–¥ (${fn})`));
    nameFileOrder.forEach(fn=>headers.push(`–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (${fn})`));
    excelCols.forEach(col=>{
        const _isMyP=!col.metaType&&col.fileName===MY_PRICE_FILE_NAME;
        if(_isMyP||col.metaType){
            headers.push(col.metaType?col.displayName:col.columnName);
        } else {
            headers.push(col.fileName+'\n'+col.columnName);
        }
    });
    const _xlH=worksheet.addRow(headers);
    _xlH.alignment={vertical:'middle',horizontal:'center',wrapText:true};
    _xlH.height=36;

    // –î–∞–Ω–Ω—ã–µ
    dataToExport.forEach(item=>{
        let maxDepth=0;
        excelCols.forEach(col=>{const va=item.values.get(col.key);if(va&&va.length>maxDepth)maxDepth=va.length;});
        if(maxDepth===0)maxDepth=1;
        for(let d=0;d<maxDepth;d++){
            const row=[item.barcode];
            fileNames.forEach(fn=>row.push(item.originalBarcodesByFile.get(fn)||''));
            nameFileOrder.forEach(fn=>row.push((item.namesByFile&&item.namesByFile.get(fn))||''));
            const priceStartCol=row.length;
            const numericColsInRow=[];
            const _eg={'–Ω–∞–ª':[],'–±–Ω':[],'other':[]};
            const _ei={'–Ω–∞–ª':[],'–±–Ω':[],'other':[]};
            excelCols.forEach((col,idx)=>{
                const va=item.values.get(col.key);let cellValue='';
                if(va&&va.length>d){
                    const vObj=va[d];
                    const num=parseFloat(String(vObj.val).replace(/[^0-9.,]/g,'').replace(',','.'));
                    if(!isNaN(num)&&num>0){
                        if(col.metaType){cellValue=Math.round(num);}
                        else{
                            cellValue=roundPrice(num);
                            if(isPriceLikeColumn(col.columnName)){
                                numericColsInRow.push(priceStartCol+idx);
                                if(col.fileName!==MY_PRICE_FILE_NAME){
                                    const _g=getColPayGroup(col);
                                    _eg[_g].push(roundPrice(num));
                                    _ei[_g].push({ci:priceStartCol+idx,vi:_eg[_g].length-1});
                                }
                            }
                        }
                    } else {cellValue=vObj.val;}
                }
                row.push(cellValue);
            });
            const excelRow=worksheet.addRow(row);
            numericColsInRow.forEach(ci=>{const c=excelRow.getCell(ci+1);if(typeof c.value==='number')c.numFmt='0.0';});
            if(item.isSynonym) excelRow.eachCell(cell=>{cell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFE6F7FF'}};});
            else if(item.isDuplicate) excelRow.eachCell(cell=>{cell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFFFE6F0'}};});
            ['–Ω–∞–ª','–±–Ω','other'].forEach(g=>{
                if(_eg[g].length>1){const mn=Math.min(..._eg[g]);_ei[g].forEach(({ci,vi})=>{if(_eg[g][vi]===mn)excelRow.getCell(ci+1).font={color:{argb:'FF28A745'},bold:true};});}
            });
        }
    });

    // –®–∏—Ä–∏–Ω—ã + –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
    const fbS=2,fbE=1+fileNames.length,nsS=fbE+1,nsE=nsS+nameFileOrder.length-1;
    worksheet.columns.forEach((col,idx)=>{
        const ci=idx+1;
        if(ci===1)col.width=15;
        else if(ci>=fbS&&ci<=fbE)col.width=13;
        else if(ci>=nsS&&ci<=nsE)col.width=(hasMyPrice&&nameFileOrder[0]===myPriceFileName&&ci===nsS)?50:20;
        else col.width=10;
    });
    if(fileNames.length>0){worksheet.properties.outlineProperties={summaryBelow:true};for(let c=fbS;c<=fbE;c++){worksheet.getColumn(c).outlineLevel=1;worksheet.getColumn(c).hidden=true;}}
    if(nameFileOrder.length>1){worksheet.properties.outlineProperties={summaryBelow:true};const st=hasMyPrice?nsS+1:nsS;for(let c=st;c<=nsE;c++){worksheet.getColumn(c).outlineLevel=1;worksheet.getColumn(c).hidden=true;}}
    worksheet.views=[{state:'frozen',xSplit:0,ySplit:1}];

    // –ì—Ä–∞–Ω–∏—Ü—ã: —Ç–æ–Ω–∫–∏–µ + –∂–∏—Ä–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ + –∂–∏—Ä–Ω–∞—è –≤–Ω–µ—à–Ω—è—è —Ä–∞–º–∫–∞
    const totalRows=worksheet.rowCount;
    worksheet.eachRow((row,rowNum)=>{
        row.eachCell({includeEmpty:true},(cell,colNum)=>{
            const _eci=colNum-1-priceStartColBase;
            cell.border={
                top:   {style:rowNum===1?'medium':'thin'},
                left:  {style:(colNum===1||(_eci>=0&&thickLeftAt.has(_eci)))?'medium':'thin'},
                bottom:{style:rowNum===totalRows?'medium':'thin'},
                right: {style:colNum===totalCols?'medium':'thin'}
            };
        });
    });

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
    const headerRow=worksheet.getRow(1);
    headerRow.font={bold:true};
    headerRow.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFE0E0E0'}};
    headerRow.alignment={vertical:'middle',horizontal:'center',wrapText:true};
    headerRow.height=36;
    // –ú–æ–π –ø—Ä–∞–π—Å –∫–æ–ª–æ–Ω–∫–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ ‚Äî –∑–µ–ª—ë–Ω—ã–π —Ü–≤–µ—Ç
    excelCols.forEach((col,idx)=>{
        if(!col.metaType&&col.fileName===MY_PRICE_FILE_NAME){
            const cell=headerRow.getCell(priceStartColBase+idx+1);
            cell.font={bold:true,color:{argb:'FF28A745'}};
        }
    });
    if(fbS<=headers.length)headerRow.getCell(fbS).note='–®—Ç—Ä–∏—Ö–∫–æ–¥—ã –ø–æ —Ñ–∞–π–ª–∞–º';
    if(nsS<=headers.length)headerRow.getCell(nsS).note='–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –ø–æ —Ñ–∞–π–ª–∞–º';

    const buffer=await workbook.xlsx.writeBuffer();
    const now=new Date(),yyyy=now.getFullYear(),mm=String(now.getMonth()+1).padStart(2,'0'),dd=String(now.getDate()).padStart(2,'0');
    let fileName=`monitoring-${yyyy}-${mm}-${dd}.xlsx`;
    if(mode==='cart')    fileName=`monitoring-cart-${yyyy}-${mm}-${dd}.xlsx`;
    if(mode==='myprice') fileName=`monitoring-myprice-${yyyy}-${mm}-${dd}.xlsx`;
    const blob=new Blob([buffer],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    await saveBlobWithDialogOrDownload(blob,fileName);
}


    function updateUI() {
        const hasData = groupedData.length > 0;
        const hasMyPrice = myPriceData !== null;

        sortPayBtn.disabled=!hasData;
        exportAllBtn.disabled = !hasData;
        exportMyPriceBtn.disabled = !hasMyPrice || !hasData;
        clearBtn.disabled = !hasData;
        sortMatchesBtn.disabled = !hasData;
        bigDiffBtn.disabled = !hasData;
        showMyPriceBtn.disabled = !hasMyPrice || !hasData;
        compactMatchesBtn.disabled = !hasData;
        maxCoverageBtn.disabled = !hasData;
        toggleFileBarcodesBtn.disabled = !hasData;
        searchInput.disabled = !hasData;

        if (hasData) {
            infoPanel.style.display='grid';
            const _lp=document.getElementById('legendPanel');if(_lp)_lp.style.display='flex';
            const matchCount = groupedData.filter(item => item.originalFileCount > 1).length;
            document.getElementById('productCount').textContent = groupedData.length;
            document.getElementById('fileCount').textContent = allFilesData.length;
            document.getElementById('columnCount').textContent = allColumns.length;
            document.getElementById('matchCount').textContent = matchCount;
        } else {
            infoPanel.style.display='none';
            const _lp2=document.getElementById('legendPanel');if(_lp2)_lp2.style.display='none';
        }
    }

    function clearAll() {
        myPriceData = null;
        competitorFilesData = [];
        allFilesData = [];
        groupedData = [];
        allColumns = [];
        visibleColumns.clear();
        cart.clear();
        barcodeColumn = null;
        nameColumn = null;
        sortMode = 'default';
        compactMatches = false;
        searchQuery = '';
        barcodeSortOrder = 0;
        showFileBarcodes = false;

        myPriceInput.value = '';
        competitorInput.value = '';
        synonymsInput.value = '';
        resetBarcodeAliases();
        searchInput.value = '';
        sortPayBtn.classList.remove('active');
        sortMatchesBtn.classList.remove('active');
        bigDiffBtn.classList.remove('active');
        showMyPriceBtn.classList.remove('active');
        showCartBtn.classList.remove('active');
        compactMatchesBtn.classList.remove('active');
        maxCoverageBtn.classList.remove('active');
        toggleFileBarcodesBtn.classList.remove('active');
        hiddenColumnsPanel.style.display = 'none';
        updateCartUI();

        tableContainer.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç—ã</h3>
                <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à –ø—Ä–∞–π—Å –∏ —Ñ–∞–π–ª—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</p>
            </div>`;
        updateUI();
    }

    function applySortByPayment(){const _m=allColumns.filter(c=>c.metaType);const _p=allColumns.filter(c=>!c.metaType&&c.fileName===MY_PRICE_FILE_NAME);const _s=allColumns.filter(c=>!c.metaType&&c.fileName!==MY_PRICE_FILE_NAME);_s.sort((a,b)=>{const o={"–Ω–∞–ª":0,"–±–Ω":1,"other":2};return(o[getColPayGroup(a)]??2)-(o[getColPayGroup(b)]??2);});allColumns=[..._m,..._p,..._s];const _w=document.querySelector(".table-wrapper"),_st=_w?_w.scrollTop:0;updateHiddenColumnsPanel();renderTable();const _w2=document.querySelector(".table-wrapper");if(_w2)_w2.scrollTop=_st;sortPayBtn.classList.add("active");setTimeout(()=>sortPayBtn.classList.remove("active"),1200);}
    function downloadCurrentSynonyms(){const g={};barcodeAliasMap.forEach((c,a)=>{if(!g[c])g[c]=[];if(a!==c)g[c].push(a);});const blob=new Blob([JSON.stringify(g,null,2)],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement("a"),now=new Date();a.href=url;a.download=`synonyms_${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}.json`;a.click();URL.revokeObjectURL(url);}
    window.toggleColumn = toggleColumn;
    window.toggleCart = toggleCart;
    window.copyBarcode = copyBarcode;
    window.copyBarcodeFromPrice = copyBarcodeFromPrice;
    window.toggleBarcodeSort = toggleBarcodeSort;
    window.dividePrice = dividePrice;
    window.editColumnName = editColumnName;
</script>
<script>
(function(){
  const href = location.href;
  document.querySelectorAll('.global-nav__link').forEach(a => {
    const m = a.getAttribute('data-match') || '';
    if (m && href.includes(m)) a.classList.add('is-active');
    // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –¥–æ–º+–ø—É—Ç—å —Ü–µ–ª–∏–∫–æ–º
    if (!m && href.startsWith(a.href)) a.classList.add('is-active');
  });
})();
</script>

</body>
</html>
